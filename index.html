<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>MLS Dome Ball Scoresheet</title>
<!-- Version: 2.0 - Dynamic Team Names in Outs Section - Feb 4, 2026 -->

<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="manifest" href="site.webmanifest">

<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-base:      #080d14;
    --bg-card:      #0d1520;
    --bg-raise:     #111c2c;
    --bg-hover:     #162234;
    --border:       #1e2f45;
    --border-lite:  #253648;
    --gold:         #f59e0b;
    --gold-dim:     #92610a;
    --gold-glow:    rgba(245,158,11,0.18);
    --green:        #22c55e;
    --green-dim:    #166534;
    --green-glow:   rgba(34,197,94,0.15);
    --blue:         #3b82f6;
    --blue-dim:     #1e40af;
    --blue-glow:    rgba(59,130,246,0.15);
    --red:          #ef4444;
    --red-dim:      #7f1d1d;
    --text-hi:      #f0f6ff;
    --text-md:      #94a3b8;
    --text-lo:      #3d5166;
    --radius-sm:    6px;
    --radius-md:    10px;
    --radius-lg:    14px;
    --shadow-card:  0 4px 24px rgba(0,0,0,0.5);
    --shadow-glow:  0 0 20px rgba(245,158,11,0.12);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    background: var(--bg-base);
    background-image:
      radial-gradient(ellipse 80% 40% at 50% -10%, rgba(245,158,11,0.06) 0%, transparent 70%),
      repeating-linear-gradient(0deg, transparent, transparent 39px, rgba(255,255,255,0.015) 39px, rgba(255,255,255,0.015) 40px),
      repeating-linear-gradient(90deg, transparent, transparent 39px, rgba(255,255,255,0.015) 39px, rgba(255,255,255,0.015) 40px);
    color: var(--text-hi);
    font-family: 'Barlow', sans-serif;
    padding: 16px 10px 32px;
    min-height: 100vh;
    user-select: none;
    -webkit-user-select: none;
  }

  /* Desktop centering wrapper */
  .app-container {
    max-width: 920px;
    margin: 0 auto;
  }

  /* HEADER */
  .header {
    text-align: center;
    margin-bottom: 16px;
    padding: 16px 0 12px;
    position: relative;
  }
  .header::after {
    content: '';
    display: block;
    width: 120px;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
    margin: 10px auto 0;
  }
  .header h1 {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 26px;
    font-weight: 900;
    letter-spacing: 4px;
    color: var(--gold);
    text-transform: uppercase;
    text-shadow: 0 0 30px rgba(245,158,11,0.4);
  }
  .header .sub {
    font-size: 10px;
    color: var(--text-lo);
    margin-top: 4px;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  /* TEAM INFO */
  .team-info { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; justify-content: center; }
  .team-info input {
    flex: 1 1 120px; max-width: 180px;
    background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm);
    color: var(--text-hi); padding: 7px 12px; font-family: 'Barlow', sans-serif; font-size: 13px; font-weight: 500; outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .team-info input:focus { border-color: var(--gold); box-shadow: 0 0 0 3px var(--gold-glow); }
  .team-info input[type="date"] { color-scheme: dark; max-width: 160px; }

  /* HR TRACKER */
  .hr-tracker { display: flex; justify-content: center; margin-bottom: 14px; gap: 12px; flex-wrap: wrap; }
  .hr-box {
    background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-raise) 100%);
    border: 1px solid var(--gold-dim);
    border-radius: var(--radius-md);
    padding: 10px 18px;
    min-width: 220px;
    box-shadow: var(--shadow-glow), inset 0 1px 0 rgba(245,158,11,0.08);
  }
  .hr-box-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 10px; color: var(--gold); margin-bottom: 8px;
    text-transform: uppercase; letter-spacing: 1.5px; text-align: center; font-weight: 700;
  }
  .hr-teams-row { display: flex; gap: 16px; justify-content: center; margin-bottom: 6px; }
  .hr-team { display: flex; align-items: center; gap: 8px; }
  .hr-team-label { font-size: 11px; color: var(--text-md); font-weight: 700; min-width: 40px; letter-spacing: 0.5px; }
  .hr-team-label.opp { color: #60a5fa; }
  .hr-count-display { font-family: 'Barlow Condensed', sans-serif; font-size: 26px; font-weight: 900; color: var(--gold); min-width: 32px; text-align: center; line-height: 1; }
  .hr-count-display.opp { color: #60a5fa; }
  .hr-btn-group { display: flex; gap: 4px; }
  .hr-btn {
    background: var(--bg-raise); border: 1px solid var(--border-lite); border-radius: var(--radius-sm);
    color: var(--gold); font-size: 14px; cursor: pointer; padding: 2px 9px;
    font-family: 'Barlow Condensed', sans-serif; font-weight: 700; transition: all 0.15s;
    min-width: 30px;
  }
  .hr-btn:hover { background: var(--gold); color: var(--bg-base); border-color: var(--gold); box-shadow: 0 0 10px var(--gold-glow); }
  .hr-btn.opp { color: #60a5fa; }
  .hr-btn.opp:hover { background: #60a5fa; color: var(--bg-base); border-color: #60a5fa; }
  .hr-status { font-size: 10px; color: var(--text-lo); text-align: center; line-height: 1.4; margin-top: 5px; letter-spacing: 0.3px; }
  .hr-status.can-advance { color: var(--green); font-weight: 700; }
  .hr-status.need-more { color: var(--gold); font-weight: 700; }

  /* QUICK STATS SUMMARY */
  .stats-summary {
    background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-raise) 100%);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 14px 18px;
    margin-bottom: 14px;
    box-shadow: var(--shadow-card);
  }
  .stats-summary-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px; color: var(--text-lo); text-transform: uppercase;
    letter-spacing: 1.5px; margin-bottom: 12px; text-align: center; font-weight: 700;
  }
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; }
  .stat-item { display: flex; flex-direction: column; align-items: center; gap: 3px; }
  .stat-label { font-size: 9px; color: var(--text-lo); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
  .stat-value { font-family: 'Barlow Condensed', sans-serif; font-size: 22px; font-weight: 900; color: var(--gold); }
  .stat-value.bbc { color: var(--gold); }
  .stat-value.opp { color: #60a5fa; }
  .stat-comparison { display: flex; justify-content: space-around; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
  .stat-team { display: flex; flex-direction: column; align-items: center; gap: 4px; flex: 1; }
  .stat-team-name { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; color: var(--text-md); font-weight: 800; letter-spacing: 0.5px; }
  .stat-team-name.opp { color: #60a5fa; }
  .stat-row { display: flex; gap: 8px; font-size: 11px; color: var(--text-hi); }
  .stat-row-label { color: var(--text-lo); min-width: 35px; font-weight: 600; }
  .stat-row-value { font-weight: 700; min-width: 25px; text-align: right; color: var(--gold); }

  /* SCOREBOARD */
  .scoreboard { display: flex; justify-content: center; margin-bottom: 14px; }
  .scoreboard-inner {
    background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-raise) 100%);
    border-radius: var(--radius-md); padding: 10px 14px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-card);
  }
  .sb-row { display: flex; align-items: center; }
  .sb-label { width: 100px; font-size: 12px; color: var(--text-md); border-right: 1px solid var(--border); padding-right: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 700; }
  .sb-label.header-label { color: var(--text-lo); font-size: 10px; font-weight: 500; letter-spacing: 0.5px; }
  .sb-label.opp { color: #60a5fa; }
  .sb-cell { width: 30px; text-align: center; font-size: 11px; color: var(--text-lo); border-right: 1px solid var(--border); }
  .sb-cell:last-of-type { border-right: none; }
  .sb-cell.val { font-size: 13px; color: var(--text-hi); font-weight: 700; }
  .sb-total { width: 40px; text-align: center; font-size: 11px; color: var(--gold); font-weight: 700; border-left: 1px solid var(--border); }
  .sb-total.val { font-family: 'Barlow Condensed', sans-serif; font-size: 18px; font-weight: 900; }
  .sb-row + .sb-row { margin-top: 5px; padding-top: 5px; border-top: 1px solid var(--border); }

  /* Opponent inning +/- */
  .opp-cell { width: 30px; text-align: center; border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; gap: 1px; }
  .opp-cell:last-of-type { border-right: none; }
  .opp-btn { background: none; border: none; color: #60a5fa; font-size: 10px; cursor: pointer; padding: 0; line-height: 1; font-family: inherit; transition: color 0.15s; }
  .opp-btn:hover { color: #93c5fd; }
  .opp-val { font-family: 'Barlow Condensed', sans-serif; font-size: 14px; color: #60a5fa; font-weight: 800; line-height: 1.3; }
  .opp-total { width: 40px; text-align: center; border-left: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; }
  .opp-total .opp-val { font-size: 18px; font-weight: 900; }

  /* OUTS CONTROLS */
  .outs-row { display: flex; justify-content: center; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
  .inn-ctrl {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm);
    padding: 5px 7px; display: flex; flex-direction: column; align-items: center; gap: 3px; min-width: 50px;
    transition: border-color 0.2s;
  }
  .inn-ctrl:hover { border-color: var(--border-lite); }
  .inn-ctrl .label { font-size: 9px; color: var(--text-lo); letter-spacing: 0.5px; font-weight: 600; text-transform: uppercase; }
  .ctrl-row { display: flex; align-items: center; gap: 2px; }
  .ctrl-btn { background: none; border: none; font-size: 13px; cursor: pointer; padding: 0 3px; line-height: 1; font-family: inherit; color: var(--red); transition: color 0.15s; }
  .ctrl-btn:hover { color: #f87171; }
  .ctrl-val { font-family: 'Barlow Condensed', sans-serif; font-size: 15px; font-weight: 800; min-width: 14px; text-align: center; color: var(--red); }

  /* GRID */
  .grid-wrap { overflow-x: auto; margin-bottom: 14px; border-radius: var(--radius-md); }
  .grid { display: grid; gap: 3px; min-width: 560px; }
  .grid-header { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; color: var(--text-lo); display: flex; align-items: center; padding-left: 4px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; }
  .grid-header.center { justify-content: center; padding-left: 0; text-align: center; }
  .player-num { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; color: var(--text-lo); display: flex; align-items: center; justify-content: center; font-weight: 700; }
  .name-input {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm);
    color: var(--text-hi); padding: 5px 7px; font-family: 'Barlow', sans-serif; font-size: 12px; font-weight: 500; outline: none; width: 100%;
    transition: border-color 0.2s;
  }
  .name-input:focus { border-color: var(--gold); }

  /* CELL */
  .cell {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm);
    padding: 3px; display: flex; flex-direction: column; align-items: center;
    justify-content: center; min-height: 85px; position: relative;
    transition: all 0.18s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .grid > div:nth-child(even) .cell { background: var(--bg-raise); }

  .cell:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.4), 0 0 0 1px var(--blue);
    border-color: var(--blue);
    z-index: 5;
  }
  .cell:active { transform: translateY(0); box-shadow: none; }

  .current-inning-highlight {
    box-shadow: 0 0 0 2px var(--green), 0 0 16px var(--green-glow) !important;
    border-color: var(--green) !important;
    background: rgba(34,197,94,0.07) !important;
  }

  .cell-btns { display: flex; gap: 2px; flex-wrap: wrap; justify-content: center; }
  .cell-btn {
    border-radius: 4px; font-size: 9px; padding: 4px 7px;
    cursor: pointer; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; border: 1px solid;
    transition: all 0.15s ease; min-width: 32px; min-height: 24px; letter-spacing: 0.3px;
  }
  .cell-btn:hover { transform: scale(1.07); }
  .cell-btn:active { transform: scale(0.95); }
  .cell-btn.out { background: rgba(127,29,29,0.4); color: #ef4444; border-color: rgba(127,29,29,0.8); }
  .cell-btn.out:hover { background: rgba(239,68,68,0.2); border-color: #ef4444; }
  .cell-btn.hit { background: rgba(22,101,52,0.4); color: #22c55e; border-color: rgba(22,101,52,0.8); }
  .cell-btn.hit:hover { background: rgba(34,197,94,0.2); border-color: #22c55e; }
  .cell-btn.oth { background: rgba(30,64,175,0.4); color: #60a5fa; border-color: rgba(30,64,175,0.8); }
  .cell-btn.oth:hover { background: rgba(96,165,250,0.2); border-color: #60a5fa; }
  .cell-result { font-family: 'Barlow Condensed', sans-serif; font-size: 14px; font-weight: 900; text-align: center; line-height: 1.1; letter-spacing: 0.5px; }
  .cell-clear {
    position: absolute; top: 2px; left: 3px; font-size: 9px; color: var(--text-lo);
    background: none; border: none; cursor: pointer; padding: 0; line-height: 1; transition: color 0.15s;
  }
  .cell-clear:hover { color: var(--red); }
  .cell-run-btn {
    position: absolute; top: 2px; right: 2px;
    width: 16px; height: 16px; border-radius: 50%; border: 1px solid var(--border-lite);
    background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center;
    font-size: 8px; color: #fff; font-weight: 800; font-family: inherit; transition: all 0.15s;
  }
  .cell-run-btn.scored { background: var(--green); border-color: var(--green); box-shadow: 0 0 8px var(--green-glow); }
  .cell-bases-btn {
    position: absolute; bottom: 2px; right: 3px; font-size: 7px; color: var(--text-lo);
    background: none; border: none; cursor: pointer; padding: 0; font-family: inherit; transition: color 0.15s;
  }
  .cell-bases-btn:hover { color: var(--text-md); }
  .stats-col { font-family: 'Barlow Condensed', sans-serif; font-size: 12px; color: var(--text-md); display: flex; align-items: center; justify-content: center; text-align: center; font-weight: 700; }

  /* ADD / DELETE PLAYER */
  .add-player-btn {
    background: var(--bg-card); border: 1px dashed var(--border-lite); border-radius: var(--radius-sm);
    color: #60a5fa; padding: 6px 20px; font-family: 'Barlow', sans-serif; font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all 0.15s;
  }
  .add-player-btn:hover { background: var(--bg-raise); border-color: #60a5fa; border-style: solid; }
  .del-player-btn {
    background: none; border: none; color: var(--text-lo); font-size: 14px;
    cursor: pointer; font-family: inherit; line-height: 1; padding: 2px 0; transition: color 0.15s;
  }
  .del-player-btn:hover { color: var(--red); }

  /* ROSTER MODAL ROWS */
  .roster-row {
    display: flex; align-items: center; gap: 6px; margin-bottom: 6px;
    background: var(--bg-raise); border: 1px solid var(--border); border-radius: var(--radius-sm);
    padding: 5px 8px; cursor: default; user-select: none; -webkit-user-select: none;
    transition: background 0.15s;
  }
  .roster-row:active { background: var(--bg-hover); }
  .roster-grip { color: var(--border-lite); font-size: 15px; cursor: grab; padding: 0 2px; user-select: none; -webkit-user-select: none; }
  .roster-grip:active { cursor: grabbing; }
  .roster-arrow-btn {
    background: var(--border); border: none; color: var(--text-hi); border-radius: 4px;
    width: 28px; height: 28px; font-size: 13px; cursor: pointer;
    font-family: inherit; display: flex; align-items: center; justify-content: center; transition: all 0.15s;
  }
  .roster-arrow-btn:hover { background: var(--gold); color: var(--bg-base); }

  /* DIAMOND */
  .diamond-svg { width: 36px; height: 36px; display: block; margin: 2px auto 0; }
  .base-circle { transition: all 0.2s ease; }
  .base-circle:hover { filter: brightness(1.4); transform: scale(1.12); }
  .base-circle:active { transform: scale(0.95); }

  /* LEGEND */
  .legend { display: flex; flex-wrap: wrap; gap: 6px 18px; justify-content: center; margin-top: 8px; margin-bottom: 14px; padding: 10px 0; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
  .legend-item { display: flex; align-items: center; gap: 5px; }
  .legend-dot { width: 8px; height: 8px; border-radius: 2px; }
  .legend-label { font-size: 10px; color: var(--text-lo); font-weight: 600; letter-spacing: 0.3px; }

  /* BUTTONS */
  .btn-row {
    text-align: center; display: flex; justify-content: center;
    gap: 6px; flex-wrap: wrap;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 10px 12px;
  }
  .btn { border: none; border-radius: var(--radius-sm); padding: 7px 16px; font-family: 'Barlow', sans-serif; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.15s; letter-spacing: 0.3px; }
  .btn:hover { filter: brightness(1.15); transform: translateY(-1px); }
  .btn:active { transform: translateY(0); filter: brightness(0.95); }
  .btn.new-game { background: rgba(127,29,29,0.6); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); }

  /* MODAL */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.75);
    z-index: 100; display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(6px);
  }
  .modal {
    background: linear-gradient(160deg, #0f1e30 0%, #0a1520 100%);
    backdrop-filter: blur(24px);
    border: 1px solid var(--border-lite);
    border-radius: var(--radius-lg); padding: 24px;
    box-shadow: 0 24px 80px rgba(0,0,0,0.7), 0 0 0 1px rgba(255,255,255,0.04);
    min-width: 240px; max-width: 90vw;
  }
  .modal-title {
    font-family: 'Barlow Condensed', sans-serif;
    color: var(--text-hi); font-weight: 800; margin-bottom: 16px; font-size: 18px; letter-spacing: 0.5px;
  }
  .modal-btn {
    display: block; width: 100%; text-align: left;
    background: var(--bg-raise); color: var(--text-hi); border: 1px solid var(--border); border-radius: var(--radius-sm);
    padding: 11px 16px; margin-bottom: 6px; cursor: pointer; font-family: 'Barlow', sans-serif; font-size: 14px; font-weight: 500;
    transition: all 0.15s;
  }
  .modal-btn:hover { background: var(--bg-hover); border-color: var(--border-lite); }
  .modal-btn:active { background: var(--border); }
  .modal-btn.cancel { background: rgba(30,64,175,0.3); color: #93c5fd; border-color: rgba(59,130,246,0.3); font-size: 13px; margin-top: 4px; }
  .modal-btn.cancel:hover { background: rgba(30,64,175,0.5); }
  .modal-btn.ok { background: var(--gold); color: var(--bg-base); font-weight: 800; flex: 1; border-color: var(--gold); }
  .modal-btn.ok:hover { background: #fbbf24; box-shadow: 0 0 16px var(--gold-glow); }
  .modal-btn.cancel2 { background: var(--bg-raise); color: var(--text-hi); font-weight: 700; flex: 1; border-color: var(--border); }
  .modal-btn-row { display: flex; gap: 8px; margin-top: 16px; }
  .modal-check-label { display: flex; align-items: center; gap: 10px; color: var(--text-hi); margin-bottom: 10px; cursor: pointer; }
  .modal-check-label input { accent-color: var(--gold); width: 18px; height: 18px; cursor: pointer; }
  .modal-check-label span { font-size: 14px; }

  /* RESPONSIVE - PORTRAIT MODE (Phones) */
  @media (max-width: 768px) and (orientation: portrait) {
    body { padding: 8px 4px 20px; }
    .header h1 { font-size: 20px; letter-spacing: 2px; }
    .header .sub { font-size: 9px; }
    .header .sub::after { content: " â€¢ Rotate for best view"; color: var(--text-lo); font-size: 8px; }
    .team-info { flex-direction: column; gap: 6px; }
    .team-info input { max-width: 100%; font-size: 12px; }
    .scoreboard-inner { padding: 6px 8px; }
    .sb-label { width: 80px; font-size: 10px; }
    .sb-cell { width: 25px; font-size: 10px; }
    .sb-total { width: 32px; font-size: 10px; }
    .outs-row { gap: 4px; }
    .inn-ctrl { min-width: 42px; padding: 3px 4px; }
    .inn-ctrl .label { font-size: 8px; }
    .ctrl-val { font-size: 11px; }
    .grid { min-width: auto; gap: 2px; }
    .grid-header { font-size: 9px; }
    .player-num { font-size: 10px; }
    .name-input { font-size: 11px; padding: 3px 5px; }
    .cell { min-height: 75px; padding: 2px; }
    .cell-result { font-size: 12px; }
    .cell-btn { font-size: 8px; padding: 2px 4px; }
    .diamond-svg { width: 30px; height: 30px; }
    .cell-run-btn { width: 14px; height: 14px; font-size: 7px; }
    .cell-bases-btn { font-size: 6px; }
    .cell-clear { font-size: 8px; }
    .stats-col { font-size: 10px; }
    .legend-item { font-size: 9px; }
    .legend-dot { width: 6px; height: 6px; }
    .legend-label { font-size: 9px; }
    .btn { font-size: 11px; padding: 6px 12px; }
  }

  /* RESPONSIVE - LANDSCAPE MODE */
  @media (min-width: 568px) and (max-width: 1024px) and (orientation: landscape) {
    body { padding: 10px 6px 20px; }
    .header h1 { font-size: 22px; }
    .scoreboard-inner { padding: 7px 10px; }
    .cell { min-height: 70px; }
    .diamond-svg { width: 32px; height: 32px; }
  }

  /* RESPONSIVE - LARGE TABLETS */
  @media (min-width: 768px) and (max-width: 1024px) {
    .grid { min-width: 700px; }
    .cell { min-height: 80px; }
  }

  /* RESPONSIVE - VERY SMALL PHONES */
  @media (max-width: 375px) {
    .header h1 { font-size: 17px; }
    .sb-label { width: 70px; font-size: 9px; }
    .sb-cell { width: 22px; font-size: 9px; }
    .cell { min-height: 65px; }
    .cell-btn { font-size: 7px; padding: 1px 3px; }
    .diamond-svg { width: 26px; height: 26px; }
  }

  /* ANIMATIONS */
  @keyframes highlight-pulse {
    0%, 100% { background: transparent; }
    50% { background: var(--gold-glow); }
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>

<div class="app-container">

<div class="header">
  <img src="data:image/png;base64,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AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//2Q==" alt="BBC Logo" style="height: 60px; margin-bottom: 8px;" />
  <h1>MLS Dome Ball Scoresheet</h1>
  <div class="sub">auto-saves between sessions</div>
</div>

<div class="team-info">
  <div style="display: flex; gap: 4px; flex: 1; max-width: 400px;">
    <input type="text" id="input-my-team" placeholder="My Team" oninput="onMyTeamInput(this.value)" style="flex: 1;" />
    <button onclick="openMyTeamSelector()" style="background:var(--green-dim); border:none; border-radius:var(--radius-sm); color:#86efac; padding:6px 11px; cursor:pointer; font-size:13px; font-weight:700; transition:all 0.15s;">â–¼</button>
  </div>
  <div style="display: flex; gap: 4px; flex: 1; max-width: 400px;">
    <input type="text" id="input-opponent" placeholder="vs Opponent" oninput="onOpponentInput(this.value)" style="flex: 1;" />
    <button onclick="openTeamSelector()" style="background:var(--bg-raise); border:none; border-radius:var(--radius-sm); color:var(--text-md); padding:6px 11px; cursor:pointer; font-size:13px; font-weight:700; transition:all 0.15s;">â–¼</button>
  </div>
  <button id="home-away-toggle" onclick="toggleHomeAway()" style="background:var(--gold-glow); border:2px solid var(--gold); border-radius:var(--radius-sm); color:var(--gold); padding:6px 15px; cursor:pointer; font-family:'Barlow Condensed',sans-serif; font-size:15px; font-weight:900; max-width:100px; transition:all 0.15s; letter-spacing:0.5px;">
    AWAY
  </button>
  <select id="input-game-number" onchange="onField('gameNumber', this.value)" style="background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-hi); padding:7px 10px; font-family:'Barlow',sans-serif; font-size:13px; outline:none; cursor:pointer; max-width:100px; transition:border-color 0.2s;">
    <option value="">Game #</option>
    <option value="1">Game 1</option>
    <option value="2">Game 2</option>
    <option value="3">Game 3</option>
  </select>
  <input type="date" id="input-date" oninput="onField('date', this.value)" />
  <select id="input-game-result" onchange="onField('gameResult', this.value)" style="background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-hi); padding:7px 10px; font-family:'Barlow',sans-serif; font-size:13px; outline:none; cursor:pointer; max-width:100px; transition:border-color 0.2s;">
    <option value="">Result</option>
    <option value="W">W (Win)</option>
    <option value="L">L (Loss)</option>
    <option value="T">T (Tie)</option>
  </select>
  <select id="input-hr-limit" onchange="onField('hrLimit', parseInt(this.value))" style="background:var(--bg-card); border:1px solid var(--gold-dim); border-radius:var(--radius-sm); color:var(--gold); padding:7px 10px; font-family:'Barlow',sans-serif; font-size:13px; outline:none; cursor:pointer; max-width:120px; font-weight:700;">
    <option value="2">HR Limit: 2</option>
    <option value="3">HR Limit: 3</option>
    <option value="4">HR Limit: 4</option>
    <option value="5">HR Limit: 5</option>
    <option value="99">HR Limit: âˆž</option>
  </select>
</div>

<!-- TEAM TRACKING TOGGLE -->
<div style="text-align: center; margin-bottom: 12px;">
  <div style="display:inline-flex; background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-md); padding:4px; gap:4px; box-shadow:var(--shadow-card);">
    <button id="toggle-myteam" onclick="switchTrackingMode('myTeam')" style="padding:8px 24px; border-radius:var(--radius-sm); border:none; cursor:pointer; font-family:'Barlow Condensed',sans-serif; font-size:14px; font-weight:800; letter-spacing:0.5px; transition:all 0.2s; background:var(--green); color:var(--bg-base);">
      <span id="myteam-name">My Team</span>
    </button>
    <button id="toggle-opponent" onclick="switchTrackingMode('opponent')" style="padding:8px 24px; border-radius:var(--radius-sm); border:none; cursor:pointer; font-family:'Barlow Condensed',sans-serif; font-size:14px; font-weight:800; letter-spacing:0.5px; transition:all 0.2s; background:transparent; color:var(--text-lo);">
      <span id="opponent-name">Opponent</span>
    </button>
  </div>
  <div id="tracking-indicator" style="font-size:11px; color:var(--text-lo); margin-top:7px; letter-spacing:0.5px; text-transform:uppercase; font-weight:600;">Recording: <span style="color:var(--green); font-weight:800;">My Team</span></div>
  <!-- Opponent roster button - only visible in opponent mode -->
  <div id="opp-roster-bar" style="display:none; margin-top:8px; gap:8px; justify-content:center; flex-wrap:wrap;">
    <button onclick="openOppRosterModal()" style="background:rgba(30,64,175,0.4); color:#93c5fd; border:1px solid rgba(59,130,246,0.5); border-radius:var(--radius-sm); padding:7px 16px; font-size:12px; font-weight:700; cursor:pointer; font-family:'Barlow',sans-serif; transition:all 0.15s;">
      ðŸ‘¥ Set Opponent Lineup
    </button>
    <button onclick="quickNumberLineup()" style="background:var(--bg-raise); color:var(--text-md); border:1px solid var(--border-lite); border-radius:var(--radius-sm); padding:7px 16px; font-size:12px; font-weight:700; cursor:pointer; font-family:'Barlow',sans-serif; transition:all 0.15s;">
      ðŸ”¢ Quick #1-12
    </button>
  </div>
</div>

<!-- HR TRACKER -->
<div class="hr-tracker">
  <div class="hr-box">
    <div class="hr-box-title">âš¾ Home Run Limit Tracker</div>
    <div class="hr-teams-row">
      <div class="hr-team">
        <span class="hr-team-label" id="hr-my-team-label">BBC:</span>
        <div class="hr-btn-group">
          <button class="hr-btn" onclick="changeHR('bbc', -1)">âˆ’</button>
          <span class="hr-count-display" id="bbc-hr-count">0</span>
          <button class="hr-btn" onclick="changeHR('bbc', 1)">+</button>
        </div>
      </div>
      <div class="hr-team">
        <span class="hr-team-label opp" id="hr-opp-team-label">OPP:</span>
        <div class="hr-btn-group">
          <button class="hr-btn opp" onclick="changeHR('opp', -1)">âˆ’</button>
          <span class="hr-count-display opp" id="opp-hr-count">0</span>
          <button class="hr-btn opp" onclick="changeHR('opp', 1)">+</button>
        </div>
      </div>
    </div>
    <div class="hr-status" id="hr-status">Both teams need 2 HR to advance</div>
  </div>
</div>

<div class="scoreboard" id="scoreboard"></div>
<div class="outs-row" id="outs-row"></div>
<div class="grid-wrap"><div class="grid" id="player-grid"></div></div>

<!-- QUICK STATS SUMMARY -->
<div class="stats-summary" id="stats-summary">
  <div class="stats-summary-title">ðŸ“Š GAME STATISTICS</div>
  <div class="stats-grid">
    <div class="stat-item">
      <span class="stat-label">Team AVG</span>
      <span class="stat-value bbc" id="stat-team-avg">.000</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Total Hits</span>
      <span class="stat-value bbc" id="stat-total-hits">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Total Runs</span>
      <span class="stat-value bbc" id="stat-total-runs">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">RBIs</span>
      <span class="stat-value bbc" id="stat-total-rbis">0</span>
    </div>
  </div>
  <div class="stat-comparison">
    <div class="stat-team">
      <div class="stat-team-name">BBC</div>
      <div class="stat-row">
        <span class="stat-row-label">Runs:</span>
        <span class="stat-row-value" id="stat-bbc-runs">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-row-label">HRs:</span>
        <span class="stat-row-value" id="stat-bbc-hrs">0</span>
      </div>
    </div>
    <div class="stat-team">
      <div class="stat-team-name opp" id="stat-opp-name">OPP</div>
      <div class="stat-row">
        <span class="stat-row-label">Runs:</span>
        <span class="stat-row-value" id="stat-opp-runs">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-row-label">HRs:</span>
        <span class="stat-row-value" id="stat-opp-hrs">0</span>
      </div>
    </div>
  </div>
</div>

<div style="text-align:center; margin-bottom:8px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
  <button class="add-player-btn" onclick="addPlayer()">+ Add Player</button>
  <button class="add-player-btn" onclick="openRosterModal()" style="border-style:solid; border-color:var(--gold-dim); color:var(--gold);">ðŸ“‹ Roster</button>
  <button class="add-player-btn" onclick="openLineupManager()" style="border-style:solid; border-color:var(--green-dim); color:var(--green);">ðŸ‘¥ Lineups</button>
</div>

<div class="legend">
  <div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div><span class="legend-label">OUT</span></div>
  <div class="legend-item"><div class="legend-dot" style="background:#dc2626"></div><span class="legend-label">DP/TP (Double/Triple Play)</span></div>
  <div class="legend-item"><div class="legend-dot" style="background:#22c55e"></div><span class="legend-label">HIT</span></div>
  <div class="legend-item"><div class="legend-dot" style="background:#60a5fa"></div><span class="legend-label">WALK</span></div>
  <div class="legend-item"><div class="legend-dot" style="background:#eab308"></div><span class="legend-label">FC (Fielder's Choice)</span></div>
  <div class="legend-item"><div class="legend-dot" style="background:#a78bfa"></div><span class="legend-label">SAC</span></div>
  <div class="legend-item"><div class="legend-dot" style="background:#f97316"></div><span class="legend-label">ROE (Reach on Error)</span></div>
</div>

<div class="btn-row">
  <button class="btn new-game" onclick="newGame()" style="background:rgba(127,29,29,0.5); color:#fca5a5; border:1px solid rgba(239,68,68,0.3);">New Game</button>
  <button class="btn new-game" onclick="undo()" style="background:var(--gold); color:var(--bg-base);">â†¶ Undo</button>
  <button class="btn new-game" onclick="openSprayChartMenu()" style="background:rgba(139,92,246,0.4); color:#c4b5fd; border:1px solid rgba(139,92,246,0.5);">ðŸ“ Spray Chart â–¼</button>
  <button class="btn new-game" onclick="addInning()" style="background:rgba(5,150,105,0.4); color:#6ee7b7; border:1px solid rgba(5,150,105,0.5);">+ Add Inning</button>
  <button class="btn new-game" onclick="removeInning()" style="background:rgba(220,38,38,0.3); color:#fca5a5; border:1px solid rgba(220,38,38,0.4);">âˆ’ Remove Inning</button>
  <button class="btn new-game" onclick="exportPDF()" style="background:rgba(30,64,175,0.5); color:#93c5fd; border:1px solid rgba(59,130,246,0.4);">Save PDF</button>
  <button class="btn new-game" onclick="exportExcel()" style="background:rgba(22,163,74,0.4); color:#86efac; border:1px solid rgba(34,197,94,0.4);">ðŸ“Š Export Excel</button>
  <button class="btn new-game" onclick="viewSeasonStats()" style="background:rgba(8,145,178,0.4); color:#67e8f9; border:1px solid rgba(6,182,212,0.4);">ðŸ‘€ Season Stats</button>
  <button class="btn new-game" onclick="updateSeasonStats()" style="background:rgba(124,58,237,0.4); color:#c4b5fd; border:1px solid rgba(167,139,250,0.4);">ðŸ“ˆ Update Season</button>
  <button class="btn new-game" onclick="resetSeasonStats()" style="background:rgba(127,29,29,0.3); color:#fca5a5; border:1px solid rgba(220,38,38,0.3); font-size:11px;">ðŸ—‘ï¸ Reset Season</button>
</div>

</div><!-- end app-container -->

<div id="modal-container"></div>

<script>
let INNINGS = 7; // Can be modified
const MAX_PLAYERS = 12;
const DEFAULT_NAMES = ["Abby","Ackshan","Sealy","Mills","Ahil","Miloan","Jana","Jessey","Shawn","Jhanan","Lavan","Kevin"];

function emptyPlayer(name) {
  return { 
    name: name || "", 
    innings: Array.from({ length: INNINGS }, () => ({ 
      result: "", 
      bases: [], 
      run: false, 
      rbi: 0,
      basesAdvanced: "", // e.g., "1-3" means advanced from 1st to 3rd
      fcNote: "", // For FC: who got out (e.g., "Runner at 2nd")
      fcRemovedRunner: null, // Which batter row was put out on this FC (null if not FC or no out tracked)
      sacNote: "", // For SAC: who scored (e.g., "Runner at 3rd")
      hitLocation: "", // Where the ball was hit (LF, CF, RF, SS, 2B, 1B, 3B, P, C)
      outLocation: "", // Where the out occurred (1st, 2nd, 3rd, home, running, plate)
      hitQuality: "", // soft, medium, hard
      hitTrajectory: "" // grounder, line-drive, fly-ball, pop-up
    })) 
  };
}

function emptyState() {
  return {
    innings: INNINGS,
    myTeam: "",  // Our team name
    opponent: "",
    date: "",
    gameNumber: "",
    gameResult: "",
    hrLimit: 2,  // Configurable HR limit (default 2)
    isHome: false,  // Are we the home team? (false = away/top, true = home/bottom)
    trackingMode: "myTeam",  // "myTeam" or "opponent" - which team we're currently tracking
    players: DEFAULT_NAMES.map(n => emptyPlayer(n)),
    oppPlayers: DEFAULT_NAMES.map(n => emptyPlayer(n)),  // Opponent roster
    outs: Array.from({ length: INNINGS }, () => 0),
    bbcRuns: Array.from({ length: INNINGS }, () => 0),
    oppRuns: Array.from({ length: INNINGS }, () => 0),
    oppOuts: Array.from({ length: INNINGS }, () => 0),
    bbcHomeRuns: 0,  // Track BBC home runs
    oppHomeRuns: 0,  // Track opponent home runs
    bbcWalks: Array.from({ length: INNINGS }, () => 0),  // Track walks per inning
    fiveRunLimitReached: false,  // Track if 5-run limit message shown for current inning
  };
}

let state = emptyState();
let saveTimer = null;
let undoHistory = []; // Stack to store previous states
const MAX_UNDO_HISTORY = 20; // Keep last 20 actions
let savedMyTeams = ["Backyard Baseball Club"]; // My team names
let savedTeams = ["Dos Diamonds", "Expos", "T-Ball Legends"]; // Opponent teams
let savedRoster = ["Abby","Ackshan","Sealy","Mills","Ahil","Miloan","Jana","Jessey","Shawn","Jhanan","Lavan","Kevin"];
let savedOppRoster = []; // Saved opponent rosters keyed by team name
let savedLineups = []; // Saved lineups (name + player list)

(function load() {
  try {
    const saved = localStorage.getItem("mls-scoresheet-v2");
    if (saved) {
      state = JSON.parse(saved);
      // Migration: add oppOuts if it doesn't exist
      if (!state.oppOuts) {
        state.oppOuts = Array.from({ length: state.innings || INNINGS }, () => 0);
      }
      // Migration: add innings count if missing
      if (!state.innings) {
        state.innings = INNINGS;
      }
      // Sync INNINGS variable with state
      INNINGS = state.innings;
      // NEW: Initialize HR tracking if missing
      if (state.bbcHomeRuns === undefined) state.bbcHomeRuns = 0;
      if (state.oppHomeRuns === undefined) state.oppHomeRuns = 0;
      // NEW: Initialize walks tracking if missing
      if (!state.bbcWalks) {
        state.bbcWalks = Array.from({ length: state.innings || INNINGS }, () => 0);
      }
      // NEW: Initialize HR limit if missing
      if (state.hrLimit === undefined) {
        state.hrLimit = 2; // Default to 2 for old games
      }
    }
    
    const myTeams = localStorage.getItem("mls-saved-my-teams");
    if (myTeams) {
      savedMyTeams = JSON.parse(myTeams);
    } else {
      saveMyTeams();
    }
    
    const teams = localStorage.getItem("mls-saved-teams");
    if (teams) {
      savedTeams = JSON.parse(teams);
    } else {
      saveTeams();
    }

    const roster = localStorage.getItem("mls-saved-roster");
    if (roster) {
      savedRoster = JSON.parse(roster);
    } else {
      saveRoster(); // persist defaults on first load
    }
    
    const lineups = localStorage.getItem("mls-saved-lineups");
    if (lineups) {
      savedLineups = JSON.parse(lineups);
    }
    
    // Initialize myTeam in state if missing
    if (state.myTeam === undefined) {
      state.myTeam = "";
    }
  } catch(e) {}
  render();
  
  // Re-render on orientation change or window resize
  window.addEventListener('orientationchange', () => {
    setTimeout(() => render(), 100);
  });
  
  window.addEventListener('resize', () => {
    clearTimeout(window.resizeTimer);
    window.resizeTimer = setTimeout(() => render(), 200);
  });
})();

function save() {
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    try { localStorage.setItem("mls-scoresheet-v2", JSON.stringify(state)); } catch(e) {}
  }, 500);
}

function saveStateToHistory() {
  // Deep copy the current state before making changes
  const stateCopy = JSON.parse(JSON.stringify(state));
  undoHistory.push(stateCopy);
  
  // Keep history limited to MAX_UNDO_HISTORY items
  if (undoHistory.length > MAX_UNDO_HISTORY) {
    undoHistory.shift(); // Remove oldest entry
  }
}

function undo() {
  if (undoHistory.length === 0) {
    alert("Nothing to undo!");
    return;
  }
  
  // Get the last saved state
  const previousState = undoHistory.pop();
  
  // Restore it
  state = previousState;
  
  // Update INNINGS variable if it changed
  INNINGS = state.innings;
  
  // Re-render everything
  save();
  renderGrid();
  renderScoreboard();
  renderOuts();
  updateHRDisplay();
  updateStatsDisplay();
  
  // Flash a message
  const msg = document.createElement('div');
  msg.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#f59e0b; color:#1e293b; padding:12px 24px; border-radius:8px; font-size:14px; font-weight:700; z-index:10000; box-shadow:0 4px 12px rgba(0,0,0,0.3);';
  msg.textContent = 'â†¶ Undone!';
  document.body.appendChild(msg);
  
  setTimeout(() => {
    msg.remove();
  }, 1500);
  
  console.log(`Undo successful. ${undoHistory.length} actions remaining in history.`);
}


function onField(field, val) {
  state[field] = val;
  save();
  renderScoreboard();
}

function onOpponentInput(val) {
  console.log('Opponent changed to:', val);
  state.opponent = val;
  
  // Update toggle button label
  const oppNameSpan = document.getElementById('opponent-name');
  if (oppNameSpan) oppNameSpan.textContent = val || 'Opponent';
  
  save();
  renderScoreboard();
  renderOuts(); // Update outs section with new opponent name
  updateHRDisplay(); // Update HR tracker labels
  
  // Update tracking indicator if in opponent mode
  if (state.trackingMode === 'opponent') {
    const indicator = document.getElementById('tracking-indicator');
    if (indicator) {
      indicator.innerHTML = `Recording stats for: <span style="color: #60a5fa; font-weight: 700;">${val || 'Opponent'}</span>`;
    }
  }
}

function toggleHomeAway() {
  state.isHome = !state.isHome;
  const btn = document.getElementById('home-away-toggle');
  btn.textContent = state.isHome ? 'HOME' : 'AWAY';
  btn.style.color = state.isHome ? '#22c55e' : '#f59e0b';
  btn.style.borderColor = state.isHome ? '#22c55e' : '#f59e0b';
  save();
  renderOuts(); // Update outs display to show top/bottom
}

function saveMyTeams() {
  try {
    localStorage.setItem("mls-saved-my-teams", JSON.stringify(savedMyTeams));
  } catch(e) {}
}

function saveTeams() {
  try {
    localStorage.setItem("mls-saved-teams", JSON.stringify(savedTeams));
  } catch(e) {}
}

function saveRoster() {
  try {
    localStorage.setItem("mls-saved-roster", JSON.stringify(savedRoster));
  } catch(e) {}
}

// â”€â”€ HR TRACKING â”€â”€
function changeHR(team, delta) {
  if (team === 'bbc') {
    state.bbcHomeRuns = Math.max(0, state.bbcHomeRuns + delta);
  } else {
    state.oppHomeRuns = Math.max(0, state.oppHomeRuns + delta);
  }
  updateHRDisplay();
  updateStatsDisplay(); // Update stats when HRs change
  save();
}

function updateHRDisplay() {
  // Update team labels
  const myTeamName = state.myTeam || 'BBC';
  const oppTeamName = state.opponent || 'OPP';
  
  document.getElementById('hr-my-team-label').textContent = myTeamName + ':';
  document.getElementById('hr-opp-team-label').textContent = oppTeamName + ':';
  
  document.getElementById('bbc-hr-count').textContent = state.bbcHomeRuns;
  document.getElementById('opp-hr-count').textContent = state.oppHomeRuns;
  
  // Update status message based on HR limit rule
  const statusEl = document.getElementById('hr-status');
  const bbcHR = state.bbcHomeRuns;
  const oppHR = state.oppHomeRuns;
  const hrLimit = state.hrLimit || 2; // Default to 2 if not set
  
  if (hrLimit >= 99) {
    // Unlimited HRs
    statusEl.textContent = 'âˆž Unlimited Home Runs';
    statusEl.className = 'hr-status can-advance';
  } else if (bbcHR < hrLimit && oppHR < hrLimit) {
    statusEl.textContent = `Both teams need ${hrLimit} HR to advance`;
    statusEl.className = 'hr-status need-more';
  } else if (bbcHR >= hrLimit && oppHR >= hrLimit) {
    statusEl.textContent = 'Both can advance by 1 HR at a time âœ“';
    statusEl.className = 'hr-status can-advance';
  } else if (bbcHR >= hrLimit) {
    statusEl.textContent = myTeamName + ' can advance âœ“ â€¢ ' + oppTeamName + ' needs ' + (hrLimit - oppHR) + ' more';
    statusEl.className = 'hr-status';
  } else {
    statusEl.textContent = oppTeamName + ' can advance âœ“ â€¢ ' + myTeamName + ' needs ' + (hrLimit - bbcHR) + ' more';
    statusEl.className = 'hr-status';
  }
}

// â”€â”€ STATS SUMMARY â”€â”€
function updateStatsDisplay() {
  // Calculate team totals
  let totalHits = 0;
  let totalAB = 0;
  let totalRuns = 0;
  let totalRBIs = 0;
  
  state.players.forEach(player => {
    const stats = calcStats(player);
    totalHits += stats.H;
    totalAB += stats.AB;
    totalRuns += stats.R;
    totalRBIs += stats.RBI;
  });
  
  const teamAVG = totalAB > 0 ? (totalHits / totalAB).toFixed(3) : '.000';
  
  // Update team stats
  document.getElementById('stat-team-avg').textContent = teamAVG;
  document.getElementById('stat-total-hits').textContent = totalHits;
  document.getElementById('stat-total-runs').textContent = totalRuns;
  document.getElementById('stat-total-rbis').textContent = totalRBIs;
  
  // Update comparison stats
  const bbcRuns = state.bbcRuns.reduce((a,b) => a+b, 0);
  const oppRuns = state.oppRuns.reduce((a,b) => a+b, 0);
  
  document.getElementById('stat-bbc-runs').textContent = bbcRuns;
  document.getElementById('stat-bbc-hrs').textContent = state.bbcHomeRuns;
  document.getElementById('stat-opp-runs').textContent = oppRuns;
  document.getElementById('stat-opp-hrs').textContent = state.oppHomeRuns;
  document.getElementById('stat-opp-name').textContent = state.opponent || 'OPP';
}

// â”€â”€ ROSTER MODAL â”€â”€
function openRosterModal() {
  let rowsHTML = '';
  if (savedRoster.length === 0) {
    rowsHTML = '<div style="color:#64748b; text-align:center; padding:20px; font-size:13px;">No players in roster yet.</div>';
  } else {
    rowsHTML = savedRoster.map((name, idx) =>
      `<div class="roster-row" draggable="true" data-idx="${idx}"
            ondragstart="rosterDragStart(event, ${idx})"
            ondragover="rosterDragOver(event)"
            ondrop="rosterDrop(event, ${idx})"
            ondragend="rosterDragEnd(event)"
            ontouchstart="rosterTouchStart(event, ${idx})"
            ontouchmove="rosterTouchMove(event)"
            ontouchend="rosterTouchEnd(event, ${idx})">
        <span class="roster-grip">â˜°</span>
        <span style="color:#64748b; font-size:12px; min-width:18px; text-align:right;">${idx+1}.</span>
        <input class="roster-name-input" value="${escHtml(name)}" oninput="rosterNameEdit(${idx}, this.value)"
          style="flex:1; background:var(--bg-raise); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-hi); padding:7px 9px; font-family:'Barlow',sans-serif; font-size:13px; outline:none;" />
        <button onclick="moveRosterPlayer(${idx},-1)" class="roster-arrow-btn" title="Move up">â–²</button>
        <button onclick="moveRosterPlayer(${idx},1)"  class="roster-arrow-btn" title="Move down">â–¼</button>
        <button onclick="deleteRosterPlayer(${idx})" style="background:#7f1d1d; color:#fca5a5; border:none; border-radius:4px; padding:6px 10px; cursor:pointer; font-size:13px; font-family:inherit;">âœ•</button>
      </div>`
    ).join('');
  }

  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()" style="max-width:420px;">
        <div class="modal-title">Player Roster</div>
        <div style="color:#cbd5e1; font-size:12px; text-align:center; margin-bottom:10px; padding:8px; background:#1e3a5a; border-radius:6px;">
          <strong>Roster Pool:</strong> All available players<br/>
          <span style="color:#94a3b8; font-size:11px;">Add players here, then select who plays each game</span>
        </div>
        <div style="color:#64748b; font-size:11px; text-align:center; margin-bottom:10px;">Drag â˜° or use â–²â–¼ to reorder</div>
        <div id="roster-list" style="max-height:280px; overflow-y:auto; margin:8px 0;">
          ${rowsHTML}
        </div>
        <button class="modal-btn" onclick="addRosterPlayer()" style="background:#166534; color:#86efac; margin-bottom:8px;">
          âž• Add Player to Roster Pool
        </button>
        <button class="modal-btn" onclick="openLineupSelector()" style="background:#1e40af; color:#93c5fd; margin-bottom:8px;">
          âš¾ Select Today's Lineup (${state.players.length} playing)
        </button>
        <button class="modal-btn cancel" onclick="closeModal()">Close</button>
      </div>
    </div>`;
}

// â”€â”€ drag & drop (desktop) â”€â”€
let rosterDragIdx = null;
function rosterDragStart(e, idx) {
  rosterDragIdx = idx;
  e.currentTarget.style.opacity = '0.4';
  e.dataTransfer.effectAllowed = 'move';
}
function rosterDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  e.currentTarget.style.borderTop = '2px solid #f59e0b';
}
function rosterDrop(e, idx) {
  e.preventDefault();
  e.currentTarget.style.borderTop = '';
  if (rosterDragIdx === null || rosterDragIdx === idx) return;
  const item = savedRoster.splice(rosterDragIdx, 1)[0];
  savedRoster.splice(idx, 0, item);
  saveRoster();
  openRosterModal();
}
function rosterDragEnd(e) {
  e.currentTarget.style.opacity = '1';
  e.currentTarget.style.borderTop = '';
  rosterDragIdx = null;
}

// â”€â”€ touch drag (mobile) â”€â”€
let touchStartIdx = null, touchStartY = 0, touchClone = null;
function rosterTouchStart(e, idx) {
  touchStartIdx = idx;
  touchStartY = e.touches[0].clientY;
  // create a visual clone that follows the finger
  touchClone = e.currentTarget.cloneNode(true);
  touchClone.style.cssText += 'position:fixed;width:90%;left:5%;opacity:0.85;z-index:9999;box-shadow:0 4px 16px rgba(0,0,0,0.4);pointer-events:none;border-radius:6px;';
  touchClone.style.top = (e.touches[0].clientY - 20) + 'px';
  document.body.appendChild(touchClone);
  e.currentTarget.style.opacity = '0.3';
}
function rosterTouchMove(e) {
  if (!touchClone) return;
  e.preventDefault();
  touchClone.style.top = (e.touches[0].clientY - 20) + 'px';
}
function rosterTouchEnd(e, idx) {
  if (touchClone) { touchClone.remove(); touchClone = null; }
  // restore opacity on all rows
  document.querySelectorAll('.roster-row').forEach(r => r.style.opacity = '1');
  if (touchStartIdx === null) return;

  // figure out which row the finger landed on
  const y = e.changedTouches[0].clientY;
  const rows = [...document.querySelectorAll('.roster-row')];
  let dropIdx = touchStartIdx;
  rows.forEach((row, i) => {
    const rect = row.getBoundingClientRect();
    if (y >= rect.top && y <= rect.bottom) dropIdx = i;
  });

  if (dropIdx !== touchStartIdx) {
    const item = savedRoster.splice(touchStartIdx, 1)[0];
    savedRoster.splice(dropIdx, 0, item);
    saveRoster();
    openRosterModal();
  }
  touchStartIdx = null;
}

function rosterNameEdit(idx, val) {
  savedRoster[idx] = val;
  saveRoster();
}

function moveRosterPlayer(idx, dir) {
  const target = idx + dir;
  if (target < 0 || target >= savedRoster.length) return;
  [savedRoster[idx], savedRoster[target]] = [savedRoster[target], savedRoster[idx]];
  saveRoster();
  openRosterModal();
}

function deleteRosterPlayer(idx) {
  savedRoster.splice(idx, 1);
  saveRoster();
  openRosterModal();
}

function addRosterPlayer() {
  savedRoster.push("");
  saveRoster();
  openRosterModal();
  // focus the new empty input at the bottom
  setTimeout(() => {
    const inputs = document.querySelectorAll(".roster-name-input");
    if (inputs.length) inputs[inputs.length - 1].focus();
  }, 50);
}

function loadRosterIntoGame() {
  // Resize players array to match roster, preserving any existing innings data for players that stay
  const newPlayers = savedRoster.map((name, i) => {
    // if there's an existing player in that slot, keep their innings data but update the name
    if (state.players[i]) {
      state.players[i].name = name;
      return state.players[i];
    }
    return emptyPlayer(name);
  });
  state.players = newPlayers;
  save();
  closeModal();
  render();
}

function openLineupSelector() {
  // Show checkboxes for each roster player
  let playersHTML = '';
  
  if (savedRoster.length === 0) {
    playersHTML = '<div style="color:#64748b; text-align:center; padding:20px; font-size:13px;">No players in roster yet.<br/>Add players to the roster first.</div>';
  } else {
    // Get current lineup names
    const currentLineup = state.players.map(p => p.name);
    
    playersHTML = savedRoster.map((name, idx) => {
      const isInLineup = currentLineup.includes(name);
      return `
        <div style="display:flex; align-items:center; gap:10px; padding:8px; background:${isInLineup ? 'rgba(59,130,246,0.15)' : 'var(--bg-raise)'}; border-radius:var(--radius-sm); margin-bottom:6px; border:2px solid ${isInLineup ? 'var(--blue)' : 'var(--border)'};">
          <input type="checkbox" id="lineup-check-${idx}" ${isInLineup ? 'checked' : ''} 
            style="width:18px; height:18px; cursor:pointer;" />
          <label for="lineup-check-${idx}" style="flex:1; color:#f1f5f9; font-size:13px; cursor:pointer;">
            <strong>${escHtml(name)}</strong>
          </label>
          ${isInLineup ? '<span style="color:#60a5fa; font-size:11px;">âœ“ In Lineup</span>' : '<span style="color:#64748b; font-size:11px;">Not playing</span>'}
        </div>
      `;
    }).join('');
  }
  
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()" style="max-width:450px;">
        <div class="modal-title">âš¾ Select Today's Lineup</div>
        <div style="color:#cbd5e1; font-size:12px; text-align:center; margin-bottom:12px; padding:8px; background:#1e3a5a; border-radius:6px;">
          Check players who are playing in today's game
        </div>
        <div style="max-height:350px; overflow-y:auto; margin:12px 0;">
          ${playersHTML}
        </div>
        <div style="display:flex; gap:8px; margin-top:12px;">
          <button class="modal-btn" onclick="applyLineupSelection()" style="flex:1; background:#166534; color:#86efac;">
            âœ“ Apply Lineup
          </button>
          <button class="modal-btn cancel" onclick="openRosterModal()" style="flex:1;">
            â† Back
          </button>
        </div>
      </div>
    </div>`;
}

function applyLineupSelection() {
  // Get all checked players
  const selectedPlayers = [];
  savedRoster.forEach((name, idx) => {
    const checkbox = document.getElementById(`lineup-check-${idx}`);
    if (checkbox && checkbox.checked) {
      selectedPlayers.push(name);
    }
  });
  
  if (selectedPlayers.length === 0) {
    alert("Please select at least one player for the lineup!");
    return;
  }
  
  // Update state.players with selected players
  // Preserve existing data for players who are staying
  const newPlayers = selectedPlayers.map((name, i) => {
    // Check if this player was already in the lineup
    const existingPlayer = state.players.find(p => p.name === name);
    if (existingPlayer) {
      return existingPlayer; // Keep their existing data
    }
    return emptyPlayer(name); // New player
  });
  
  state.players = newPlayers;
  save();
  closeModal();
  render();
  
  // Show confirmation
  const msg = document.createElement('div');
  msg.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#166534; color:#86efac; padding:12px 24px; border-radius:8px; font-size:14px; font-weight:700; z-index:10000; box-shadow:0 4px 12px rgba(0,0,0,0.3);';
  msg.textContent = `âœ“ Lineup set: ${selectedPlayers.length} player${selectedPlayers.length > 1 ? 's' : ''}`;
  document.body.appendChild(msg);
  
  setTimeout(() => {
    msg.remove();
  }, 2000);
}

// â”€â”€ OPPONENT ROSTER FUNCTIONS â”€â”€

function quickNumberLineup() {
  // Set opponent players as #1 through #12 instantly
  const numbered = Array.from({length: 12}, (_, i) => `#${i + 1}`);
  state.oppPlayers = numbered.map(n => emptyPlayer(n));
  save();
  renderGrid();
  
  const msg = document.createElement('div');
  msg.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#1e40af; color:#93c5fd; padding:12px 24px; border-radius:8px; font-size:14px; font-weight:700; z-index:10000; box-shadow:0 4px 12px rgba(0,0,0,0.3);';
  msg.textContent = 'âœ“ Opponent set to #1 â€“ #12';
  document.body.appendChild(msg);
  setTimeout(() => msg.remove(), 2000);
}

function openOppRosterModal() {
  const oppName = state.opponent || 'Opponent';
  const players = state.oppPlayers || [];
  
  const rowsHTML = players.map((p, idx) => `
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
      <span style="color:#60a5fa; font-size:12px; min-width:22px; text-align:right; font-weight:700;">${idx+1}.</span>
      <input 
        value="${escHtml(p.name || '')}" 
        oninput="updateOppPlayerName(${idx}, this.value)"
        placeholder="Player ${idx+1} or #${idx+1}"
        style="flex:1; background:var(--bg-raise); border:1px solid rgba(59,130,246,0.5); border-radius:var(--radius-sm); color:var(--text-hi); padding:7px 10px; font-family:'Barlow',sans-serif; font-size:13px; outline:none;"
      />
      <button onclick="removeOppPlayer(${idx})" style="background:#7f1d1d; color:#fca5a5; border:none; border-radius:4px; padding:6px 10px; cursor:pointer; font-size:13px;">âœ•</button>
    </div>
  `).join('');

  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()" style="max-width:440px;">
        <div class="modal-title" style="background:#1e40af; color:#93c5fd;">ðŸ‘¥ ${escHtml(oppName)} Lineup</div>
        
        <!-- Quick set options -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:14px;">
          <button onclick="quickSetOppNumbers(6)" style="background:#374151; color:#d1d5db; border:1px solid #4b5563; border-radius:6px; padding:8px; font-size:12px; font-weight:700; cursor:pointer; font-family:inherit;">
            ðŸ”¢ Set #1â€“#6
          </button>
          <button onclick="quickSetOppNumbers(9)" style="background:#374151; color:#d1d5db; border:1px solid #4b5563; border-radius:6px; padding:8px; font-size:12px; font-weight:700; cursor:pointer; font-family:inherit;">
            ðŸ”¢ Set #1â€“#9
          </button>
          <button onclick="quickSetOppNumbers(10)" style="background:#374151; color:#d1d5db; border:1px solid #4b5563; border-radius:6px; padding:8px; font-size:12px; font-weight:700; cursor:pointer; font-family:inherit;">
            ðŸ”¢ Set #1â€“#10
          </button>
          <button onclick="quickSetOppNumbers(12)" style="background:#374151; color:#d1d5db; border:1px solid #4b5563; border-radius:6px; padding:8px; font-size:12px; font-weight:700; cursor:pointer; font-family:inherit;">
            ðŸ”¢ Set #1â€“#12
          </button>
        </div>
        
        <div style="color:#94a3b8; font-size:11px; text-align:center; margin-bottom:10px;">
          â€” or type names manually below â€”
        </div>
        
        <div style="max-height:300px; overflow-y:auto; margin-bottom:10px;">
          ${rowsHTML}
        </div>
        
        <button onclick="addOppPlayer()" style="width:100%; background:#1e3a8a; color:#93c5fd; border:1px dashed #3b82f6; border-radius:6px; padding:8px; font-size:13px; font-weight:700; cursor:pointer; font-family:inherit; margin-bottom:8px;">
          âž• Add Player
        </button>
        
        <!-- Save as named roster for this team -->
        <button onclick="saveOppRosterForTeam()" style="width:100%; background:#166534; color:#86efac; border:1px solid #22c55e; border-radius:6px; padding:8px; font-size:13px; font-weight:700; cursor:pointer; font-family:inherit; margin-bottom:8px;">
          ðŸ’¾ Save Roster for ${escHtml(oppName)}
        </button>
        
        <button onclick="loadSavedOppRoster()" style="width:100%; background:#374151; color:#d1d5db; border:1px solid #4b5563; border-radius:6px; padding:8px; font-size:13px; font-weight:700; cursor:pointer; font-family:inherit; margin-bottom:8px;">
          ðŸ“‚ Load Saved Roster for ${escHtml(oppName)}
        </button>
        
        <button class="modal-btn cancel" onclick="closeModal()">Close</button>
      </div>
    </div>`;
}

function quickSetOppNumbers(count) {
  state.oppPlayers = Array.from({length: count}, (_, i) => emptyPlayer(`#${i + 1}`));
  save();
  renderGrid();
  openOppRosterModal(); // Refresh modal
}

function updateOppPlayerName(idx, val) {
  if (state.oppPlayers[idx]) {
    state.oppPlayers[idx].name = val;
    save();
  }
}

function removeOppPlayer(idx) {
  state.oppPlayers.splice(idx, 1);
  save();
  renderGrid();
  openOppRosterModal();
}

function addOppPlayer() {
  const num = state.oppPlayers.length + 1;
  state.oppPlayers.push(emptyPlayer(`#${num}`));
  save();
  openOppRosterModal();
  // Focus last input
  setTimeout(() => {
    const inputs = document.querySelectorAll('.modal input');
    if (inputs.length) inputs[inputs.length - 2].focus(); // -2 to skip the last non-input
  }, 50);
}

function saveOppRosterForTeam() {
  const teamName = state.opponent || 'Opponent';
  const names = state.oppPlayers.map(p => p.name);
  savedOppRoster[teamName] = names;
  try {
    localStorage.setItem('mls-opp-rosters', JSON.stringify(savedOppRoster));
  } catch(e) {}
  
  const msg = document.createElement('div');
  msg.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#166534; color:#86efac; padding:12px 24px; border-radius:8px; font-size:14px; font-weight:700; z-index:10000;';
  msg.textContent = `âœ“ Roster saved for ${teamName}!`;
  document.body.appendChild(msg);
  setTimeout(() => msg.remove(), 2000);
}

function loadSavedOppRoster() {
  const teamName = state.opponent || 'Opponent';
  
  // Load from localStorage
  try {
    const stored = localStorage.getItem('mls-opp-rosters');
    if (stored) savedOppRoster = JSON.parse(stored);
  } catch(e) {}
  
  const names = savedOppRoster[teamName];
  if (!names || names.length === 0) {
    alert(`No saved roster found for "${teamName}".\n\nSet up the lineup first, then click "Save Roster".`);
    return;
  }
  
  // Apply saved roster, preserving existing innings data
  state.oppPlayers = names.map((name, i) => {
    const existing = state.oppPlayers[i];
    if (existing) { existing.name = name; return existing; }
    return emptyPlayer(name);
  });
  
  save();
  renderGrid();
  openOppRosterModal();
}

function openTeamSelector() {
  let teamsHTML = '';
  
  if (savedTeams.length === 0) {
    teamsHTML = '<div style="color:#64748b; text-align:center; padding:20px; font-size:13px;">No saved teams yet.<br/>Type a team name and click "Save Current Team"</div>';
  } else {
    teamsHTML = savedTeams.map((team, idx) => 
      `<div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
        <button class="modal-btn" onclick="selectTeam('${team.replace(/'/g, "\\'")}'); closeModal();" style="flex:1; text-align:left; margin:0;">
          ${team}
        </button>
        <button onclick="deleteTeam(${idx})" style="background:#7f1d1d; color:#fca5a5; border:none; border-radius:4px; padding:8px 12px; cursor:pointer; font-size:12px;">âœ•</button>
      </div>`
    ).join('');
  }
  
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()" style="max-width: 400px;">
        <div class="modal-title">Opponent Teams</div>
        <div style="max-height: 300px; overflow-y: auto; margin: 16px 0;">
          ${teamsHTML}
        </div>
        ${state.opponent ? `
          <button class="modal-btn" onclick="saveCurrentTeam()" style="background:#166534; color:#86efac; margin-bottom:8px;">
            ðŸ’¾ Save Current Team: "${state.opponent}"
          </button>
        ` : ''}
        <button class="modal-btn" onclick="openAddTeamModal()" style="background:#1e40af; color:#93c5fd; margin-bottom:8px;">
          âž• Add New Team
        </button>
        <button class="modal-btn cancel" onclick="closeModal()">Close</button>
      </div>
    </div>`;
}

function selectTeam(teamName) {
  state.opponent = teamName;
  document.getElementById("input-opponent").value = teamName;
  save();
  renderScoreboard();
  renderOuts(); // Update outs section with new opponent name
  updateHRDisplay(); // Update HR tracker labels
}

function saveCurrentTeam() {
  const teamName = state.opponent.trim();
  if (teamName && !savedTeams.includes(teamName)) {
    savedTeams.push(teamName);
    savedTeams.sort();
    saveTeams();
  }
  openTeamSelector(); // Refresh the modal
}

function deleteTeam(idx) {
  if (confirm(`Delete "${savedTeams[idx]}" from saved teams?`)) {
    savedTeams.splice(idx, 1);
    saveTeams();
    openTeamSelector(); // Refresh the modal
  }
}

function openAddTeamModal() {
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">Add New Team</div>
        <input type="text" id="new-team-name" placeholder="Team name" 
               style="width:100%; padding:10px; border-radius:var(--radius-sm); border:1px solid var(--border); background:var(--bg-raise); color:var(--text-hi); font-family:'Barlow',sans-serif; font-size:14px; margin:16px 0;"
               onkeypress="if(event.key==='Enter') addNewTeam()" />
        <div class="modal-btn-row">
          <button class="modal-btn ok" onclick="addNewTeam()">Add</button>
          <button class="modal-btn cancel2" onclick="openTeamSelector()">Back</button>
        </div>
      </div>
    </div>`;
  setTimeout(() => document.getElementById("new-team-name").focus(), 100);
}

function addNewTeam() {
  const input = document.getElementById("new-team-name");
  const teamName = input.value.trim();
  if (teamName) {
    if (!savedTeams.includes(teamName)) {
      savedTeams.push(teamName);
      savedTeams.sort();
      saveTeams();
    }
    selectTeam(teamName);
    closeModal();
  }
}

// â”€â”€ MY TEAM SELECTOR â”€â”€
function onMyTeamInput(val) {
  console.log('My Team changed to:', val);
  state.myTeam = val;
  
  // Update toggle button label
  const myTeamNameSpan = document.getElementById('myteam-name');
  if (myTeamNameSpan) myTeamNameSpan.textContent = val || 'My Team';
  
  save();
  renderScoreboard();
  renderOuts(); // Update outs section with new team name
  updateHRDisplay(); // Update HR tracker labels
  
  // Update tracking indicator if in myTeam mode
  if (state.trackingMode === 'myTeam') {
    const indicator = document.getElementById('tracking-indicator');
    if (indicator) {
      indicator.innerHTML = `Recording stats for: <span style="color: #22c55e; font-weight: 700;">${val || 'My Team'}</span>`;
    }
  }
}

function openMyTeamSelector() {
  let teamsHTML = '';
  
  if (savedMyTeams.length === 0) {
    teamsHTML = '<div style="color:#64748b; text-align:center; padding:20px; font-size:13px;">No saved teams yet.</div>';
  } else {
    teamsHTML = savedMyTeams.map((team, idx) => 
      `<div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
        <button class="modal-btn" onclick="selectMyTeam('${team.replace(/'/g, "\\'")}'); closeModal();" style="flex:1; text-align:left; margin:0;">
          ${escHtml(team)}
        </button>
        <button onclick="deleteMyTeam(${idx})" style="background:#7f1d1d; color:#fca5a5; border:none; border-radius:4px; padding:8px 12px; cursor:pointer; font-size:12px;">âœ•</button>
      </div>`
    ).join('');
  }
  
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()" style="max-width: 400px;">
        <div class="modal-title">My Team Names</div>
        <div style="max-height: 300px; overflow-y: auto; margin: 16px 0;">
          ${teamsHTML}
        </div>
        ${state.myTeam ? `
          <button class="modal-btn" onclick="saveCurrentMyTeam()" style="background:#166534; color:#86efac; margin-bottom:8px;">
            ðŸ’¾ Save Current: "${state.myTeam}"
          </button>
        ` : ''}
        <button class="modal-btn" onclick="openAddMyTeamModal()" style="background:#1e40af; color:#93c5fd; margin-bottom:8px;">
          âž• Add New Team Name
        </button>
        <button class="modal-btn cancel" onclick="closeModal()">Close</button>
      </div>
    </div>`;
}

function selectMyTeam(teamName) {
  state.myTeam = teamName;
  document.getElementById("input-my-team").value = teamName;
  save();
  renderScoreboard();
  renderOuts(); // Update outs section with new team name
  updateHRDisplay(); // Update HR tracker labels
}

function saveCurrentMyTeam() {
  const teamName = state.myTeam.trim();
  if (teamName && !savedMyTeams.includes(teamName)) {
    savedMyTeams.push(teamName);
    savedMyTeams.sort();
    saveMyTeams();
  }
  openMyTeamSelector();
}

function deleteMyTeam(idx) {
  if (confirm(`Delete "${savedMyTeams[idx]}" from your teams?`)) {
    savedMyTeams.splice(idx, 1);
    saveMyTeams();
    openMyTeamSelector();
  }
}

function openAddMyTeamModal() {
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">Add Team Name</div>
        <input type="text" id="new-my-team-name" placeholder="Team name" 
               style="width:100%; padding:10px; border-radius:var(--radius-sm); border:1px solid var(--border); background:var(--bg-raise); color:var(--text-hi); font-family:'Barlow',sans-serif; font-size:14px; margin:16px 0;"
               onkeypress="if(event.key==='Enter') addNewMyTeam()" />
        <div class="modal-btn-row">
          <button class="modal-btn ok" onclick="addNewMyTeam()">Add</button>
          <button class="modal-btn cancel2" onclick="openMyTeamSelector()">Back</button>
        </div>
      </div>
    </div>`;
  setTimeout(() => document.getElementById("new-my-team-name").focus(), 100);
}

function addNewMyTeam() {
  const input = document.getElementById("new-my-team-name");
  const teamName = input.value.trim();
  if (teamName) {
    if (!savedMyTeams.includes(teamName)) {
      savedMyTeams.push(teamName);
      savedMyTeams.sort();
      saveMyTeams();
    }
    selectMyTeam(teamName);
    closeModal();
  }
}

// â”€â”€ LINEUP MANAGER â”€â”€
function saveLineups() {
  try {
    localStorage.setItem("mls-saved-lineups", JSON.stringify(savedLineups));
  } catch(e) {}
}

function openLineupManager() {
  let lineupsHTML = '';
  
  if (savedLineups.length === 0) {
    lineupsHTML = '<div style="color:#64748b; text-align:center; padding:20px; font-size:13px;">No saved lineups yet.<br/>Add your current lineup below!</div>';
  } else {
    lineupsHTML = savedLineups.map((lineup, idx) => 
      `<div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
        <button class="modal-btn" onclick="loadLineup(${idx}); closeModal();" style="flex:1; text-align:left; margin:0;">
          <div style="font-weight:700; margin-bottom:4px;">${lineup.name}</div>
          <div style="font-size:11px; color:#94a3b8;">${lineup.players.length} players</div>
        </button>
        <button onclick="deleteLineup(${idx})" style="background:#7f1d1d; color:#fca5a5; border:none; border-radius:4px; padding:8px 12px; cursor:pointer; font-size:12px;">âœ•</button>
      </div>`
    ).join('');
  }
  
  const currentLineupNames = state.players.map(p => p.name).filter(n => n.trim());
  const canSave = currentLineupNames.length > 0;
  
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()" style="max-width: 450px;">
        <div class="modal-title">Saved Lineups</div>
        <div style="max-height: 300px; overflow-y: auto; margin: 16px 0;">
          ${lineupsHTML}
        </div>
        ${canSave ? `
          <button class="modal-btn" onclick="openSaveLineupModal()" style="background:#166534; color:#86efac; margin-bottom:8px;">
            ðŸ’¾ Save Current Lineup (${currentLineupNames.length} players)
          </button>
        ` : ''}
        <button class="modal-btn cancel" onclick="closeModal()">Close</button>
      </div>
    </div>`;
}

function openSaveLineupModal() {
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">Save Current Lineup</div>
        <input type="text" id="new-lineup-name" placeholder="Lineup name (e.g., Home Lineup, Full Squad)" 
               style="width:100%; padding:10px; border-radius:var(--radius-sm); border:1px solid var(--border); background:var(--bg-raise); color:var(--text-hi); font-family:'Barlow',sans-serif; font-size:14px; margin:16px 0;"
               onkeypress="if(event.key==='Enter') saveCurrentLineup()" />
        <div style="color:#64748b; font-size:12px; margin-bottom:16px;">
          This will save ${state.players.filter(p => p.name.trim()).length} players in their current order
        </div>
        <div class="modal-btn-row">
          <button class="modal-btn ok" onclick="saveCurrentLineup()">Save</button>
          <button class="modal-btn cancel2" onclick="openLineupManager()">Back</button>
        </div>
      </div>
    </div>`;
  setTimeout(() => document.getElementById("new-lineup-name").focus(), 100);
}

function saveCurrentLineup() {
  const input = document.getElementById("new-lineup-name");
  const lineupName = input.value.trim();
  if (!lineupName) {
    alert("Please enter a lineup name");
    return;
  }
  
  // Save player names in current order
  const playerNames = state.players.map(p => p.name.trim()).filter(n => n);
  
  if (playerNames.length === 0) {
    alert("No players to save!");
    return;
  }
  
  savedLineups.push({
    name: lineupName,
    players: playerNames
  });
  
  saveLineups();
  closeModal();
  
  // Show confirmation
  alert(`Lineup "${lineupName}" saved with ${playerNames.length} players!`);
}

function loadLineup(idx) {
  const lineup = savedLineups[idx];
  if (!lineup) return;
  
  if (!confirm(`Load "${lineup.name}" lineup? This will replace your current players.`)) {
    return;
  }
  
  // Clear current players and load saved lineup
  state.players = lineup.players.map(name => emptyPlayer(name));
  
  save();
  render();
}

function deleteLineup(idx) {
  if (confirm(`Delete "${savedLineups[idx].name}" lineup?`)) {
    savedLineups.splice(idx, 1);
    saveLineups();
    openLineupManager(); // Refresh the modal
  }
}

// â”€â”€ PLAYER NAME SELECTOR â”€â”€
function openPlayerSelector(playerIndex) {
  let playersHTML = '';
  
  if (savedRoster.length === 0) {
    playersHTML = '<div style="color:#64748b; text-align:center; padding:20px; font-size:13px;">No players in roster.<br/>Add players in the Roster manager first!</div>';
  } else {
    playersHTML = savedRoster.map((name, idx) => 
      `<button class="modal-btn" onclick="selectPlayerName(${playerIndex}, '${name.replace(/'/g, "\\'")}'); closeModal();" style="text-align:left; margin-bottom:6px;">
        ${name}
      </button>`
    ).join('');
  }
  
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()" style="max-width: 350px;">
        <div class="modal-title">Select Player for Position ${playerIndex + 1}</div>
        <div style="max-height: 400px; overflow-y: auto; margin: 16px 0;">
          ${playersHTML}
        </div>
        <button class="modal-btn" onclick="openRosterModal(); closeModal();" style="background:#1e40af; color:#93c5fd; margin-bottom:8px;">
          ðŸ“‹ Manage Roster
        </button>
        <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
}

function selectPlayerName(playerIndex, name) {
  state.players[playerIndex].name = name;
  save();
  render();
}


function getColor(r) {
  if (["SO","GO","FO"].includes(r)) return "#ef4444"; // Red for outs
  if (["DP","TP"].includes(r)) return "#dc2626"; // Darker red for double/triple plays
  if (r && r.startsWith("FC")) return "#eab308"; // Yellow for FC (reaches base but not a hit)
  if (r === "ROE") return "#f97316"; // Orange for ROE (reaches base on error)
  if (["1B","2B","3B","HR"].includes(r)) return "#22c55e"; // Green for hits
  if (r === "BB") return "#60a5fa"; // Blue for walks
  if (r === "SAC") return "#a78bfa"; // Purple for sac
  return "#94a3b8";
}

function calcStats(player) {
  let H = 0, AB = 0, R = 0, RBI = 0, XBH = 0, SAC = 0, BB = 0;
  player.innings.forEach(inn => {
    if (inn.result) {
      AB++;
      if (["1B","2B","3B","HR"].includes(inn.result)) H++;
      if (["2B","3B","HR"].includes(inn.result)) XBH++; // Extra base hits
      if (inn.result === "SAC") SAC++;
      if (inn.result === "BB") BB++; // Count walks
      // FC counts as AB but not a hit (batter reached base, runner was out)
      // ROE also counts as AB (batter reached base on an error) â€” intentionally not excluded below
      if (["BB","SAC"].includes(inn.result)) AB--; // These don't count as AB
    }
    if (inn.run) R++;
    if (inn.rbi) RBI += inn.rbi;
  });
  const AVG = AB > 0 ? (H / AB).toFixed(3) : ".000";
  return { H, AB, R, RBI, AVG, XBH, SAC, BB };
}

function diamondSVG(bases, row, inn, result, rbi) {
  const b1 = bases.includes("1st"), b2 = bases.includes("2nd"), b3 = bases.includes("3rd");
  const isFC  = result === "FC";
  const isHR  = result === "HR";
  const isHRO = result === "HRO"; // HR over limit
  const isHit = ["1B","2B","3B"].includes(result);
  const hasRBI = rbi > 0;

  // Hits light green, FC/other lights gold
  const litFill   = isHit ? "#22c55e" : "#f59e0b";
  const litStroke = isHit ? "#16a34a" : "#d97706";

  return `<svg class="diamond-svg" viewBox="0 0 60 60" style="cursor: pointer;">
    <polygon points="30,5 55,30 30,55 5,30" fill="${isHR ? '#1a3b1f' : (isHRO ? '#3b1f1f' : 'none')}" stroke="${isHR ? '#22c55e' : (isHRO ? '#ef4444' : '#aaa')}" stroke-width="${(isHR || isHRO) ? '2' : '1.2'}"/>

    <!-- 1st Base -->
    <circle cx="55" cy="30" r="${b1?5.5:3.5}" fill="${b1?litFill:"#cbd5e1"}" stroke="${b1?litStroke:"#94a3b8"}" stroke-width="1.2" 
            onclick="toggleBase(${row},${inn},'1st')" style="cursor:pointer;" class="base-circle"/>
    ${isFC && b1 ? '<text x="55" y="32" text-anchor="middle" font-size="6" fill="#000" font-weight="bold" pointer-events="none">FC</text>' : ''}

    <!-- 2nd Base -->
    <circle cx="30" cy="5" r="${b2?5.5:3.5}" fill="${b2?litFill:"#cbd5e1"}" stroke="${b2?litStroke:"#94a3b8"}" stroke-width="1.2"
            onclick="toggleBase(${row},${inn},'2nd')" style="cursor:pointer;" class="base-circle"/>
    ${isFC && b2 ? '<text x="30" y="7" text-anchor="middle" font-size="6" fill="#000" font-weight="bold" pointer-events="none">FC</text>' : ''}

    <!-- 3rd Base -->
    <circle cx="5" cy="30" r="${b3?5.5:3.5}" fill="${b3?litFill:"#cbd5e1"}" stroke="${b3?litStroke:"#94a3b8"}" stroke-width="1.2"
            onclick="toggleBase(${row},${inn},'3rd')" style="cursor:pointer;" class="base-circle"/>
    ${isFC && b3 ? '<text x="5" y="32" text-anchor="middle" font-size="6" fill="#000" font-weight="bold" pointer-events="none">FC</text>' : ''}

    <!-- HR label in centre -->
    ${isHR ? '<text x="30" y="33" text-anchor="middle" font-size="11" fill="#22c55e" font-weight="bold" pointer-events="none">HR</text>' : ''}
    
    <!-- HRO (HR Over limit = Out) label in centre -->
    ${isHRO ? '<text x="30" y="29" text-anchor="middle" font-size="8" fill="#ef4444" font-weight="bold" pointer-events="none">HR</text><text x="30" y="37" text-anchor="middle" font-size="7" fill="#ef4444" font-weight="bold" pointer-events="none">OUT</text>' : ''}

    <!-- Home plate â€” lights up gold with RBI count when runs scored -->
    <circle cx="30" cy="55" r="${hasRBI ? 6 : 4}" fill="${hasRBI ? '#f59e0b' : '#e2e8f0'}" stroke="${hasRBI ? '#d97706' : '#94a3b8'}" stroke-width="1.4"
            onclick="openRBIModal(${row},${inn})" style="cursor:pointer;" class="base-circle"/>
    ${hasRBI ? `<text x="30" y="57.2" text-anchor="middle" font-size="${rbi >= 10 ? '5.5' : '7'}" fill="#1e293b" font-weight="bold" pointer-events="none">${rbi}</text>` : ''}
  </svg>`;
}

function toggleBase(row, inn, base) {
  const bases = state.players[row].innings[inn].bases;
  const idx = bases.indexOf(base);
  if (idx > -1) {
    bases.splice(idx, 1); // Remove base
  } else {
    bases.push(base); // Add base
  }
  save();
  renderGrid();
}

function escHtml(s) { 
  if (!s) return '';
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); 
}

// ---- RENDER ----
function render() {
  document.getElementById("input-my-team").value = state.myTeam || "";
  document.getElementById("input-opponent").value = state.opponent;
  document.getElementById("input-date").value = state.date;
  document.getElementById("input-game-number").value = state.gameNumber || "";
  document.getElementById("input-game-result").value = state.gameResult || "";
  document.getElementById("input-hr-limit").value = state.hrLimit || 2;
  
  // Update home/away button
  const homeAwayBtn = document.getElementById('home-away-toggle');
  if (homeAwayBtn) {
    homeAwayBtn.textContent = state.isHome ? 'HOME' : 'AWAY';
    homeAwayBtn.style.color = state.isHome ? '#22c55e' : '#f59e0b';
    homeAwayBtn.style.borderColor = state.isHome ? '#22c55e' : '#f59e0b';
  }
  
  updateHRDisplay(); // Update HR tracker
  updateStatsDisplay(); // Update stats summary
  renderScoreboard();
  renderOuts();
  renderGrid();
}

function renderScoreboard() {
  const bbcTotal = state.bbcRuns.reduce((a,b) => a+b, 0);
  const oppTotal = state.oppRuns.reduce((a,b) => a+b, 0);
  const bbcWalksTotal = state.bbcWalks.reduce((a,b) => a+b, 0);

  let html = '<div class="scoreboard-inner">';

  // Header row
  html += '<div class="sb-row">';
  html += '<div class="sb-label header-label"></div>';
  for (let i = 0; i < INNINGS; i++) html += `<div class="sb-cell">${i+1}</div>`;
  html += '<div class="sb-total">TOT</div></div>';

  // Backyard Baseball Club row with +/- controls
  html += '<div class="sb-row">';
  const bbcWinning = bbcTotal > oppTotal && (bbcTotal > 0 || oppTotal > 0);
  const winIndicator = bbcWinning ? ' ðŸ†' : '';
  html += `<div class="sb-label">${escHtml(state.myTeam || "Backyard Baseball Club")}${winIndicator}</div>`;
  for (let i = 0; i < INNINGS; i++) {
    html += `<div class="opp-cell">
      <button class="opp-btn" onclick="changeBBCRuns(${i},1)" style="color:#22c55e;">+</button>
      <span class="opp-val" style="color:#22c55e;">${state.bbcRuns[i]}</span>
      <button class="opp-btn" onclick="changeBBCRuns(${i},-1)" style="color:#22c55e;">âˆ’</button>
    </div>`;
  }
  html += `<div class="opp-total"><span class="opp-val" style="color:#22c55e;">${bbcTotal}</span></div>`;
  html += '</div>';

  // Opponent row with +/- controls
  html += '<div class="sb-row">';
  const oppWinning = oppTotal > bbcTotal && (bbcTotal > 0 || oppTotal > 0);
  const oppWinIndicator = oppWinning ? ' ðŸ†' : '';
  html += `<div class="sb-label opp">${escHtml(state.opponent || "Opponent")}${oppWinIndicator}</div>`;
  for (let i = 0; i < INNINGS; i++) {
    html += `<div class="opp-cell">
      <button class="opp-btn" onclick="changeOppRuns(${i},1)">+</button>
      <span class="opp-val">${state.oppRuns[i]}</span>
      <button class="opp-btn" onclick="changeOppRuns(${i},-1)">âˆ’</button>
    </div>`;
  }
  html += `<div class="opp-total"><span class="opp-val">${oppTotal}</span></div>`;
  html += '</div>';

  html += '</div>';
  document.getElementById("scoreboard").innerHTML = html;
  
  // Auto-detect game result based on final scores
  autoDetectGameResult(bbcTotal, oppTotal);
}

function autoDetectGameResult(bbcTotal, oppTotal) {
  // Only auto-detect if game has started (at least one team has scored or innings recorded)
  const gameStarted = bbcTotal > 0 || oppTotal > 0 || 
                      state.players.some(p => p.innings.some(inn => inn.result));
  
  if (!gameStarted) {
    return; // Don't set result for empty games
  }
  
  let result = "";
  if (bbcTotal > oppTotal) {
    result = "W";
  } else if (bbcTotal < oppTotal) {
    result = "L";
  } else if (bbcTotal === oppTotal && bbcTotal > 0) {
    result = "T";
  }
  
  // Only update if different from current
  if (result && state.gameResult !== result) {
    state.gameResult = result;
    document.getElementById("input-game-result").value = result;
    save();
  }
}

function renderOuts() {
  try {
    const myTeamName = state.myTeam || 'BBC';
    const oppTeamName = state.opponent || 'OPPONENT';
    console.log('renderOuts called - myTeam:', myTeamName, 'opponent:', oppTeamName);
    
    // Determine who bats first (top) and second (bottom) based on isHome
    const topTeam = state.isHome ? oppTeamName : myTeamName;
    const bottomTeam = state.isHome ? myTeamName : oppTeamName;
    const topOuts = state.isHome ? state.oppOuts : state.outs;
    const bottomOuts = state.isHome ? state.outs : state.oppOuts;
    const topColor = state.isHome ? '#60a5fa' : '#22c55e';
    const bottomColor = state.isHome ? '#22c55e' : '#60a5fa';
    
    let html = '';
    
    // Top of inning section
    html += `<div style="width:100%; margin-bottom:8px;">`;
    html += `<div id="bbc-outs-label" style="text-align:center; font-size:11px; color:${topColor}; font-weight:700; margin-bottom:4px;">${topTeam.toUpperCase()} OUTS <span style="color:#94a3b8; font-size:9px;">(Top)</span></div>`;
    html += `<div style="display:flex; justify-content:center; gap:6px; flex-wrap:wrap;">`;
    
    for (let i = 0; i < INNINGS; i++) {
      const outsCount = topOuts[i];
      
      // Create 3 circles to represent the 3 outs
      const outCircles = [1, 2, 3].map(outNum => {
        const isFilled = outNum <= outsCount;
        const fillColor = isFilled ? '#ef4444' : 'transparent';
        return `<div style="width:12px; height:12px; border-radius:50%; border:2px solid #ef4444; background:${fillColor}; display:inline-block; margin:0 1px;" title="Out ${outNum}"></div>`;
      }).join('');
      
      // Top team: if we're home, top = opponent (changeOppOuts), if we're away, top = us (changeOuts)
      const topChangeFunc = state.isHome ? 'changeOppOuts' : 'changeOuts';
      html += `<div class="inn-ctrl">
        <div class="label">Inn ${i+1}</div>
        <div style="margin:3px 0; display:flex; justify-content:center;">${outCircles}</div>
        <div class="ctrl-row">
          <button class="ctrl-btn" onclick="${topChangeFunc}(${i},-1)" style="font-size:16px;">âˆ’</button>
          <span class="ctrl-val" style="font-size:15px; font-weight:800; color:#ef4444;">${outsCount}/3</span>
          <button class="ctrl-btn" onclick="${topChangeFunc}(${i},1)" style="font-size:16px;">+</button>
        </div>
      </div>`;
    }
    
    html += `</div></div>`;
    
    // Bottom of inning section
    html += `<div style="width:100%;">`;
    html += `<div id="opp-outs-label" style="text-align:center; font-size:11px; color:${bottomColor}; font-weight:700; margin-bottom:4px;">${bottomTeam.toUpperCase()} OUTS <span style="color:#94a3b8; font-size:9px;">(Bottom)</span></div>`;
    html += `<div style="display:flex; justify-content:center; gap:6px; flex-wrap:wrap;">`;
    
    for (let i = 0; i < INNINGS; i++) {
      const oppOutsCount = bottomOuts[i];
      
      // Create 3 circles to represent the 3 outs
      const oppOutCircles = [1, 2, 3].map(outNum => {
        const isFilled = outNum <= oppOutsCount;
        const fillColor = isFilled ? '#ef4444' : 'transparent';
        return `<div style="width:12px; height:12px; border-radius:50%; border:2px solid #ef4444; background:${fillColor}; display:inline-block; margin:0 1px;" title="Out ${outNum}"></div>`;
      }).join('');
      
      // Bottom team: if we're home, bottom = us (changeOuts), if we're away, bottom = opponent (changeOppOuts)
      const bottomChangeFunc = state.isHome ? 'changeOuts' : 'changeOppOuts';
      html += `<div class="inn-ctrl">
        <div class="label">Inn ${i+1}</div>
        <div style="margin:3px 0; display:flex; justify-content:center;">${oppOutCircles}</div>
        <div class="ctrl-row">
          <button class="ctrl-btn" onclick="${bottomChangeFunc}(${i},-1)" style="font-size:16px;">âˆ’</button>
          <span class="ctrl-val" style="font-size:15px; font-weight:800; color:#ef4444;">${oppOutsCount}/3</span>
          <button class="ctrl-btn" onclick="${bottomChangeFunc}(${i},1)" style="font-size:16px;">+</button>
        </div>
      </div>`;
    }
    
    html += `</div></div>`;
    
    const outsElement = document.getElementById("outs-row");
    if (outsElement) {
      // Try setting innerHTML normally first
      outsElement.innerHTML = html;
      
      // Then also try updating the labels directly via DOM
      setTimeout(() => {
        const bbcLabel = document.getElementById("bbc-outs-label");
        const oppLabel = document.getElementById("opp-outs-label");
        if (bbcLabel) {
          bbcLabel.textContent = `${myTeamName.toUpperCase()} OUTS`;
          console.log('Updated BBC label via textContent');
        }
        if (oppLabel) {
          oppLabel.textContent = `${oppTeamName.toUpperCase()} OUTS`;
          console.log('Updated OPP label via textContent');
        }
      }, 0);
      
      console.log('HTML updated - should see:', myTeamName.toUpperCase(), 'OUTS and', oppTeamName.toUpperCase(), 'OUTS');
    } else {
      console.error('outs-row element not found!');
    }
  } catch (error) {
    console.error('Error in renderOuts:', error);
  }
}

function switchTrackingMode(mode) {
  state.trackingMode = mode;
  
  // Update button styles
  const myTeamBtn = document.getElementById('toggle-myteam');
  const oppBtn = document.getElementById('toggle-opponent');
  const indicator = document.getElementById('tracking-indicator');
  const oppRosterBar = document.getElementById('opp-roster-bar');
  
  if (mode === 'myTeam') {
    myTeamBtn.style.background = 'var(--green)';
    myTeamBtn.style.color = 'var(--bg-base)';
    oppBtn.style.background = 'transparent';
    oppBtn.style.color = 'var(--text-lo)';
    indicator.innerHTML = `Recording: <span style="color:var(--green); font-weight:800;">${state.myTeam || 'My Team'}</span>`;
    if (oppRosterBar) oppRosterBar.style.display = 'none';
  } else {
    myTeamBtn.style.background = 'transparent';
    myTeamBtn.style.color = 'var(--text-lo)';
    oppBtn.style.background = '#3b82f6';
    oppBtn.style.color = 'var(--bg-base)';
    indicator.innerHTML = `Recording: <span style="color:#60a5fa; font-weight:800;">${state.opponent || 'Opponent'}</span>`;
    if (oppRosterBar) oppRosterBar.style.display = 'flex';
  }
  
  save();
  renderGrid();
  renderScoreboard();
  renderOuts();
}

function renderGrid() {
  // Get the current player array based on tracking mode
  const currentPlayers = state.trackingMode === 'opponent' ? state.oppPlayers : state.players;
  const currentOuts = state.trackingMode === 'opponent' ? state.oppOuts : state.outs;
  
  // Responsive column widths based on screen size
  const isSmallScreen = window.innerWidth < 768;
  const numCol = isSmallScreen ? "24px" : "28px";
  const nameCol = isSmallScreen ? "70px" : "90px";
  const innCol = isSmallScreen ? "50px" : "58px";
  const statsCol = isSmallScreen ? "105px" : "120px";
  
  const cols = `${numCol} ${nameCol} ${Array.from({length:INNINGS}, ()=>innCol).join(" ")} ${statsCol}`;
  const grid = document.getElementById("player-grid");
  grid.style.gridTemplateColumns = cols;

  let html = '';
  html += '<div class="grid-header center"></div>';
  html += '<div class="grid-header">Player</div>';
  for (let i = 0; i < INNINGS; i++) html += `<div class="grid-header center">Inn ${i+1}</div>`;
  html += '<div class="grid-header center" style="font-size:9px;line-height:1.3;">H/AB/R/RBI<br>AVG/XBH/BB</div>';

  for (let row = 0; row < currentPlayers.length; row++) {
    const player = currentPlayers[row];
    const st = calcStats(player);
    // Delete button (show only if more than 1 player)
    if (currentPlayers.length > 1) {
      html += `<div class="player-num"><button class="del-player-btn" onclick="deletePlayer(${row})">âœ•</button></div>`;
    } else {
      html += `<div class="player-num">1</div>`;
    }
    html += `<div style="display:flex; gap:4px; align-items:center;">
      <input class="name-input" placeholder="Name" value="${escHtml(player.name)}" oninput="onNameInput(${row}, this.value)" style="flex:1;" />
      <button onclick="openPlayerSelector(${row})" style="background:var(--bg-raise); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text-md); padding:4px 8px; cursor:pointer; font-size:11px; height:100%; transition:all 0.15s;">â–¼</button>
    </div>`;
    for (let i = 0; i < INNINGS; i++) {
      const inn = player.innings[i];
      const inningClosed = currentOuts[i] >= 3;
      const cellStyle = inningClosed ? 'opacity:0.4; pointer-events:none;' : '';
      
      html += `<div class="cell" style="${cellStyle}">`;
      if (inningClosed && !inn.result) {
        // Show "3 OUTS" in empty cells for closed innings
        html += `<div style="font-size:9px; color:#64748b; text-align:center; padding:4px;">â€”</div>`;
      } else if (inn.result) {
        html += `<button class="cell-clear" onclick="clearCell(${row},${i})">âœ•</button>`;
        html += `<div class="cell-result" style="color:${getColor(inn.result)}">${inn.result}</div>`;
        if (inn.runnerOut) html += `<div style="position:absolute;top:20px;left:2px;font-size:8px;color:#ef4444;font-weight:700;">OUT</div>`;
        if (inn.basesAdvanced) html += `<div style="font-size:8px;color:#64748b;">${inn.basesAdvanced}</div>`;
        if (inn.result === "FC" && inn.fcNote) html += `<div style="font-size:8px;color:#eab308;">${inn.fcNote}</div>`;
        
        // Only show diamond if batter reached base (not for strikeouts, flyouts, groundouts)
        const noBasesResults = ["SO", "K", "FO", "GO", "LO"];
        if (!noBasesResults.includes(inn.result)) {
          html += diamondSVG(inn.bases, row, i, inn.result, inn.rbi || 0);
        }
        
        html += `<button class="cell-run-btn ${inn.run?"scored":""}" onclick="toggleRun(${row},${i})">${inn.run?"R":""}</button>`;
        html += `<button class="cell-bases-btn" onclick="openBasesModal(${row},${i})">bases</button>`;
        html += `<button class="cell-bases-btn" onclick="openRBIModal(${row},${i})" style="right:32px;">RBI</button>`;
        if (inn.result === "FC") html += `<button class="cell-bases-btn" onclick="openFCModal(${row},${i})" style="right:62px;font-size:6px;">FC?</button>`;
        if (inn.result === "DP" || inn.result === "TP") html += `<button class="cell-bases-btn" onclick="openMultipleOutsModal(${row},${i},'${inn.result}')" style="right:62px;font-size:6px;">${inn.result}?</button>`;
      } else {
        html += `<div class="cell-btns">
          <button class="cell-btn out" onclick="openOutModal(${row},${i})">OUT</button>
          <button class="cell-btn hit" onclick="openHitModal(${row},${i})">HIT</button>
          <button class="cell-btn oth" onclick="openOthModal(${row},${i})">OTH</button>
        </div>`;
      }
      html += '</div>';
    }
    html += `<div class="stats-col" style="font-size:11px;line-height:1.4;">${st.H}/${st.AB}/${st.R}/${st.RBI}<br>${st.AVG}/${st.XBH}/${st.BB}</div>`;
  }
  grid.innerHTML = html;
}

// ---- ACTIONS ----
function getCurrentPlayers() {
  return state.trackingMode === 'opponent' ? state.oppPlayers : state.players;
}

function getCurrentOuts() {
  return state.trackingMode === 'opponent' ? state.oppOuts : state.outs;
}

function onNameInput(row, val) {
  const players = getCurrentPlayers();
  players[row].name = val;
  save();
  // Auto-add to roster if it's a new non-empty name
  const trimmed = val.trim();
  if (trimmed && !savedRoster.includes(trimmed)) {
    savedRoster.push(trimmed);
    saveRoster();
  }
}

function addPlayer() {
  const players = getCurrentPlayers();
  if (players.length >= MAX_PLAYERS) return;
  players.push(emptyPlayer(""));
  save();
  renderGrid();
}

function deletePlayer(row) {
  const players = getCurrentPlayers();
  if (players.length <= 1) return;
  players.splice(row, 1);
  save();
  renderGrid();
}

function changeOuts(inn, delta) {
  const outs = getCurrentOuts();
  outs[inn] = Math.max(0, Math.min(3, outs[inn] + delta));
  save(); renderOuts();
}

function changeOppOuts(inn, delta) {
  saveStateToHistory(); // Save before changing outs
  state.oppOuts[inn] = Math.max(0, Math.min(3, state.oppOuts[inn] + delta));
  save(); renderOuts();
}

function changeBBCRuns(inn, delta) {
  saveStateToHistory(); // Save before changing runs
  state.bbcRuns[inn] = Math.max(0, state.bbcRuns[inn] + delta);
  save(); renderScoreboard();
}

function changeOppRuns(inn, delta) {
  saveStateToHistory(); // Save before changing runs
  state.oppRuns[inn] = Math.max(0, state.oppRuns[inn] + delta);
  save(); 
  renderScoreboard();
  updateStatsDisplay(); // Update stats when opponent runs change
}

function setResult(row, inn, result) {
  // Save state before making changes (for undo)
  saveStateToHistory();
  
  const players = getCurrentPlayers();
  const outs = getCurrentOuts();
  
  const oldResult = players[row].innings[inn].result;
  const wasOut = ["SO", "GO", "FO", "FC", "E", "HRO", "DP", "TP", "SAC"].includes(oldResult);
  const isNowOut = ["SO", "GO", "FO", "FC", "E", "HRO", "DP", "TP", "SAC"].includes(result);
  
  // Calculate outs to add/remove
  let outsToAdd = 0;
  let outsToRemove = 0;
  
  if (oldResult === "DP") outsToRemove = 2;
  else if (oldResult === "TP") outsToRemove = 3;
  else if (wasOut) outsToRemove = 1;
  
  if (result === "DP") outsToAdd = 2;
  else if (result === "TP") outsToAdd = 3;
  else if (isNowOut) outsToAdd = 1;
  
  // Auto-track outs
  if (outsToRemove > 0) {
    // Removing old outs
    outs[inn] = Math.max(0, outs[inn] - outsToRemove);
  }
  
  if (outsToAdd > 0) {
    // Adding new outs
    outs[inn] = Math.min(3, outs[inn] + outsToAdd);
    
    // Reset 5-run limit flag when inning ends
    if (outs[inn] === 3) {
      state.fiveRunLimitReached = false;
    }
  }
  
  players[row].innings[inn].result = result;
  
  // Auto-score runners on base for hits
  if (["1B", "2B", "3B", "HR"].includes(result)) {
    let rbisEarned = 0; // Count how many RBIs this batter gets
    
    // Find ALL batters in this inning who are on base (not just previous row numbers)
    // This handles when batting order wraps (e.g., batter 12, 13 get on, then batter 1 hits)
    for (let checkRow = 0; checkRow < players.length; checkRow++) {
      if (checkRow === row) continue; // Skip current batter
      
      const runnerInning = players[checkRow].innings[inn];
      if (runnerInning.result && runnerInning.bases && runnerInning.bases.length > 0) {
        // Skip if this runner was removed by FC
        if (!isRunnerActive(checkRow, inn, row)) {
          continue;
        }
        
        // Calculate if they score based on the hit and their base position
        let scores = false;
        let advanceTo = null;
        
        if (result === "HR") {
          // Home run scores everyone on base
          scores = true;
        } else if (result === "3B") {
          // Triple scores from 1st, 2nd, and 3rd
          scores = true;
        } else if (result === "2B") {
          // Double scores from 2nd and 3rd (and sometimes 1st)
          if (runnerInning.bases.includes("2nd") || runnerInning.bases.includes("3rd")) {
            scores = true;
          } else if (runnerInning.bases.includes("1st")) {
            // Runner on 1st advances to 3rd on a double
            advanceTo = ["1st", "2nd", "3rd"];
          }
        } else if (result === "1B") {
          // Single scores from 3rd (and sometimes 2nd)
          if (runnerInning.bases.includes("3rd")) {
            scores = true;
          } else if (runnerInning.bases.includes("2nd")) {
            // Runner on 2nd advances to 3rd on a single
            advanceTo = ["1st", "2nd", "3rd"];
          } else if (runnerInning.bases.includes("1st")) {
            // Runner on 1st advances to 2nd on a single
            advanceTo = ["1st", "2nd"];
          }
        }
        
        if (scores && !runnerInning.run) {
          // Check current run count before scoring
          const currentRuns = players.reduce((sum, p) => sum + (p.innings[inn].run ? 1 : 0), 0);
          
          // Only score if we haven't hit the 5-run limit yet
          if (currentRuns < 5) {
            runnerInning.run = true;
            runnerInning.bases = []; // Clear bases when they score
            rbisEarned++; // Batter gets an RBI for driving in this run
            console.log(`Auto-scored ${players[checkRow].name} from base on ${result}`);
          } else {
            // 5-run limit reached - runner stays on base, doesn't score
            console.log(`${players[checkRow].name} would have scored but 5-run limit reached`);
            // Advance to next base instead of scoring
            if (runnerInning.bases.includes("3rd")) {
              // Already on 3rd, stay there
            } else if (runnerInning.bases.includes("2nd")) {
              advanceTo = ["1st", "2nd", "3rd"];
            } else if (runnerInning.bases.includes("1st")) {
              advanceTo = ["1st", "2nd"];
            }
            
            if (advanceTo) {
              runnerInning.bases = advanceTo;
            }
          }
        } else if (advanceTo) {
          // Advance runner but don't score yet
          runnerInning.bases = advanceTo;
          console.log(`Advanced ${players[checkRow].name} to`, advanceTo);
        }
      }
    }
    
    // For HR, add 1 RBI for the batter themselves (if they score)
    if (result === "HR") {
      const currentRuns = players.reduce((sum, p) => sum + (p.innings[inn].run ? 1 : 0), 0);
      if (currentRuns < 5) {
        rbisEarned++; // Batter scores on HR
      }
    }
    
    // Assign RBIs to the current batter for all runs they drove in
    if (rbisEarned > 0) {
      players[row].innings[inn].rbi = (players[row].innings[inn].rbi || 0) + rbisEarned;
      console.log(`${players[row].name} earned ${rbisEarned} RBI(s)`);
    }
  }
  
  // Auto-set bases for hits
  if (result === "1B") players[row].innings[inn].bases = ["1st"];
  else if (result === "2B") players[row].innings[inn].bases = ["1st", "2nd"];
  else if (result === "3B") players[row].innings[inn].bases = ["1st", "2nd", "3rd"];
  else if (result === "FC") players[row].innings[inn].bases = ["1st"]; // Batter reaches 1st on FC
  else if (result === "HR") {
    // Check if batter can score (5-run limit)
    const currentRuns = players.reduce((sum, p) => sum + (p.innings[inn].run ? 1 : 0), 0);
    
    if (currentRuns < 5) {
      // Batter scores
      players[row].innings[inn].bases = [];  // HR clears bases â€” shown as HR in centre
      players[row].innings[inn].run = true;  // Auto-mark as run scored
    } else {
      // 5-run limit reached - batter doesn't score, stays on base
      players[row].innings[inn].bases = ["1st", "2nd", "3rd"];  // On 3rd (hit HR but can't score)
      players[row].innings[inn].run = false;
      console.log(`${players[row].name} hit HR but 5-run limit reached - on 3rd base`);
    }
    
    // Increment HR count for the correct team
    if (state.trackingMode === 'opponent') {
      state.oppHomeRuns++;
    } else {
      state.bbcHomeRuns++;
    }
    // Note: RBI is already calculated above in the auto-scoring section
    
    updateHRDisplay();
    recalcBBCRuns(inn); // Update runs for this inning
    renderScoreboard(); // Update scoreboard display
  }
  else if (result === "HRO") {
    // HR over limit = out, no bases
    players[row].innings[inn].bases = [];
  }
  else if (result === "BB") {
    // Track walks
    recalcBBCWalks(inn);
    renderScoreboard(); // Update scoreboard display
  }
  
  // Recalculate runs after auto-scoring base runners
  if (["1B", "2B", "3B", "HR"].includes(result)) {
    recalcBBCRuns(inn);
    renderScoreboard();
  }
  
  save(); 
  renderGrid();
  renderOuts();
}

function clearCell(row, inn) {
  // Save state before clearing (for undo)
  saveStateToHistory();
  
  const players = getCurrentPlayers();
  const outs = getCurrentOuts();
  
  const oldResult = players[row].innings[inn].result;
  const wasHR = oldResult === "HR";
  const wasBB = oldResult === "BB";
  
  // Calculate how many outs to remove based on the old result
  let outsToRemove = 0;
  if (oldResult === "DP") outsToRemove = 2;
  else if (oldResult === "TP") outsToRemove = 3;
  else if (["SO", "GO", "FO", "FC", "E", "HRO", "SAC"].includes(oldResult)) outsToRemove = 1;
  
  // Decrease outs if we're clearing an out
  if (outsToRemove > 0 && outs[inn] > 0) {
    outs[inn] = Math.max(0, outs[inn] - outsToRemove);
  }
  
  // Decrease HR count if we're clearing a home run
  if (wasHR) {
    if (state.trackingMode === 'opponent' && state.oppHomeRuns > 0) {
      state.oppHomeRuns--;
    } else if (state.bbcHomeRuns > 0) {
      state.bbcHomeRuns--;
    }
    updateHRDisplay();
  }
  
  players[row].innings[inn] = { 
    result: "", 
    bases: [], 
    run: false, 
    rbi: 0, 
    fcNote: "", 
    basesAdvanced: "",
    fcRemovedRunner: null,
    sacNote: ""
  };
  // recalc BBC runs and walks for that inning
  recalcBBCRuns(inn);
  if (wasBB) recalcBBCWalks(inn); // Recalc walks if we cleared a BB
  save(); 
  renderGrid(); 
  renderScoreboard();
  renderOuts();
}

function toggleRun(row, inn) {
  // Save state before toggling (for undo)
  saveStateToHistory();
  
  const players = getCurrentPlayers();
  
  const wasScoring = players[row].innings[inn].run;
  players[row].innings[inn].run = !wasScoring;
  
  // Auto-assign RBI to the most recent batter who caused this run
  if (!wasScoring) {
    // Run is being turned ON - find who should get the RBI
    // Look for the most recent batter after this runner who got a hit
    let rbiRecipient = null;
    
    for (let i = row + 1; i < MAX_PLAYERS; i++) {
      const batterInning = players[i].innings[inn];
      if (batterInning.result && ["1B", "2B", "3B", "HR", "FC", "E"].includes(batterInning.result)) {
        // This batter got a hit/FC after the runner - they drove in the run
        rbiRecipient = i;
        break;
      }
    }
    
    // Give RBI to the batter who drove in the run
    if (rbiRecipient !== null) {
      players[rbiRecipient].innings[inn].rbi = (players[rbiRecipient].innings[inn].rbi || 0) + 1;
      console.log(`Auto-assigned RBI to ${players[rbiRecipient].name} for scoring ${players[row].name}`);
    }
  } else {
    // Run is being turned OFF - remove RBI from whoever had it
    // Find who has RBI and reduce by 1
    for (let i = row + 1; i < MAX_PLAYERS; i++) {
      const batterInning = players[i].innings[inn];
      if (batterInning.rbi && batterInning.rbi > 0) {
        players[i].innings[inn].rbi--;
        console.log(`Removed RBI from ${players[i].name}`);
        break; // Only remove from the first batter with RBI
      }
    }
  }
  
  recalcBBCRuns(inn);
  save(); renderGrid(); renderScoreboard();
}

function recalcBBCRuns(inn) {
  // Calculate runs from both: players marked as scored AND total RBIs in the inning
  const runsScoredManually = state.players.reduce((sum, p) => sum + (p.innings[inn].run ? 1 : 0), 0);
  const totalRBIs = state.players.reduce((sum, p) => sum + (p.innings[inn].rbi || 0), 0);
  
  // Use the higher of the two (in case someone marks runs manually)
  state.bbcRuns[inn] = Math.max(runsScoredManually, totalRBIs);
  updateStatsDisplay(); // Update stats when runs change
  
  // Check for 5-run limit (mercy rule)
  if (state.bbcRuns[inn] >= 5) {
    checkFiveRunLimit(inn);
  }
}

function isInningComplete(inn) {
  // With top/bottom innings, both teams need to bat (get 3 outs each) for inning to be complete
  // Top team has 3 outs AND bottom team has 3 outs
  const topOuts = state.isHome ? state.oppOuts[inn] : state.outs[inn];
  const bottomOuts = state.isHome ? state.outs[inn] : state.oppOuts[inn];
  
  // Inning is only complete when BOTH halves are done
  return (topOuts >= 3 && bottomOuts >= 3);
}

function showInningCompleteMessage(inn) {
  const topOuts = state.isHome ? state.oppOuts[inn] : state.outs[inn];
  const bottomOuts = state.isHome ? state.outs[inn] : state.oppOuts[inn];
  
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title" style="background:#22c55e; color:#1e293b;">âœ“ Inning ${inn + 1} Complete</div>
        <p style="color:#cbd5e1; font-size:14px; margin:16px 0; text-align:center;">
          <strong style="color:#fff; font-size:16px;">BOTH HALVES COMPLETE</strong><br><br>
          Top: ${topOuts}/3 outs<br>
          Bottom: ${bottomOuts}/3 outs<br><br>
          Move to the next inning.
        </p>
        <button class="modal-btn ok" onclick="closeModal()">Got It</button>
      </div>
    </div>`;
}


function checkFiveRunLimit(inn) {
  // If we've reached 5 runs and haven't already shown the message for this inning
  if (state.bbcRuns[inn] >= 5 && !state.fiveRunLimitReached && inn < INNINGS - 1) {
    state.fiveRunLimitReached = true; // Prevent multiple alerts
    
    setTimeout(() => {
      // Flash message
      const msg = document.createElement('div');
      msg.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#22c55e; color:#1e293b; padding:20px 40px; border-radius:12px; font-size:18px; font-weight:800; z-index:10000; box-shadow:0 8px 24px rgba(0,0,0,0.5);';
      msg.textContent = `ðŸŽ¯ 5 RUN LIMIT â€” INNING ${inn + 1} OVER`;
      document.body.appendChild(msg);
      
      setTimeout(() => {
        msg.remove();
        state.fiveRunLimitReached = false; // Reset for next inning
        
        // Find the next batter who's up in the next inning
        const nextInn = inn + 1;
        
        // CORRECT FIX: Find where previous inning ended, then continue from there
        let startingBatter = 0;
        
        if (inn > 0) {
          // Find last batter in PREVIOUS inning
          for (let r = state.players.length - 1; r >= 0; r--) {
            if (state.players[r].innings[inn - 1].result) {
              startingBatter = r + 1;
              if (startingBatter >= state.players.length) startingBatter = 0;
              console.log(`DEBUG: Previous inning (${inn}) ended with player ${r}, so inning ${inn + 1} started with player ${startingBatter}`);
              break;
            }
          }
        }
        
        // Now find the LAST batter in the CURRENT inning, starting from startingBatter
        console.log(`DEBUG: Checking who batted in current inning ${inn + 1} (index ${inn}):`);
        
        let lastBatterRow = -1;
        let foundAnyBatter = false;
        
        // Check from startingBatter to end of lineup
        for (let r = startingBatter; r < state.players.length; r++) {
          if (state.players[r].innings[inn].result) {
            console.log(`  - Player ${r} (${state.players[r].name}): ${state.players[r].innings[inn].result}`);
            lastBatterRow = r;
            foundAnyBatter = true;
          }
        }
        
        // Then check from 0 to startingBatter (wrap-around)
        for (let r = 0; r < startingBatter; r++) {
          if (state.players[r].innings[inn].result) {
            console.log(`  - Player ${r} (${state.players[r].name}): ${state.players[r].innings[inn].result}`);
            lastBatterRow = r;
            foundAnyBatter = true;
          }
        }
        
        if (!foundAnyBatter) {
          // Fallback - just use simple logic
          for (let r = 0; r < state.players.length; r++) {
            if (state.players[r].innings[inn].result) {
              lastBatterRow = r;
            }
          }
        }
        
        console.log(`DEBUG: Last batter in inning ${inn + 1} was row ${lastBatterRow} (${state.players[lastBatterRow]?.name})`);
        
        // Next batter is the one after the last batter
        let nextBatterRow = lastBatterRow + 1;
        
        // Wrap around if needed
        if (nextBatterRow >= state.players.length) {
          nextBatterRow = 0;
          console.log(`DEBUG: Wrapped around to player 0`);
        }
        
        console.log(`DEBUG: Next batter should be row ${nextBatterRow} (${state.players[nextBatterRow]?.name})`);
        console.log(`5-run limit in Inning ${inn + 1}. Last batter: ${state.players[lastBatterRow]?.name || lastBatterRow}. Next up in Inning ${nextInn + 1}: ${state.players[nextBatterRow]?.name || nextBatterRow}`);
        
        // Scroll horizontally to the next inning column
        const gridWrap = document.querySelector('.grid-wrap');
        if (gridWrap) {
          // Calculate the scroll position for the next inning
          // Each inning column is approximately 85px wide (70px + gaps)
          const scrollAmount = nextInn * 85;
          gridWrap.scrollTo({
            left: scrollAmount,
            behavior: 'smooth'
          });
        }
        
        // Re-render grid and highlight next batter
        renderGrid();
        
        // Flash the next batter's row briefly and automatically open modal for next batter
        setTimeout(() => {
          const rows = document.querySelectorAll('.grid > div');
          const targetRowIndex = nextBatterRow + 1; // +1 for header row
          if (rows[targetRowIndex]) {
            rows[targetRowIndex].style.animation = 'highlight-pulse 1.5s ease-in-out';
          }
          
          // Automatically open the next batter modal (shows all options)
          setTimeout(() => {
            openNextBatterModal(nextBatterRow, nextInn);
          }, 500);
        }, 100);
      }, 1200);
      
      console.log(`5-run limit reached in inning ${inn + 1}. Auto-advancing to inning ${inn + 2}!`);
    }, 500);
  }
}

function recalcBBCWalks(inn) {
  // Count walks (BB) in this inning
  state.bbcWalks[inn] = state.players.reduce((sum, p) => sum + (p.innings[inn].result === "BB" ? 1 : 0), 0);
}

function newGame() {
  state = emptyState();
  // Load saved roster into the new game
  if (savedRoster.length > 0) {
    state.players = savedRoster.map(name => emptyPlayer(name));
  }
  save(); render();
}

function addInning() {
  INNINGS++;
  state.innings = INNINGS;
  
  // Add new inning data to all arrays
  state.outs.push(0);
  state.bbcRuns.push(0);
  state.oppRuns.push(0);
  state.oppOuts.push(0);
  state.bbcWalks.push(0); // Add walks tracking
  
  // Add new inning to each player
  state.players.forEach(player => {
    player.innings.push({ result: "", bases: [], run: false, rbi: 0, runnerOut: false });
  });
  
  save();
  render();
}

function removeInning() {
  // Don't allow removing if only 1 inning left
  if (INNINGS <= 1) {
    alert("Cannot remove the last inning! At least 1 inning is required.");
    return;
  }
  
  // Confirm before removing
  if (!confirm(`Remove inning ${INNINGS}? This will delete all data for this inning.`)) {
    return;
  }
  
  INNINGS--;
  state.innings = INNINGS;
  
  // Remove last inning data from all arrays
  state.outs.pop();
  state.bbcRuns.pop();
  state.oppRuns.pop();
  state.oppOuts.pop();
  state.bbcWalks.pop(); // Remove walks tracking
  
  // Remove last inning from each player
  state.players.forEach(player => {
    player.innings.pop();
  });
  
  save();
  render();
}

// ---- MODALS ----
function closeModal() { document.getElementById("modal-container").innerHTML = ''; }

function openNextBatterModal(row, inn) {
  const playerName = state.players[row]?.name || `Player ${row + 1}`;
  
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title" style="background:#7c3aed; color:#fff;">âš¾ ${playerName} - Inning ${inn + 1}</div>
        <p style="color:#cbd5e1; font-size:14px; margin:16px 0; text-align:center; font-weight:600;">
          What happened in this at-bat?
        </p>
        <button class="modal-btn" style="background:#ef4444; border-color:#7f1d1d;" onclick="closeModal(); openOutModal(${row}, ${inn});">OUT</button>
        <button class="modal-btn" style="background:#22c55e; border-color:#14532d;" onclick="closeModal(); openHitModal(${row}, ${inn});">HIT</button>
        <button class="modal-btn" style="background:#3b82f6; border-color:#1e3a8a;" onclick="closeModal(); openOthModal(${row}, ${inn});">OTH</button>
        <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
}

function openOutModal(row, inn) {
  // Check if inning is already complete
  if (isInningComplete(inn)) {
    showInningCompleteMessage(inn);
    return;
  }
  
  const options = [
    { val:"SO", label:"SO (Strikeout)" },
    { val:"GO", label:"GO (Groundout)" },
    { val:"FO", label:"FO (Fly Out)" },
    { val:"FC", label:"FC (Fielder's Choice)" },
    { val:"DP", label:"DP (Double Play)" },
    { val:"TP", label:"TP (Triple Play)" }
  ];
  
  let btns = options.map(o => {
    let onclick;
    if (o.val === "FC") {
      onclick = `setResult(${row},${inn},'FC'); openFCModal(${row},${inn});`;
    } else if (o.val === "DP" || o.val === "TP") {
      onclick = `setResult(${row},${inn},'${o.val}'); openMultipleOutsModal(${row},${inn},'${o.val}');`;
    } else if (o.val === "SO") {
      // Strikeout: just record the out, don't open bases modal (no contact made)
      onclick = `setResult(${row},${inn},'SO'); closeModal();`;
    } else {
      // Auto-open bases modal after contact outs (GO, FO) to set out location
      onclick = `setResult(${row},${inn},'${o.val}'); openBasesModal(${row},${inn});`;
    }
    return `<button class="modal-btn" onclick="${onclick}">${o.label}</button>`;
  }).join('');
  
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">Record out</div>
        ${btns}
        <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
}

function openHitModal(row, inn) {
  // Check if inning is already complete
  if (isInningComplete(inn)) {
    showInningCompleteMessage(inn);
    return;
  }
  
  // Check if team has hit their HR limit (configurable)
  const bbcHR = state.bbcHomeRuns;
  const oppHR = state.oppHomeRuns;
  const hrLimit = state.hrLimit || 2; // Default to 2 if not set
  const canHitHR = (hrLimit >= 99) || (bbcHR < hrLimit) || (oppHR >= hrLimit && bbcHR === oppHR + 1);
  
  let hrWarning = '';
  if (!canHitHR) {
    hrWarning = `<div style="background:#7f1d1d; color:#fca5a5; padding:8px; border-radius:6px; margin-bottom:10px; font-size:11px; text-align:center; font-weight:700;">âš ï¸ HR LIMIT (${hrLimit}) REACHED - Next HR = OUT</div>`;
  }
  
  const options = [
    { val:"1B", label:"1B (Single)" },
    { val:"2B", label:"2B (Double)" },
    { val:"3B", label:"3B (Triple)" },
    { val:"HR", label:"HR (Home Run)" + (!canHitHR ? " â†’ BECOMES OUT" : "") }
  ];
  
  let btns = options.map(o => {
    const onclick = (o.val === "HR" && !canHitHR) 
      ? `setResult(${row},${inn},'HRO'); openBasesModal(${row},${inn});` // Auto-open bases after HRO
      : `setResult(${row},${inn},'${o.val}'); openBasesModal(${row},${inn});`; // Auto-open bases after hit
    return `<button class="modal-btn" onclick="${onclick}">${o.label}</button>`;
  }).join('');
  
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">Type of hit</div>
        ${hrWarning}
        ${btns}
        <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
}

function openOthModal(row, inn) {
  // Check if inning is already complete
  if (isInningComplete(inn)) {
    showInningCompleteMessage(inn);
    return;
  }
  
  showPickModal("Other", [
    { val:"BB",  label:"BB (Walk)" },
    { val:"SAC", label:"SAC (Sacrifice)", usesModal: true },
    { val:"ROE", label:"ROE (Reach on Error)" }
  ], row, inn);
}

function showPickModal(title, options, row, inn) {
  let btns = options.map(o => {
    if (o.usesModal) {
      return `<button class="modal-btn" onclick="closeModal(); setResult(${row},${inn},'${o.val}'); openSACModal(${row},${inn});">${o.label}</button>`;
    } else {
      // Auto-open bases modal after BB and ROE
      return `<button class="modal-btn" onclick="setResult(${row},${inn},'${o.val}'); openBasesModal(${row},${inn});">${o.label}</button>`;
    }
  }).join('');
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">${title}</div>
        ${btns}
        <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
}

function openBasesModal(row, inn) {
  // Get correct player array based on tracking mode
  const currentPlayers = state.trackingMode === 'opponent' ? state.oppPlayers : state.players;
  
  const current = currentPlayers[row].innings[inn].bases || [];
  const currentResult = currentPlayers[row].innings[inn].result || "";
  const hitLocation = currentPlayers[row].innings[inn].hitLocation || "";
  const outLocation = currentPlayers[row].innings[inn].outLocation || "";
  
  // Check if batter got out
  const isOut = ["SO", "GO", "FO", "FC", "E", "HRO", "DP", "TP", "SAC"].includes(currentResult);
  const isHit = ["1B", "2B", "3B", "HR"].includes(currentResult);
  const playerName = currentPlayers[row].name || `Player ${row + 1}`;
  
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column;">
        <div class="modal-title">${playerName} - ${currentResult || 'Base Runner'} Tracking</div>
        
        <div style="flex: 1; overflow-y: auto;">
        
        <!-- Visual Baseball Diamond -->
        <div style="position: relative; width: 280px; height: 280px; margin: 20px auto; background: var(--bg-card); border-radius: var(--radius-md); padding: 20px;">
          <!-- Diamond -->
          <svg viewBox="0 0 200 200" style="width: 100%; height: 100%;">
            <!-- Infield -->
            <polygon points="100,20 180,100 100,180 20,100" fill="#2d5016" stroke="#4ade80" stroke-width="2"/>
            
            <!-- Bases -->
            <rect x="95" y="15" width="10" height="10" fill="#f1f5f9" id="base-home-vis" style="cursor: pointer;" onclick="toggleBaseVisual('home')"/>
            <rect x="175" y="95" width="10" height="10" fill="#94a3b8" id="base-1st-vis" style="cursor: pointer;" onclick="toggleBaseVisual('1st')"/>
            <rect x="95" y="175" width="10" height="10" fill="#94a3b8" id="base-2nd-vis" style="cursor: pointer;" onclick="toggleBaseVisual('2nd')"/>
            <rect x="15" y="95" width="10" height="10" fill="#94a3b8" id="base-3rd-vis" style="cursor: pointer;" onclick="toggleBaseVisual('3rd')"/>
            
            <!-- Base Labels -->
            <text x="100" y="12" text-anchor="middle" fill="#f1f5f9" font-size="10">H</text>
            <text x="192" y="103" text-anchor="middle" fill="#f1f5f9" font-size="10">1</text>
            <text x="100" y="198" text-anchor="middle" fill="#f1f5f9" font-size="10">2</text>
            <text x="8" y="103" text-anchor="middle" fill="#f1f5f9" font-size="10">3</text>
          </svg>
          <div style="text-align: center; color: #94a3b8; font-size: 11px; margin-top: 8px;">Click bases to select</div>
        </div>
        
        ${isHit ? `
        <!-- Hit Location -->
        <div style="margin: 20px 0;">
          <div style="color: #f1f5f9; font-size: 13px; font-weight: 600; margin-bottom: 8px;">Hit Location - Click Anywhere on Field:</div>
          
          <!-- Visual Baseball Field - Fully Clickable -->
          <div style="position: relative; width: 350px; height: 350px; margin: 0 auto; background: #1a3a1a; border-radius: 12px; border: 3px solid #4ade80; overflow: hidden;">
            <canvas id="baseball-field-canvas" width="350" height="350" style="display: block; cursor: crosshair;"></canvas>
          </div>
          
          <div style="text-align: center; color: #94a3b8; font-size: 11px; margin-top: 8px;">
            <span id="hit-location-display">
              ${hitLocation ? `Hit marked at: ${hitLocation}` : 'Click anywhere on the field to mark where the ball was hit'}
            </span>
          </div>
        </div>
        
        <!-- Hit Quality -->
        <div style="margin: 20px 0;">
          <div style="color: #f1f5f9; font-size: 13px; font-weight: 600; margin-bottom: 8px;">Hit Quality:</div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
            <button class="quality-btn ${currentPlayers[row].innings[inn].hitQuality === 'soft' ? 'selected' : ''}" onclick="selectHitQuality('soft')">ðŸ’¨ Soft</button>
            <button class="quality-btn ${currentPlayers[row].innings[inn].hitQuality === 'medium' ? 'selected' : ''}" onclick="selectHitQuality('medium')">âš¾ Medium</button>
            <button class="quality-btn ${currentPlayers[row].innings[inn].hitQuality === 'hard' ? 'selected' : ''}" onclick="selectHitQuality('hard')">ðŸ’¥ Hard</button>
          </div>
        </div>
        
        <!-- Hit Trajectory -->
        <div style="margin: 20px 0;">
          <div style="color: #f1f5f9; font-size: 13px; font-weight: 600; margin-bottom: 8px;">Hit Trajectory:</div>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px;">
            <button class="quality-btn ${currentPlayers[row].innings[inn].hitTrajectory === 'grounder' ? 'selected' : ''}" onclick="selectHitTrajectory('grounder')">âš¾ Grounder</button>
            <button class="quality-btn ${currentPlayers[row].innings[inn].hitTrajectory === 'line-drive' ? 'selected' : ''}" onclick="selectHitTrajectory('line-drive')">âž¡ï¸ Line Drive</button>
            <button class="quality-btn ${currentPlayers[row].innings[inn].hitTrajectory === 'fly-ball' ? 'selected' : ''}" onclick="selectHitTrajectory('fly-ball')">ðŸŒ™ Fly Ball</button>
            <button class="quality-btn ${currentPlayers[row].innings[inn].hitTrajectory === 'pop-up' ? 'selected' : ''}" onclick="selectHitTrajectory('pop-up')">â˜ï¸ Pop Up</button>
          </div>
        </div>
        ` : ''}
        
        ${isOut ? `
        <!-- Out Location -->
        <div style="margin: 20px 0;">
          <div style="color: #f1f5f9; font-size: 13px; font-weight: 600; margin-bottom: 8px;">Out Location - Click Where Ball Was Hit/Fielded:</div>
          
          <!-- Visual Baseball Field - Fully Clickable for Outs -->
          <div style="position: relative; width: 350px; height: 350px; margin: 0 auto; background: #1a3a1a; border-radius: 12px; border: 3px solid #ef4444; overflow: hidden;">
            <canvas id="baseball-field-canvas-out" width="350" height="350" style="display: block; cursor: crosshair;"></canvas>
          </div>
          
          <div style="text-align: center; color: #94a3b8; font-size: 11px; margin-top: 8px;">
            <span id="out-location-display">
              ${outLocation ? `Out marked at: ${outLocation}` : 'Click anywhere on the field to mark where the ball was hit/fielded'}
            </span>
          </div>
        </div>
        
        ${currentResult !== 'SO' ? `
        <!-- Out Quality (for contact outs only - not strikeouts) -->
        <div style="margin: 20px 0;">
          <div style="color: #f1f5f9; font-size: 13px; font-weight: 600; margin-bottom: 8px;">Contact Quality:</div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
            <button class="quality-btn ${currentPlayers[row].innings[inn].hitQuality === 'soft' ? 'selected' : ''}" onclick="selectHitQuality('soft')">ðŸ’¨ Soft</button>
            <button class="quality-btn ${currentPlayers[row].innings[inn].hitQuality === 'medium' ? 'selected' : ''}" onclick="selectHitQuality('medium')">âš¾ Medium</button>
            <button class="quality-btn ${currentPlayers[row].innings[inn].hitQuality === 'hard' ? 'selected' : ''}" onclick="selectHitQuality('hard')">ðŸ’¥ Hard</button>
          </div>
        </div>
        
        <!-- Out Trajectory -->
        <div style="margin: 20px 0;">
          <div style="color: #f1f5f9; font-size: 13px; font-weight: 600; margin-bottom: 8px;">Ball Trajectory:</div>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px;">
            <button class="quality-btn ${currentPlayers[row].innings[inn].hitTrajectory === 'grounder' ? 'selected' : ''}" onclick="selectHitTrajectory('grounder')">âš¾ Grounder</button>
            <button class="quality-btn ${currentPlayers[row].innings[inn].hitTrajectory === 'line-drive' ? 'selected' : ''}" onclick="selectHitTrajectory('line-drive')">âž¡ï¸ Line Drive</button>
            <button class="quality-btn ${currentPlayers[row].innings[inn].hitTrajectory === 'fly-ball' ? 'selected' : ''}" onclick="selectHitTrajectory('fly-ball')">ðŸŒ™ Fly Ball</button>
            <button class="quality-btn ${currentPlayers[row].innings[inn].hitTrajectory === 'pop-up' ? 'selected' : ''}" onclick="selectHitTrajectory('pop-up')">â˜ï¸ Pop Up</button>
          </div>
        </div>
        ` : ''}
        ` : ''}
        
        </div><!-- End scrollable content -->
        
        <div class="modal-btn-row" style="margin-top: 16px; flex-shrink: 0;">
          <button class="modal-btn ok" onclick="saveBasesEnhanced(${row},${inn})">Save</button>
          <button class="modal-btn cancel2" onclick="closeModal()">Cancel</button>
        </div>
        
        <style>
          .location-btn {
            background: #334155;
            border: 2px solid #475569;
            border-radius: 6px;
            color: #e2e8f0;
            padding: 8px 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Barlow', sans-serif;
          }
          .location-btn:hover {
            background: #475569;
            border-color: #64748b;
          }
          .location-btn.selected {
            background: #22c55e;
            border-color: #16a34a;
            color: #1e293b;
            font-weight: 700;
          }
          .field-position {
            transition: all 0.3s;
          }
          .field-position:hover {
            fill: #475569;
            stroke-width: 3;
          }
          .field-position.field-selected {
            fill: #22c55e;
            stroke: #16a34a;
            stroke-width: 4;
          }
          .quality-btn {
            background: #334155;
            border: 2px solid #475569;
            border-radius: 6px;
            color: #e2e8f0;
            padding: 10px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
          }
          .quality-btn:hover {
            background: #475569;
            border-color: #64748b;
            transform: translateY(-1px);
          }
          .quality-btn.selected {
            background: #3b82f6;
            border-color: #1d4ed8;
            color: #fff;
            font-weight: 700;
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.5);
          }
        </style>
      </div>
    </div>`;
  
  // Initialize visual bases
  setTimeout(() => {
    // Initialize selectedBases array with current bases
    window.selectedBases = current ? [...current] : [];
    
    // Initialize hit/out locations
    window.selectedHitLocation = hitLocation || "";
    window.selectedOutLocation = outLocation || "";
    
    // Initialize hit quality and trajectory
    const currentPlayers = state.trackingMode === 'opponent' ? state.oppPlayers : state.players;
    window.selectedHitQuality = currentPlayers[row].innings[inn].hitQuality || "";
    window.selectedHitTrajectory = currentPlayers[row].innings[inn].hitTrajectory || "";
    
    current.forEach(base => {
      const elem = document.getElementById(`base-${base}-vis`);
      if (elem) elem.setAttribute('fill', '#22c55e');
    });
    
    // Initialize baseball field canvas for hits
    const canvas = document.getElementById('baseball-field-canvas');
    if (canvas) {
      initializeBaseballFieldCanvas(canvas, hitLocation, 'hit');
    }
    
    // Initialize baseball field canvas for outs
    const canvasOut = document.getElementById('baseball-field-canvas-out');
    if (canvasOut) {
      initializeBaseballFieldCanvas(canvasOut, outLocation, 'out');
    }
  }, 10);
}

// Initialize the clickable baseball field canvas
function initializeBaseballFieldCanvas(canvas, existingLocation, type) {
  const ctx = canvas.getContext('2d');
  const width = canvas.width;
  const height = canvas.height;
  
  // Store click coordinates
  let hitX = null;
  let hitY = null;
  
  // Parse existing location if it exists (stored as "x,y")
  if (existingLocation && existingLocation.includes(',')) {
    const coords = existingLocation.split(',');
    hitX = parseInt(coords[0]);
    hitY = parseInt(coords[1]);
  }
  
  function drawField() {
    // Clear canvas
    ctx.clearRect(0, 0, width, height);
    
    // Draw outfield (dark green circle)
    ctx.fillStyle = '#1e4620';
    ctx.beginPath();
    ctx.arc(175, 310, 170, 0, Math.PI * 2);
    ctx.fill();
    
    // Draw infield dirt (diamond)
    ctx.fillStyle = '#8b7355';
    ctx.beginPath();
    ctx.moveTo(175, 310); // Home
    ctx.lineTo(280, 205); // 1st
    ctx.lineTo(175, 100); // 2nd
    ctx.lineTo(70, 205);  // 3rd
    ctx.closePath();
    ctx.fill();
    
    // Draw grass (lighter green) - infield grass
    ctx.fillStyle = '#2d5016';
    ctx.beginPath();
    ctx.arc(175, 310, 140, 0, Math.PI * 2);
    ctx.fill();
    
    // Redraw infield dirt (smaller)
    ctx.fillStyle = '#8b7355';
    ctx.beginPath();
    ctx.moveTo(175, 310);
    ctx.lineTo(265, 220);
    ctx.lineTo(175, 130);
    ctx.lineTo(85, 220);
    ctx.closePath();
    ctx.fill();
    
    // Draw foul lines
    ctx.strokeStyle = 'rgba(241, 245, 249, 0.4)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(175, 310);
    ctx.lineTo(10, 10);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(175, 310);
    ctx.lineTo(340, 10);
    ctx.stroke();
    
    // Draw bases
    const baseSize = 8;
    ctx.fillStyle = '#f1f5f9';
    // Home plate
    ctx.fillRect(175 - baseSize/2, 310 - baseSize/2, baseSize, baseSize);
    // 1st base
    ctx.fillRect(280 - baseSize/2, 205 - baseSize/2, baseSize, baseSize);
    // 2nd base
    ctx.fillRect(175 - baseSize/2, 100 - baseSize/2, baseSize, baseSize);
    // 3rd base
    ctx.fillRect(70 - baseSize/2, 205 - baseSize/2, baseSize, baseSize);
    
    // Draw position labels
    ctx.fillStyle = '#f1f5f9';
    ctx.font = 'bold 11px monospace';
    ctx.textAlign = 'center';
    
    // Outfield positions
    ctx.fillText('LF', 60, 70);
    ctx.fillText('CF', 175, 40);
    ctx.fillText('RF', 290, 70);
    
    // Infield positions
    ctx.fillText('SS', 120, 180);
    ctx.fillText('2B', 175, 150);
    ctx.fillText('1B', 230, 180);
    ctx.fillText('3B', 120, 240);
    ctx.fillText('P', 175, 210);
    ctx.fillText('C', 175, 280);
    
    // Draw hit/out marker if exists
    if (hitX !== null && hitY !== null) {
      if (type === 'hit') {
        // Green circle for hits
        ctx.fillStyle = '#22c55e';
        ctx.beginPath();
        ctx.arc(hitX, hitY, 8, 0, Math.PI * 2);
        ctx.fill();
        
        // Yellow ring around it
        ctx.strokeStyle = '#fbbf24';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(hitX, hitY, 12, 0, Math.PI * 2);
        ctx.stroke();
      } else {
        // Red circle for outs
        ctx.fillStyle = '#ef4444';
        ctx.beginPath();
        ctx.arc(hitX, hitY, 8, 0, Math.PI * 2);
        ctx.fill();
        
        // Orange ring around it
        ctx.strokeStyle = '#f97316';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(hitX, hitY, 12, 0, Math.PI * 2);
        ctx.stroke();
      }
    }
  }
  
  // Handle canvas clicks
  canvas.addEventListener('click', function(e) {
    const rect = canvas.getBoundingClientRect();
    hitX = e.clientX - rect.left;
    hitY = e.clientY - rect.top;
    
    // Store coordinates based on type
    const locationString = `${Math.round(hitX)},${Math.round(hitY)}`;
    
    if (type === 'hit') {
      window.selectedHitLocation = locationString;
      const displayElem = document.getElementById('hit-location-display');
      if (displayElem) {
        displayElem.textContent = `Hit marked! Click Save to confirm.`;
      }
    } else {
      window.selectedOutLocation = locationString;
      const displayElem = document.getElementById('out-location-display');
      if (displayElem) {
        displayElem.textContent = `Out location marked! Click Save to confirm.`;
      }
    }
    
    // Redraw field with new marker
    drawField();
  });
  
  // Initial draw
  drawField();
}

// Global variables for modal state
window.selectedBases = [];
window.selectedHitLocation = "";
window.selectedOutLocation = "";
window.selectedHitQuality = "";
window.selectedHitTrajectory = "";

function selectHitQuality(quality) {
  window.selectedHitQuality = quality;
  // Update button states - only remove selected from quality buttons in the same group
  const parentDiv = event.target.parentElement;
  parentDiv.querySelectorAll('.quality-btn').forEach(btn => {
    btn.classList.remove('selected');
  });
  event.target.classList.add('selected');
}

function selectHitTrajectory(trajectory) {
  window.selectedHitTrajectory = trajectory;
  // Update button states - only remove selected from trajectory buttons in the same group
  const parentDiv = event.target.parentElement;
  parentDiv.querySelectorAll('.quality-btn').forEach(btn => {
    btn.classList.remove('selected');
  });
  event.target.classList.add('selected');
}

function toggleBaseVisual(base) {
  const elem = document.getElementById(`base-${base}-vis`);
  if (!elem) return;
  
  if (!window.selectedBases) window.selectedBases = [];
  
  const index = window.selectedBases.indexOf(base);
  if (index > -1) {
    // Remove base
    window.selectedBases.splice(index, 1);
    elem.setAttribute('fill', base === 'home' ? '#f1f5f9' : '#94a3b8');
  } else {
    // Add base
    window.selectedBases.push(base);
    elem.setAttribute('fill', '#22c55e');
  }
}

function selectHitLocation(location) {
  window.selectedHitLocation = location;
  // Update button states
  document.querySelectorAll('.location-btn').forEach(btn => {
    btn.classList.remove('selected');
  });
  event.target.classList.add('selected');
}

function selectOutLocation(location) {
  window.selectedOutLocation = location;
  // Update button states
  document.querySelectorAll('.location-btn').forEach(btn => {
    btn.classList.remove('selected');
  });
  event.target.classList.add('selected');
}

function saveBasesEnhanced(row, inn) {
  // Get correct player array based on tracking mode
  const currentPlayers = state.trackingMode === 'opponent' ? state.oppPlayers : state.players;
  
  // Get current inning data
  const innings = currentPlayers[row].innings[inn];
  
  // Save bases (filter out 'home')
  const bases = (window.selectedBases || []).filter(b => b !== 'home');
  innings.bases = bases.map(b => b); // Convert to array
  
  // Initialize if first time
  if (!innings.bases) innings.bases = [];
  
  // Map visual base names to storage format
  const basesFormatted = [];
  if (window.selectedBases.includes('1st')) basesFormatted.push('1st');
  if (window.selectedBases.includes('2nd')) basesFormatted.push('2nd');
  if (window.selectedBases.includes('3rd')) basesFormatted.push('3rd');
  
  innings.bases = basesFormatted;
  
  // Save hit location if applicable
  if (window.selectedHitLocation) {
    innings.hitLocation = window.selectedHitLocation;
  }
  
  // Save out location if applicable
  if (window.selectedOutLocation) {
    innings.outLocation = window.selectedOutLocation;
  }
  
  // Save hit quality if selected
  if (window.selectedHitQuality) {
    innings.hitQuality = window.selectedHitQuality;
  }
  
  // Save hit trajectory if selected
  if (window.selectedHitTrajectory) {
    innings.hitTrajectory = window.selectedHitTrajectory;
  }
  
  // Reset global state
  window.selectedBases = [];
  window.selectedHitLocation = "";
  window.selectedOutLocation = "";
  window.selectedHitQuality = "";
  window.selectedHitTrajectory = "";
  
  save();
  closeModal();
  renderGrid();
}

function saveBases(row, inn) {
  state.players[row].innings[inn].bases = ["1st","2nd","3rd"].filter(b => document.getElementById("base-"+b).checked);
  save(); closeModal(); renderGrid();
}

function openFCModal(row, inn) {
  // Find runners on base (previous batters in this inning who reached base)
  let runnersOnBase = [];
  for (let r = 0; r < state.players.length; r++) {
    if (r === row) continue; // Skip current batter
    const runnerInning = state.players[r].innings[inn];
    if (runnerInning.result && runnerInning.bases && runnerInning.bases.length > 0 && !runnerInning.run && !runnerInning.runnerOut) {
      runnersOnBase.push({ row: r, name: state.players[r].name || `Player ${r+1}`, bases: runnerInning.bases });
    }
  }
  
  // Store in global for the save function
  window.tempFCRunners = runnersOnBase;
  window.tempFCBatter = { row, inn };
  
  if (runnersOnBase.length === 0) {
    // No runners found - just close
    document.getElementById("modal-container").innerHTML = `
      <div class="modal-overlay" onclick="closeModal()">
        <div class="modal" onclick="event.stopPropagation()">
          <div class="modal-title">Fielder's Choice</div>
          <p style="color:#cbd5e1; font-size:13px; margin:12px 0;">No base runners found. The batter reached base safely.</p>
          <button class="modal-btn ok" onclick="closeModal()">OK</button>
        </div>
      </div>`;
    return;
  }
  
  let runnerButtons = runnersOnBase.map((runner, idx) => {
    const basesList = runner.bases.join(", ");
    return `<button class="modal-btn" onclick="saveFCRunner(${idx})">${runner.name} (on ${basesList}) was put out</button>`;
  }).join("");
  
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">Fielder's Choice - Who was out?</div>
        <p style="color:#cbd5e1; font-size:13px; margin:12px 0;">Select which runner was put out (batter reached base safely):</p>
        ${runnerButtons}
        <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
}

function saveFCRunner(runnerIdx) {
  const runnersOnBase = window.tempFCRunners || [];
  const batter = window.tempFCBatter || {};
  
  if (runnerIdx >= 0 && runnerIdx < runnersOnBase.length) {
    const runner = runnersOnBase[runnerIdx];
    
    // Mark the runner as out
    state.players[runner.row].innings[batter.inn].runnerOut = true;
    state.players[runner.row].innings[batter.inn].bases = [];
    
    // Store which runner was out for the FC note
    state.players[batter.row].innings[batter.inn].fcRemovedRunner = runner.row;
    state.players[batter.row].innings[batter.inn].fcNote = `${runner.name} out`;
  }
  
  save();
  closeModal();
  renderGrid();
  
  // Clean up
  delete window.tempFCRunners;
  delete window.tempFCBatter;
}

function openSACModal(row, inn) {
  // Find runners on base (previous batters in this inning who reached base)
  let runnersOnBase = [];
  for (let r = 0; r < state.players.length; r++) {
    if (r === row) continue; // Skip current batter (who is out on sacrifice)
    const runnerInning = state.players[r].innings[inn];
    if (runnerInning.result && runnerInning.bases && runnerInning.bases.length > 0 && !runnerInning.run && !runnerInning.runnerOut) {
      runnersOnBase.push({ row: r, name: state.players[r].name || `Player ${r+1}`, bases: runnerInning.bases });
    }
  }
  
  // Store in global for the save function
  window.tempSACRunners = runnersOnBase;
  window.tempSACBatter = { row, inn };
  
  if (runnersOnBase.length === 0) {
    // No runners found - just close
    document.getElementById("modal-container").innerHTML = `
      <div class="modal-overlay" onclick="closeModal()">
        <div class="modal" onclick="event.stopPropagation()">
          <div class="modal-title">Sacrifice</div>
          <p style="color:#cbd5e1; font-size:13px; margin:12px 0;">No base runners found. Sacrifice recorded but no runs scored.</p>
          <button class="modal-btn ok" onclick="closeModal()">OK</button>
        </div>
      </div>`;
    return;
  }
  
  let runnerButtons = runnersOnBase.map((runner, idx) => {
    const basesList = runner.bases.join(", ");
    return `<button class="modal-btn" onclick="saveSACRunner(${idx})">${runner.name} (on ${basesList}) scored</button>`;
  }).join("");
  
  // Add "No one scored" option
  runnerButtons += `<button class="modal-btn cancel" onclick="saveSACRunner(-1)">No one scored</button>`;
  
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">Sacrifice - Who scored?</div>
        <p style="color:#cbd5e1; font-size:13px; margin:12px 0;">Select which runner scored on the sacrifice (batter is out):</p>
        ${runnerButtons}
        <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
}

function saveSACRunner(runnerIdx) {
  const runnersOnBase = window.tempSACRunners || [];
  const batter = window.tempSACBatter || {};
  
  if (runnerIdx >= 0 && runnerIdx < runnersOnBase.length) {
    const runner = runnersOnBase[runnerIdx];
    
    // Mark the runner as scored
    state.players[runner.row].innings[batter.inn].run = true;
    state.players[runner.row].innings[batter.inn].bases = [];
    
    // Give batter an RBI for driving in the run
    state.players[batter.row].innings[batter.inn].rbi = (state.players[batter.row].innings[batter.inn].rbi || 0) + 1;
    
    // Store note on sacrifice
    state.players[batter.row].innings[batter.inn].sacNote = `${runner.name} scored`;
    
    console.log(`SAC: ${state.players[batter.row].name} gets 1 RBI for scoring ${runner.name}`);
    
    // Recalculate runs for this inning
    recalcBBCRuns(batter.inn);
  }
  // If runnerIdx is -1, no one scored - just close
  
  save();
  closeModal();
  renderGrid();
  renderScoreboard();
  
  // Clean up
  delete window.tempSACRunners;
  delete window.tempSACBatter;
}


function openMultipleOutsModal(row, inn, playType) {
  const numOuts = playType === "DP" ? 2 : 3;
  const playName = playType === "DP" ? "Double Play" : "Triple Play";
  
  // Find runners on base (previous batters in this inning who reached base)
  let runnersOnBase = [];
  for (let r = 0; r < state.players.length; r++) {
    if (r === row) continue; // Skip current batter
    const runnerInning = state.players[r].innings[inn];
    if (runnerInning.result && runnerInning.bases && runnerInning.bases.length > 0 && !runnerInning.run && !runnerInning.runnerOut) {
      runnersOnBase.push({ row: r, name: state.players[r].name || `Player ${r+1}`, bases: runnerInning.bases });
    }
  }
  
  // Store in global for the save function
  window.tempRunnersOnBase = runnersOnBase;
  window.tempDPBatter = { row, inn, playType };
  
  if (runnersOnBase.length === 0) {
    // No runners found - just close
    document.getElementById("modal-container").innerHTML = `
      <div class="modal-overlay" onclick="closeModal()">
        <div class="modal" onclick="event.stopPropagation()">
          <div class="modal-title">${playName} Recorded</div>
          <p style="color:#cbd5e1; font-size:13px; margin:12px 0;">No base runners found to mark as out. The batter is automatically counted as out.</p>
          <button class="modal-btn ok" onclick="closeModal()">OK</button>
        </div>
      </div>`;
    return;
  }
  
  // Show current runners
  let runnerInfo = runnersOnBase.map((runner, idx) => {
    const basesList = runner.bases.map(b => b === '1st' ? '1B' : b === '2nd' ? '2B' : '3B').join(', ');
    return `<div style="color:#cbd5e1; font-size:12px; margin:4px 0;" id="runner-info-${idx}">â€¢ ${runner.name} on ${basesList}</div>`;
  }).join("");
  
  // Base selection buttons
  const outsNeeded = playType === "DP" ? "2 outs" : "3 outs";
  
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">${playName} - Who got out?</div>
        <p style="color:#cbd5e1; font-size:13px; margin:12px 0;">${outsNeeded} total - Select all who got out:</p>
        <div style="background:var(--bg-raise); padding:10px; border-radius:var(--radius-sm); margin:10px 0; border:1px solid var(--border);">
          <div style="color:#94a3b8; font-size:11px; margin-bottom:6px;">Current situation:</div>
          ${runnerInfo}
        </div>
        <p style="color:#f59e0b; font-size:12px; margin:8px 0;">Who got out?</p>
        <div style="display:flex; flex-direction:column; gap:8px; margin:12px 0;">
          <label class="modal-check-label" style="background:#1e293b; padding:10px; border-radius:6px;">
            <input type="checkbox" id="batter-out" checked />
            <span style="font-weight:700; color:#f59e0b;">Batter got out</span>
          </label>
        </div>
        <p style="color:#94a3b8; font-size:11px; margin:8px 0;">Select runner(s) who got out:</p>
        <div id="runner-checkboxes" style="display:flex; flex-direction:column; gap:8px; margin:12px 0;">
          ${runnersOnBase.map((runner, idx) => {
            const basesList = runner.bases.map(b => b === '1st' ? '1B' : b === '2nd' ? '2B' : '3B').join(', ');
            return `
              <label class="modal-check-label" style="background:#1e293b; padding:10px; border-radius:6px;">
                <input type="checkbox" id="runner-out-${idx}" />
                <span>${runner.name} (on ${basesList})</span>
              </label>`;
          }).join("")}
        </div>
        <div class="modal-btn-row">
          <button class="modal-btn ok" onclick="saveMultipleOutsBySelection()">Save</button>
          <button class="modal-btn cancel2" onclick="closeModal()">Cancel</button>
        </div>
      </div>
    </div>`;
}

function saveMultipleOutsBySelection() {
  const runnersOnBase = window.tempRunnersOnBase || [];
  const batter = window.tempDPBatter || {};
  
  const batterOut = document.getElementById('batter-out')?.checked;
  
  // First, mark selected runners as out
  runnersOnBase.forEach((runner, idx) => {
    const checkbox = document.getElementById(`runner-out-${idx}`);
    if (checkbox && checkbox.checked) {
      // Mark this runner as out
      state.players[runner.row].innings[batter.inn].runnerOut = true;
      state.players[runner.row].innings[batter.inn].bases = [];
    } else {
      // Runner survived - they may need to advance if they were forced
      // For now, keep them on their current base
      // The auto-advance logic will handle them on the next hit
      // But we should advance them one base if they were forced to run
      
      // If runner was on 1st and batter put ball in play, they're forced to 2nd
      if (runner.bases.includes('1st') && batterOut) {
        // Runner was forced to advance
        const currentHighest = Math.max(...runner.bases.map(b => 
          b === '1st' ? 1 : b === '2nd' ? 2 : 3
        ));
        if (currentHighest === 1) {
          state.players[runner.row].innings[batter.inn].bases = ['1st', '2nd'];
        }
      }
    }
  });
  
  // Handle batter
  if (!batterOut) {
    // Batter reached base (probably on FC or error)
    state.players[batter.row].innings[batter.inn].bases = ["1st"];
  }
  // If batter is out, bases remain empty (already set by setResult)
  
  save();
  closeModal();
  renderGrid();
  
  // Clean up
  delete window.tempRunnersOnBase;
  delete window.tempDPBatter;
}

function saveMultipleOutsByBase() {
  const runnersOnBase = window.tempRunnersOnBase || [];
  const batter = window.tempDPBatter || {};
  
  // Get selected bases where outs occurred
  const outsAt = [];
  if (document.getElementById('out-at-1st')?.checked) outsAt.push('1st');
  if (document.getElementById('out-at-2nd')?.checked) outsAt.push('2nd');
  if (document.getElementById('out-at-3rd')?.checked) outsAt.push('3rd');
  if (document.getElementById('out-at-home')?.checked) outsAt.push('home');
  
  // Match runners to the bases where outs occurred
  runnersOnBase.forEach(runner => {
    // Check if this runner was on a base where an out occurred
    const wasOnOutBase = runner.bases.some(base => {
      // Runner on 1st and out at 2nd? They were running to 2nd
      if (base === '1st' && outsAt.includes('2nd')) return true;
      // Runner on 2nd and out at 3rd? They were running to 3rd
      if (base === '2nd' && outsAt.includes('3rd')) return true;
      // Runner on 3rd and out at home? They were running home
      if (base === '3rd' && outsAt.includes('home')) return true;
      // Force out at same base (runner on 1st, out at 1st)
      if (base === '1st' && outsAt.includes('1st')) return true;
      if (base === '2nd' && outsAt.includes('2nd')) return true;
      if (base === '3rd' && outsAt.includes('3rd')) return true;
      return false;
    });
    
    if (wasOnOutBase) {
      // Mark this runner as out
      state.players[runner.row].innings[batter.inn].runnerOut = true;
      state.players[runner.row].innings[batter.inn].bases = [];
    }
  });
  
  // Store which bases had outs for display
  if (outsAt.length > 0) {
    state.players[batter.row].innings[batter.inn].dpBases = outsAt;
  }
  
  save();
  closeModal();
  renderGrid();
  
  // Clean up
  delete window.tempRunnersOnBase;
  delete window.tempDPBatter;
}

function saveMultipleOuts(row, inn, playType) {
  // Legacy function - redirect to new base selection
  saveMultipleOutsByBase();
}



// Helper: Check if a runner from a previous at-bat is still on base (not removed by FC, DP, or TP)
function isRunnerActive(runnerRow, inn, upToBatterRow) {
  const runnerInning = state.players[runnerRow].innings[inn];
  
  // Did this runner reach base?
  if (!runnerInning.result || runnerInning.bases.length === 0) {
    return false;
  }
  
  // Check if runner was marked as out (by FC, DP, or TP)
  if (runnerInning.runnerOut) {
    return false;
  }
  
  // Check if any FC after this runner (but before upToBatterRow) removed them
  // Need to handle wrap-around case where upToBatterRow < runnerRow
  
  if (upToBatterRow > runnerRow) {
    // Normal case: check from runnerRow+1 to upToBatterRow-1
    for (let checkRow = runnerRow + 1; checkRow < upToBatterRow; checkRow++) {
      const checkInning = state.players[checkRow].innings[inn];
      if (checkInning.result === "FC" && checkInning.fcRemovedRunner === runnerRow) {
        return false; // This runner was put out on a FC
      }
    }
  } else {
    // Wrap-around case: check from runnerRow+1 to end, then from 0 to upToBatterRow-1
    // First, check from runnerRow+1 to end of lineup
    for (let checkRow = runnerRow + 1; checkRow < state.players.length; checkRow++) {
      const checkInning = state.players[checkRow].innings[inn];
      if (checkInning.result === "FC" && checkInning.fcRemovedRunner === runnerRow) {
        return false;
      }
    }
    // Then, check from 0 to upToBatterRow-1
    for (let checkRow = 0; checkRow < upToBatterRow; checkRow++) {
      const checkInning = state.players[checkRow].innings[inn];
      if (checkInning.result === "FC" && checkInning.fcRemovedRunner === runnerRow) {
        return false;
      }
    }
  }
  
  return true; // Runner is still active
}

function saveFCNote(row, inn, note, base) {
  state.players[row].innings[inn].fcNote = note;
  
  // Mark the base where the out occurred
  if (base) {
    const bases = state.players[row].innings[inn].bases;
    if (!bases.includes(base)) {
      bases.push(base);
    }
    
    // Figure out which previous runner was forced out at this base
    // Go backwards from current batter, find who reached base and would've advanced to this base
    for (let prevRow = row - 1; prevRow >= 0; prevRow--) {
      const prevInning = state.players[prevRow].innings[inn];
      if (prevInning.result && prevInning.bases.length > 0) {
        // This runner reached base â€” they're the one who got out on the force
        state.players[row].innings[inn].fcRemovedRunner = prevRow;
        break;
      }
    }
  }
  
  save();
  closeModal();
  renderGrid();
}

function openRBIModal(row, inn) {
  const current = state.players[row].innings[inn].rbi || 0;
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">How many RBIs?</div>
        <div style="display:flex; align-items:center; gap:12px; justify-content:center; margin:20px 0;">
          <button class="ctrl-btn" onclick="changeRBI(${row},${inn},-1)" style="font-size:20px;">âˆ’</button>
          <div id="rbi-value" style="font-size:24px; font-weight:700; min-width:40px; text-align:center;">${current}</div>
          <button class="ctrl-btn" onclick="changeRBI(${row},${inn},1)" style="font-size:20px;">+</button>
        </div>
        <div style="margin-top:16px;">
          <label style="display:block; color:#cbd5e1; font-size:12px; margin-bottom:4px;">Base advancement (e.g., 1-3 or 2-H):</label>
          <input type="text" id="base-advancement" value="${state.players[row].innings[inn].basesAdvanced || ""}" 
                 placeholder="1-3, 2-H, etc." 
                 style="width:100%; padding:8px; border-radius:4px; border:1px solid #334155; background:#1e293b; color:#f1f5f9; font-family:inherit;"/>
        </div>
        <div class="modal-btn-row">
          <button class="modal-btn ok" onclick="saveRBI(${row},${inn})">OK</button>
          <button class="modal-btn cancel2" onclick="closeModal()">Cancel</button>
        </div>
      </div>
    </div>`;
}

function changeRBI(row, inn, delta) {
  const current = state.players[row].innings[inn].rbi || 0;
  const newVal = Math.max(0, current + delta);
  state.players[row].innings[inn].rbi = newVal;
  document.getElementById("rbi-value").textContent = newVal;
}

function saveRBI(row, inn) {
  const advancement = document.getElementById("base-advancement").value.trim();
  state.players[row].innings[inn].basesAdvanced = advancement;
  
  // Auto-update runs for this inning based on RBIs
  recalcBBCRuns(inn);
  
  save(); 
  closeModal(); 
  renderGrid();
  renderScoreboard(); // Update scoreboard to show new runs
}


// ---- PDF EXPORT ----
function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l', 'pt', 'letter'); // landscape, points, letter size
  
  const bbcTotal = state.bbcRuns.reduce((a,b) => a+b, 0);
  const oppTotal = state.oppRuns.reduce((a,b) => a+b, 0);
  
  let y = 40;
  
  // Add logo
  const logoImg = new Image();
  logoImg.crossOrigin = "anonymous";
  logoImg.src = "data:image/png;base64,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AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//2Q==";
  
  logoImg.onload = function() {
    const logoWidth = 60;
    const logoHeight = 60;
    // Logo on the far left
    doc.addImage(logoImg, 'PNG', 50, y - 5, logoWidth, logoHeight);
    
    // Title centered
    doc.setFontSize(22);
    doc.setFont(undefined, 'bold');
    doc.text("MLS Dome Ball Scoresheet", 400, y + 20, { align: 'center' });
    y += 60;
    
    generatePDFContent();
  };
  
  logoImg.onerror = function() {
    // If logo fails to load, just show title centered
    doc.setFontSize(22);
    doc.setFont(undefined, 'bold');
    doc.text("MLS Dome Ball Scoresheet", 400, y + 20, { align: 'center' });
    y += 50;
    generatePDFContent();
  };
  
  function generatePDFContent() {
    let x = 50;
    
    // Game info
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    if (state.opponent) {
      const opponentText = state.gameNumber 
        ? `vs ${state.opponent} - Game ${state.gameNumber}`
        : `vs ${state.opponent}`;
      doc.text(opponentText, 400, y, { align: 'center' });
      y += 15;
    }
    if (state.date) {
      const dateObj = new Date(state.date + 'T00:00:00');
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      const formattedDate = dateObj.toLocaleDateString('en-US', options);
      doc.text(formattedDate, 400, y, { align: 'center' });
      y += 20;
    } else {
      doc.setTextColor(150, 150, 150);
      doc.text("Date: _____________", 400, y, { align: 'center' });
      doc.setTextColor(0, 0, 0);
      y += 20;
    }
    y += 5;

    // Game result
    if (state.gameResult) {
      const resultLabels = { W: "Result: WIN", L: "Result: LOSS", T: "Result: TIE" };
      doc.setFontSize(13);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(
        state.gameResult === 'W' ? 0   : state.gameResult === 'L' ? 180 : 100,
        state.gameResult === 'W' ? 140 : state.gameResult === 'L' ? 60  : 100,
        state.gameResult === 'W' ? 0   : state.gameResult === 'L' ? 60  : 100
      );
      doc.text(resultLabels[state.gameResult], 400, y, { align: 'center' });
      doc.setTextColor(0, 0, 0);
      doc.setFont(undefined, 'normal');
      y += 18;
    }
    y += 5;
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text("SCOREBOARD", 50, y);
    y += 15;
    
    const cellW = 30;
    const labelW = 130;
    
    // Header row
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text("", 50, y);
    x = 50 + labelW;
    for (let i = 0; i < INNINGS; i++) {
      doc.text(String(i+1), x + cellW/2, y, { align: 'center' });
      x += cellW;
    }
    doc.text("TOT", x + 20, y, { align: 'center' });
    y += 15;
    
    // BBC row
    doc.setFontSize(11);
    x = 50;
    doc.text(state.myTeam || "Backyard Baseball Club", x, y);
    x += labelW;
    for (let i = 0; i < INNINGS; i++) {
      doc.text(String(state.bbcRuns[i]), x + cellW/2, y, { align: 'center' });
      x += cellW;
    }
    doc.setFont(undefined, 'bold');
    doc.text(String(bbcTotal), x + 20, y, { align: 'center' });
    doc.setFont(undefined, 'normal');
    y += 15;
    
    // Opponent row
    x = 50;
    doc.text(state.opponent || "Opponent", x, y);
    x += labelW;
    for (let i = 0; i < INNINGS; i++) {
      doc.text(String(state.oppRuns[i]), x + cellW/2, y, { align: 'center' });
      x += cellW;
    }
    doc.setFont(undefined, 'bold');
    doc.text(String(oppTotal), x + 20, y, { align: 'center' });
    doc.setFont(undefined, 'normal');
    y += 25;
    
    // BBC Outs
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text("OUTS", 50, y);
    y += 15;
    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');
    x = 50 + labelW;
    for (let i = 0; i < INNINGS; i++) {
      doc.text(String(state.outs[i]), x + cellW/2, y, { align: 'center' });
      x += cellW;
    }
    y += 25;
    
    // Batting table
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text((state.myTeam || "BACKYARD BASEBALL CLUB").toUpperCase() + " BATTING", 50, y);
    y += 15;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    
    const tableStartX = 50;
    const tableStartY = y;
    const rowHeight = 20;
    const nameColWidth = 130;
    const inningColWidth = 26;
    const statsColWidth  = 100;
    const avgColWidth   = 80;
    const tableWidth = nameColWidth + (INNINGS * inningColWidth) + statsColWidth + avgColWidth;

    // â”€â”€ Header row â”€â”€
    doc.setFillColor(240, 240, 240);
    doc.rect(tableStartX, y - 10, tableWidth, rowHeight, 'F');
    doc.setDrawColor(100, 100, 100);
    doc.rect(tableStartX, y - 10, tableWidth, rowHeight);

    x = tableStartX;
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text("Player", x + 5, y);
    x += nameColWidth;

    for (let i = 0; i < INNINGS; i++) {
      doc.line(x, y - 10, x, y + rowHeight - 10);
      doc.text(`Inn ${i+1}`, x + inningColWidth / 2, y, { align: 'center' });
      x += inningColWidth;
    }

    // H / AB / R / RBI header
    doc.line(x, y - 10, x, y + rowHeight - 10);
    doc.setFontSize(9);
    doc.text("H / AB / R / RBI", x + statsColWidth / 2, y + 1, { align: 'center' });
    x += statsColWidth;

    // AVG / XBH header
    doc.line(x, y - 10, x, y + rowHeight - 10);
    doc.text("AVG / XBH / BB", x + avgColWidth / 2, y + 1, { align: 'center' });
    x += avgColWidth;
    doc.line(x, y - 10, x, y + rowHeight - 10);

    doc.setFont(undefined, 'normal');
    doc.setFontSize(10);
    y += rowHeight - 10;

    // â”€â”€ Player rows â”€â”€
    state.players.forEach((player, idx) => {
      if (y > 540) {
        doc.addPage();
        y = 40;
      }

      const st   = calcStats(player);
      const rowY = y;

      // row border
      doc.setDrawColor(200, 200, 200);
      doc.rect(tableStartX, rowY, tableWidth, rowHeight);

      // vertical centre baseline for text inside this row
      const textY = rowY + 13;

      // Player name
      doc.setFontSize(10);
      x = tableStartX;
      doc.text(`${idx + 1}. ${player.name || '(empty)'}`, x + 5, textY);
      x += nameColWidth;

      // Inning columns
      doc.line(x, rowY, x, rowY + rowHeight);
      for (let i = 0; i < INNINGS; i++) {
        const inn = player.innings[i];
        if (inn.result) {
          doc.setFontSize(10);
          doc.text(inn.result, x + inningColWidth / 2, textY, { align: 'center' });
          if (inn.run) {
            doc.setFontSize(7);
            doc.text("R", x + inningColWidth - 3, rowY + 5);
            doc.setFontSize(10);
          }
        }
        x += inningColWidth;
        doc.line(x, rowY, x, rowY + rowHeight);
      }

      // H / AB / R / RBI column
      doc.setFontSize(9);
      doc.text(`${st.H} / ${st.AB} / ${st.R} / ${st.RBI}`, x + statsColWidth / 2, textY, { align: 'center' });
      x += statsColWidth;
      doc.line(x, rowY, x, rowY + rowHeight);

      // AVG / XBH / BB column
      doc.text(`${st.AVG} / ${st.XBH} / ${st.BB}`, x + avgColWidth / 2, textY, { align: 'center' });
      doc.setFontSize(10);

      y += rowHeight;
    });
    
    // â”€â”€ STATISTICS LEGEND â€“ vertical column to the right of the table â”€â”€
    const legendX = tableStartX + tableWidth + 20;  // 20 pt gap after table
    let legendY   = tableStartY - 10;               // align top with table header

    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text("STATISTICS LEGEND", legendX, legendY + 8);
    legendY += 16;

    doc.setFont(undefined, 'normal');
    const legendItems = [
      "GP: Games Played",
      "AB: At Bats",
      "R: Runs",
      "H: Hits",
      "2B: Doubles",
      "3B: Triples",
      "HR: Home Runs",
      "HRO: Home Run Out",
      "RBI: Runs Batted In",
      "BB: Walks",
      "SO: Strikeouts",
      "GO: Groundouts",
      "FO: Fly Outs",
      "SF: Sacrifice Flies",
      "ROE: Reach on Error",
      "AVG: Batting Average",
      "OBP: On Base Percentage",
      "SLG: Slugging Percentage",
      "XBH: Extra Base Hits"
    ];

    legendItems.forEach(item => {
      doc.text(item, legendX, legendY);
      legendY += 13;
    });
    
    // ===== ADD SPRAY CHART PAGE =====
    // Collect all hit/out locations
    const sprayData = [];
    state.players.forEach((player, pIdx) => {
      player.innings.forEach((inn, innIdx) => {
        // Collect hits
        if (inn.hitLocation && ["1B", "2B", "3B", "HR"].includes(inn.result)) {
          sprayData.push({
            player: player.name || `Player ${pIdx + 1}`,
            result: inn.result,
            location: inn.hitLocation,
            type: 'hit'
          });
        }
        // Collect outs with locations
        if (inn.outLocation && ["SO", "GO", "FO", "FC", "E", "HRO", "DP", "TP", "SAC"].includes(inn.result)) {
          sprayData.push({
            player: player.name || `Player ${pIdx + 1}`,
            result: inn.result,
            location: inn.outLocation,
            type: 'out'
          });
        }
      });
    });
    
    // Only add spray chart page if there's data
    if (sprayData.length > 0) {
      // Add new page for spray chart
      doc.addPage();
      
      // Title - use actual team name
      const myTeamName = state.myTeam || "My Team";
      doc.setFontSize(18);
      doc.setFont(undefined, 'bold');
      doc.text(`${myTeamName.toUpperCase()} - SPRAY CHART`, 400, 40, { align: 'center' });
      
      doc.setFontSize(12);
      doc.setFont(undefined, 'normal');
      const hitCount = sprayData.filter(d => d.type === 'hit').length;
      const outCount = sprayData.filter(d => d.type === 'out').length;
      doc.text(`Hits: ${hitCount} | Outs: ${outCount} | Total: ${sprayData.length}`, 400, 60, { align: 'center' });
      
      // Create temporary canvas to draw spray chart
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = 700;
      tempCanvas.height = 700;
      
      // Draw spray chart on canvas
      drawSprayChartForPDF(tempCanvas, sprayData);
      
      // Add canvas as image to PDF
      const sprayChartImage = tempCanvas.toDataURL('image/png');
      doc.addImage(sprayChartImage, 'PNG', 50, 80, 500, 500);
      
      // Add legend
      doc.setFontSize(10);
      doc.setFont(undefined, 'bold');
      doc.text("Legend:", 570, 100);
      doc.setFont(undefined, 'normal');
      
      doc.setTextColor(34, 197, 94); // Green
      doc.text("* Hits", 570, 120);
      
      doc.setTextColor(239, 68, 68); // Red
      doc.text("* Outs", 570, 140);
      
      doc.setTextColor(0, 0, 0); // Reset to black
      doc.text("Size = frequency", 570, 160);
    }
    
    // ===== ADD OPPONENT SPRAY CHART PAGE =====
    // Collect opponent hit/out locations
    const oppSprayData = [];
    if (state.oppPlayers) {
      state.oppPlayers.forEach((player, pIdx) => {
        player.innings.forEach((inn, innIdx) => {
          // Collect hits
          if (inn.hitLocation && ["1B", "2B", "3B", "HR"].includes(inn.result)) {
            oppSprayData.push({
              player: player.name || `Opp ${pIdx + 1}`,
              result: inn.result,
              location: inn.hitLocation,
              type: 'hit'
            });
          }
          // Collect outs with locations
          if (inn.outLocation && ["SO", "GO", "FO", "FC", "E", "HRO", "DP", "TP", "SAC"].includes(inn.result)) {
            oppSprayData.push({
              player: player.name || `Opp ${pIdx + 1}`,
              result: inn.result,
              location: inn.outLocation,
              type: 'out'
            });
          }
        });
      });
    }
    
    // Only add opponent spray chart page if there's data
    if (oppSprayData.length > 0) {
      // Add new page for opponent spray chart
      doc.addPage();
      
      // Title
      doc.setFontSize(18);
      doc.setFont(undefined, 'bold');
      const oppTeamName = state.opponent || "Opponent";
      doc.text(`${oppTeamName.toUpperCase()} - SPRAY CHART`, 400, 40, { align: 'center' });
      
      doc.setFontSize(12);
      doc.setFont(undefined, 'normal');
      const oppHitCount = oppSprayData.filter(d => d.type === 'hit').length;
      const oppOutCount = oppSprayData.filter(d => d.type === 'out').length;
      doc.text(`Hits: ${oppHitCount} | Outs: ${oppOutCount} | Total: ${oppSprayData.length}`, 400, 60, { align: 'center' });
      
      // Create temporary canvas to draw opponent spray chart
      const oppTempCanvas = document.createElement('canvas');
      oppTempCanvas.width = 700;
      oppTempCanvas.height = 700;
      
      // Draw opponent spray chart on canvas
      drawSprayChartForPDF(oppTempCanvas, oppSprayData);
      
      // Add canvas as image to PDF
      const oppSprayChartImage = oppTempCanvas.toDataURL('image/png');
      doc.addImage(oppSprayChartImage, 'PNG', 50, 80, 500, 500);
      
      // Add legend
      doc.setFontSize(10);
      doc.setFont(undefined, 'bold');
      doc.text("Legend:", 570, 100);
      doc.setFont(undefined, 'normal');
      
      doc.setTextColor(34, 197, 94); // Green
      doc.text("* Hits", 570, 120);
      
      doc.setTextColor(239, 68, 68); // Red
      doc.text("* Outs", 570, 140);
      
      doc.setTextColor(0, 0, 0); // Reset to black
      doc.text("Size = frequency", 570, 160);
      
      doc.setFontSize(9);
      doc.setTextColor(100, 100, 100); // Gray
      doc.text("Use this chart to plan", 570, 190);
      doc.text("defensive positioning", 570, 205);
      doc.text("for next game!", 570, 220);
      doc.setTextColor(0, 0, 0); // Reset
    }
    
    // Save
    let filename = 'scoresheet';
    if (state.opponent) filename += `_${state.opponent.replace(/\s+/g, '_')}`;
    if (state.gameNumber) filename += `_game${state.gameNumber}`;
    if (state.date) filename += `_${state.date}`;
    filename += '.pdf';
    doc.save(filename);
  }
}

// ---- EXCEL EXPORT ----
function exportExcel() {
  // Create workbook
  const wb = XLSX.utils.book_new();
  
  // Sheet 1: Player Statistics
  const playerStats = [];
  
  // Header row
  playerStats.push([
    'Player',
    'H', 'AB', 'R', 'RBI',
    'AVG', 'OBP', 'SLG', 'XBH',
    '1B', '2B', '3B', 'HR',
    'BB', 'SAC', 'SO', 'FO', 'FC', 'E'
  ]);
  
  // Player rows
  state.players.forEach((player, idx) => {
    if (!player.name) return; // Skip empty players
    
    const st = calcStats(player);
    
    // Count each hit type
    const singles = player.innings.filter(i => i.result === "1B").length;
    const doubles = player.innings.filter(i => i.result === "2B").length;
    const triples = player.innings.filter(i => i.result === "3B").length;
    const HR = player.innings.filter(i => i.result === "HR").length;
    const BB = player.innings.filter(i => i.result === "BB").length;
    const SAC = player.innings.filter(i => i.result === "SAC").length;
    const SO = player.innings.filter(i => i.result === "SO").length;
    const FO = player.innings.filter(i => i.result === "FO").length;
    const FC = player.innings.filter(i => i.result === "FC").length;
    const E = player.innings.filter(i => i.result === "E").length;
    
    playerStats.push([
      player.name,
      st.H, st.AB, st.R, st.RBI,
      parseFloat(st.AVG.toFixed(3)),
      parseFloat(st.OBP.toFixed(3)),
      parseFloat(st.SLG.toFixed(3)),
      st.XBH,
      singles, doubles, triples, HR,
      BB, SAC, SO, FO, FC, E
    ]);
  });
  
  const ws1 = XLSX.utils.aoa_to_sheet(playerStats);
  XLSX.utils.book_append_sheet(wb, ws1, "Player Stats");
  
  // Sheet 2: Game Summary
  const gameSummary = [];
  gameSummary.push(['Game Information']);
  gameSummary.push(['My Team', state.myTeam || 'Backyard Baseball Club']);
  gameSummary.push(['Opponent', state.opponent || 'Opponent']);
  gameSummary.push(['Date', state.date || '']);
  gameSummary.push(['Game Number', state.gameNumber || '']);
  gameSummary.push(['Result', state.gameResult || '']);
  gameSummary.push([]);
  
  const bbcTotal = state.bbcRuns.reduce((a,b) => a+b, 0);
  const oppTotal = state.oppRuns.reduce((a,b) => a+b, 0);
  
  gameSummary.push(['Final Score']);
  gameSummary.push([state.myTeam || 'BBC', bbcTotal]);
  gameSummary.push([state.opponent || 'Opponent', oppTotal]);
  gameSummary.push([]);
  
  gameSummary.push(['Home Runs']);
  gameSummary.push([state.myTeam || 'BBC', state.bbcHomeRuns || 0]);
  gameSummary.push([state.opponent || 'Opponent', state.oppHomeRuns || 0]);
  
  const ws2 = XLSX.utils.aoa_to_sheet(gameSummary);
  XLSX.utils.book_append_sheet(wb, ws2, "Game Summary");
  
  // Sheet 3: Inning by Inning
  const inningData = [];
  
  // Header
  const header = ['Player'];
  for (let i = 0; i < state.innings; i++) {
    header.push(`Inn ${i+1}`);
  }
  header.push('Stats');
  inningData.push(header);
  
  // Player rows
  state.players.forEach((player, idx) => {
    if (!player.name) return;
    const row = [player.name];
    
    for (let i = 0; i < state.innings; i++) {
      const inn = player.innings[i];
      let cellText = inn.result || '';
      if (inn.run) cellText += ' R';
      if (inn.rbi) cellText += ` ${inn.rbi}RBI`;
      row.push(cellText);
    }
    
    const st = calcStats(player);
    row.push(`${st.H}/${st.AB}/${st.R}/${st.RBI}`);
    inningData.push(row);
  });
  
  inningData.push([]);
  
  // Runs by inning
  const runsHeader = ['Team'];
  for (let i = 0; i < state.innings; i++) {
    runsHeader.push(`Inn ${i+1}`);
  }
  runsHeader.push('Total');
  inningData.push(runsHeader);
  
  const bbcRunsRow = [state.myTeam || 'BBC'];
  state.bbcRuns.forEach(r => bbcRunsRow.push(r));
  bbcRunsRow.push(bbcTotal);
  inningData.push(bbcRunsRow);
  
  const oppRunsRow = [state.opponent || 'Opponent'];
  state.oppRuns.forEach(r => oppRunsRow.push(r));
  oppRunsRow.push(oppTotal);
  inningData.push(oppRunsRow);
  
  const ws3 = XLSX.utils.aoa_to_sheet(inningData);
  XLSX.utils.book_append_sheet(wb, ws3, "Inning by Inning");
  
  // Generate filename
  let filename = 'scoresheet';
  if (state.opponent) filename += `_${state.opponent.replace(/\s+/g, '_')}`;
  if (state.gameNumber) filename += `_game${state.gameNumber}`;
  if (state.date) filename += `_${state.date}`;
  filename += '.xlsx';
  
  // Download
  XLSX.writeFile(wb, filename);
}

// ---- EMBEDDED SEASON STATS TRACKER ----
// Stores cumulative season stats in localStorage and exports to Excel

function getSeasonStats() {
  try {
    const saved = localStorage.getItem("mls-season-stats");
    if (saved) {
      return JSON.parse(saved);
    }
  } catch(e) {
    console.error('Error loading season stats:', e);
  }
  
  // Return initial stats from your existing file
  // These will be used the first time, then updated stats will be saved to localStorage
  return {
    "ABBY": {
      "name": "ABBY",
      "GP": 2,
      "AB": 6,
      "R": 0,
      "H": 2,
      "singles": 1,
      "doubles": 1,
      "triples": 0,
      "HR": 0,
      "RBI": 5,
      "BB": 1,
      "SAC": 0,
      "SO": 3,
      "E": 0
    },
    "ACKSHAN": {
      "name": "ACKSHAN",
      "GP": 2,
      "AB": 7,
      "R": 0,
      "H": 6,
      "singles": 5,
      "doubles": 1,
      "triples": 0,
      "HR": 0,
      "RBI": 2,
      "BB": 0,
      "SAC": 0,
      "SO": 1,
      "E": 0
    },
    "SEALY": {
      "name": "SEALY",
      "GP": 2,
      "AB": 7,
      "R": 0,
      "H": 5,
      "singles": 4,
      "doubles": 1,
      "triples": 0,
      "HR": 0,
      "RBI": 4,
      "BB": 0,
      "SAC": 0,
      "SO": 3,
      "E": 0
    },
    "MILLS": {
      "name": "MILLS",
      "GP": 2,
      "AB": 6,
      "R": 0,
      "H": 2,
      "singles": 1,
      "doubles": 0,
      "triples": 0,
      "HR": 1,
      "RBI": 3,
      "BB": 0,
      "SAC": 0,
      "SO": 2,
      "E": 0
    },
    "MILOAN": {
      "name": "MILOAN",
      "GP": 2,
      "AB": 7,
      "R": 0,
      "H": 5,
      "singles": 2,
      "doubles": 2,
      "triples": 0,
      "HR": 1,
      "RBI": 1,
      "BB": 0,
      "SAC": 0,
      "SO": 1,
      "E": 0
    },
    "JANAHAN": {
      "name": "JANAHAN",
      "GP": 2,
      "AB": 7,
      "R": 0,
      "H": 3,
      "singles": 3,
      "doubles": 0,
      "triples": 0,
      "HR": 0,
      "RBI": 1,
      "BB": 1,
      "SAC": 0,
      "SO": 0,
      "E": 0
    },
    "AHIL": {
      "name": "AHIL",
      "GP": 2,
      "AB": 5,
      "R": 0,
      "H": 4,
      "singles": 2,
      "doubles": 2,
      "triples": 0,
      "HR": 0,
      "RBI": 3,
      "BB": 0,
      "SAC": 0,
      "SO": 1,
      "E": 0
    },
    "JESSEY": {
      "name": "JESSEY",
      "GP": 2,
      "AB": 6,
      "R": 0,
      "H": 5,
      "singles": 3,
      "doubles": 2,
      "triples": 0,
      "HR": 0,
      "RBI": 2,
      "BB": 0,
      "SAC": 0,
      "SO": 2,
      "E": 0
    },
    "SHAWN": {
      "name": "Shawn",
      "GP": 0,
      "AB": 0,
      "R": 0,
      "H": 0,
      "singles": 0,
      "doubles": 0,
      "triples": 0,
      "HR": 0,
      "RBI": 0,
      "BB": 0,
      "SAC": 0,
      "SO": 0,
      "E": 0
    },
    "JHANAN": {
      "name": "JHANAN",
      "GP": 2,
      "AB": 6,
      "R": 0,
      "H": 2,
      "singles": 2,
      "doubles": 0,
      "triples": 0,
      "HR": 0,
      "RBI": 3,
      "BB": 0,
      "SAC": 0,
      "SO": 2,
      "E": 0
    },
    "LAVAN": {
      "name": "LAVAN",
      "GP": 2,
      "AB": 1,
      "R": 0,
      "H": 0,
      "singles": 0,
      "doubles": 0,
      "triples": 0,
      "HR": 0,
      "RBI": 2,
      "BB": 4,
      "SAC": 0,
      "SO": 1,
      "E": 0
    },
    "KEVIN": {
      "name": "KEVIN",
      "GP": 2,
      "AB": 3,
      "R": 0,
      "H": 0,
      "singles": 0,
      "doubles": 0,
      "triples": 0,
      "HR": 0,
      "RBI": 2,
      "BB": 1,
      "SAC": 0,
      "SO": 3,
      "E": 0
    }
  };
}

function saveSeasonStats(stats) {
  try {
    localStorage.setItem("mls-season-stats", JSON.stringify(stats));
  } catch(e) {
    console.error('Error saving season stats:', e);
  }
}

function updateSeasonStats() {
  // Get current season stats
  const seasonStats = getSeasonStats();
  
  // Process each player from the current game
  state.players.forEach((player, idx) => {
    if (!player.name) return; // Skip empty players
    
    const playerKey = player.name.toUpperCase();
    const st = calcStats(player);
    
    // Count each hit type
    const singles = player.innings.filter(i => i.result === "1B").length;
    const doubles = player.innings.filter(i => i.result === "2B").length;
    const triples = player.innings.filter(i => i.result === "3B").length;
    const HR = player.innings.filter(i => i.result === "HR").length;
    const BB = player.innings.filter(i => i.result === "BB").length;
    const SAC = player.innings.filter(i => i.result === "SAC").length;
    const SO = player.innings.filter(i => i.result === "SO").length;
    const E = player.innings.filter(i => i.result === "E").length;
    
    // Initialize player if new
    if (!seasonStats[playerKey]) {
      seasonStats[playerKey] = {
        name: player.name,
        GP: 0, AB: 0, R: 0, H: 0,
        singles: 0, doubles: 0, triples: 0, HR: 0,
        RBI: 0, BB: 0, SAC: 0, SO: 0, E: 0
      };
    }
    
    // Add current game stats
    seasonStats[playerKey].GP += 1;
    seasonStats[playerKey].AB += st.AB;
    seasonStats[playerKey].R += st.R;
    seasonStats[playerKey].H += st.H;
    seasonStats[playerKey].singles += singles;
    seasonStats[playerKey].doubles += doubles;
    seasonStats[playerKey].triples += triples;
    seasonStats[playerKey].HR += HR;
    seasonStats[playerKey].RBI += st.RBI;
    seasonStats[playerKey].BB += BB;
    seasonStats[playerKey].SAC += SAC;
    seasonStats[playerKey].SO += SO;
    seasonStats[playerKey].E += E;
  });
  
  // Save updated stats
  saveSeasonStats(seasonStats);
  
  // Export to Excel
  exportSeasonExcel(seasonStats);
  
  console.log('Season stats updated!', seasonStats);
}

function openSprayChartMenu() {
  const myTeamName = state.myTeam || "My Team";
  const oppTeamName = state.opponent || "Opponent";
  
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()" style="max-width: 400px;">
        <div class="modal-title">ðŸ“ Spray Chart</div>
        <div style="color: #94a3b8; font-size: 13px; margin-bottom: 20px; text-align: center;">
          Select which team's spray chart to view
        </div>
        
        <button class="modal-btn" onclick="viewSprayChart('myTeam')" style="background: #22c55e; border-color: #16a34a; margin-bottom: 12px;">
          ðŸ“ ${myTeamName} Spray Chart
        </button>
        
        <button class="modal-btn" onclick="viewSprayChart('opponent')" style="background: #3b82f6; border-color: #2563eb; margin-bottom: 12px;">
          ðŸ“ ${oppTeamName} Spray Chart
        </button>
        
        <button class="modal-btn" onclick="viewSprayChart('both')" style="background: #8b5cf6; border-color: #7c3aed; margin-bottom: 12px;">
          ðŸ“ ${myTeamName} vs ${oppTeamName}
        </button>
        
        <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
}

function viewSprayChart(team = 'myTeam') {
  // Determine which team's data to show
  let hitData = [];
  let teamName = "";
  
  if (team === 'myTeam') {
    teamName = state.myTeam || "My Team";
    teamName = `${teamName} Spray Chart`;
    state.players.forEach((player, pIdx) => {
      player.innings.forEach((inn, innIdx) => {
        // Collect hits
        if (inn.hitLocation && ["1B", "2B", "3B", "HR"].includes(inn.result)) {
          hitData.push({
            player: player.name || `Player ${pIdx + 1}`,
            inning: innIdx + 1,
            result: inn.result,
            location: inn.hitLocation,
            type: 'hit',
            team: 'myTeam',
            quality: inn.hitQuality || '',
            trajectory: inn.hitTrajectory || ''
          });
        }
        // Collect outs with locations
        if (inn.outLocation && ["SO", "GO", "FO", "FC", "E", "HRO", "DP", "TP", "SAC"].includes(inn.result)) {
          hitData.push({
            player: player.name || `Player ${pIdx + 1}`,
            inning: innIdx + 1,
            result: inn.result,
            location: inn.outLocation,
            type: 'out',
            team: 'myTeam',
            quality: inn.hitQuality || '',
            trajectory: inn.hitTrajectory || ''
          });
        }
      });
    });
  } else if (team === 'opponent') {
    teamName = `${state.opponent || "Opponent"} Spray Chart`;
    if (state.oppPlayers) {
      state.oppPlayers.forEach((player, pIdx) => {
        player.innings.forEach((inn, innIdx) => {
          // Collect hits
          if (inn.hitLocation && ["1B", "2B", "3B", "HR"].includes(inn.result)) {
            hitData.push({
              player: player.name || `Opp Player ${pIdx + 1}`,
              inning: innIdx + 1,
              result: inn.result,
              location: inn.hitLocation,
              type: 'hit',
              team: 'opponent',
              quality: inn.hitQuality || '',
              trajectory: inn.hitTrajectory || ''
            });
          }
          // Collect outs with locations
          if (inn.outLocation && ["SO", "GO", "FO", "FC", "E", "HRO", "DP", "TP", "SAC"].includes(inn.result)) {
            hitData.push({
              player: player.name || `Opp Player ${pIdx + 1}`,
              inning: innIdx + 1,
              result: inn.result,
              location: inn.outLocation,
              type: 'out',
              team: 'opponent',
              quality: inn.hitQuality || '',
              trajectory: inn.hitTrajectory || ''
            });
          }
        });
      });
    }
    
    // Check if we have opponent data
    if (hitData.length === 0) {
      alert(`No opponent data recorded yet!\n\nTo track opponent hits:\n1. Click the "Opponent" button at the top of the scoresheet\n2. Record their at-bats (the grid will show opponent players)\n3. Mark hit locations in the bases modal\n4. Then you can view their spray chart here!`);
      return;
    }
  } else if (team === 'both') {
    teamName = `${state.myTeam || "My Team"} vs ${state.opponent || "Opponent"}`;
    // Collect from my team
    state.players.forEach((player, pIdx) => {
      player.innings.forEach((inn, innIdx) => {
        if (inn.hitLocation && ["1B", "2B", "3B", "HR"].includes(inn.result)) {
          hitData.push({
            player: player.name || `Player ${pIdx + 1}`,
            inning: innIdx + 1,
            result: inn.result,
            location: inn.hitLocation,
            type: 'hit',
            team: 'myTeam'
          });
        }
        if (inn.outLocation && ["SO", "GO", "FO", "FC", "E", "HRO", "DP", "TP", "SAC"].includes(inn.result)) {
          hitData.push({
            player: player.name || `Player ${pIdx + 1}`,
            inning: innIdx + 1,
            result: inn.result,
            location: inn.outLocation,
            type: 'out',
            team: 'myTeam'
          });
        }
      });
    });
    
    // Collect from opponent
    if (state.oppPlayers) {
      state.oppPlayers.forEach((player, pIdx) => {
        player.innings.forEach((inn, innIdx) => {
          if (inn.hitLocation && ["1B", "2B", "3B", "HR"].includes(inn.result)) {
            hitData.push({
              player: player.name || `Opp ${pIdx + 1}`,
              inning: innIdx + 1,
              result: inn.result,
              location: inn.hitLocation,
              type: 'hit',
              team: 'opponent',
              quality: inn.hitQuality || '',
              trajectory: inn.hitTrajectory || ''
            });
          }
          if (inn.outLocation && ["SO", "GO", "FO", "FC", "E", "HRO", "DP", "TP", "SAC"].includes(inn.result)) {
            hitData.push({
              player: player.name || `Opp ${pIdx + 1}`,
              inning: innIdx + 1,
              result: inn.result,
              location: inn.outLocation,
              type: 'out',
              team: 'opponent',
              quality: inn.hitQuality || '',
              trajectory: inn.hitTrajectory || ''
            });
          }
        });
      });
    }
  }
  
  if (hitData.length === 0) {
    alert("No hit/out locations recorded yet! Record at-bats and mark locations in the 'bases' modal.");
    return;
  }
  
  // Calculate statistics
  const hits = hitData.filter(h => h.type === 'hit');
  const outs = hitData.filter(h => h.type === 'out');
  
  // Count by result type
  const singles = hits.filter(h => h.result === '1B').length;
  const doubles = hits.filter(h => h.result === '2B').length;
  const triples = hits.filter(h => h.result === '3B').length;
  const homers = hits.filter(h => h.result === 'HR').length;
  
  // Count by location
  const locationCounts = {};
  hitData.forEach(h => {
    locationCounts[h.location] = (locationCounts[h.location] || 0) + 1;
  });
  
  // Field zones based on coordinates (not position names)
  // For a 350x350 canvas: home is at (175, 310)
  // Left field: x < 115, Center: 115-235, Right: x > 235
  let pullSide = 0;
  let centerField = 0;
  let oppositeSide = 0;
  
  hitData.forEach(h => {
    if (h.location && h.location.includes(',')) {
      const coords = h.location.split(',');
      const x = parseFloat(coords[0]);
      const y = parseFloat(coords[1]);
      
      if (!isNaN(x) && !isNaN(y)) {
        // Determine zone based on x coordinate
        if (x < 115) {
          pullSide++; // Left field zone (pull for RH batter)
        } else if (x > 235) {
          oppositeSide++; // Right field zone (opposite for RH batter)
        } else {
          centerField++; // Center zone
        }
      }
    } else {
      // Fallback for old text-based locations
      if (['LF', '3B', 'SS'].includes(h.location)) pullSide++;
      else if (['CF', '2B', 'P'].includes(h.location)) centerField++;
      else if (['RF', '1B', 'C'].includes(h.location)) oppositeSide++;
    }
  });
  
  const totalWithLocation = pullSide + centerField + oppositeSide;
  const pullPct = totalWithLocation > 0 ? Math.round((pullSide / totalWithLocation) * 100) : 0;
  const centerPct = totalWithLocation > 0 ? Math.round((centerField / totalWithLocation) * 100) : 0;
  const oppPct = totalWithLocation > 0 ? Math.round((oppositeSide / totalWithLocation) * 100) : 0;
  
  // Batting average on balls in play
  const babip = hits.length > 0 ? (hits.length / hitData.length * 100).toFixed(1) : 0;
  
  // Create enhanced spray chart modal
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-title">ðŸ“ Spray Chart - ${teamName}</div>
        
        <!-- Stats Dashboard -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 20px; background: #1e293b; padding: 16px; border-radius: 8px;">
          <div style="text-align: center; padding: 12px; background: #0f172a; border-radius: 6px;">
            <div style="color: #94a3b8; font-size: 11px; text-transform: uppercase;">Total</div>
            <div style="color: #f1f5f9; font-size: 24px; font-weight: 700;">${hitData.length}</div>
          </div>
          <div style="text-align: center; padding: 12px; background: #0f172a; border-radius: 6px;">
            <div style="color: #94a3b8; font-size: 11px; text-transform: uppercase;">Hits</div>
            <div style="color: #22c55e; font-size: 24px; font-weight: 700;">${hits.length}</div>
          </div>
          <div style="text-align: center; padding: 12px; background: #0f172a; border-radius: 6px;">
            <div style="color: #94a3b8; font-size: 11px; text-transform: uppercase;">Outs</div>
            <div style="color: #ef4444; font-size: 24px; font-weight: 700;">${outs.length}</div>
          </div>
          <div style="text-align: center; padding: 12px; background: #0f172a; border-radius: 6px;">
            <div style="color: #94a3b8; font-size: 11px; text-transform: uppercase;">BABIP</div>
            <div style="color: #f59e0b; font-size: 24px; font-weight: 700;">.${babip.replace('.', '')}</div>
          </div>
        </div>
        
        <!-- Heat Map Toggle -->
        <div style="text-align: center; margin: 20px;">
          <button id="heat-map-toggle" onclick="toggleHeatMap()" style="background: linear-gradient(135deg, #ef4444, #f97316); color: white; border: none; border-radius: 8px; padding: 10px 20px; cursor: pointer; font-weight: 700; font-size: 13px; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); transition: all 0.2s;">
            ðŸ”¥ Heat Map: <span id="heat-map-status">ON</span>
          </button>
          <div style="color: #94a3b8; font-size: 11px; margin-top: 6px;">Toggle heat map overlay to see hit density zones</div>
        </div>
        
        <!-- Field Zones -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px; background: #1e293b; padding: 16px; border-radius: 8px;">
          <div style="text-align: center; padding: 12px; background: #0f172a; border-radius: 6px; border-left: 4px solid #3b82f6;">
            <div style="color: #94a3b8; font-size: 11px; text-transform: uppercase;">Pull Side (LF/3B/SS)</div>
            <div style="color: #3b82f6; font-size: 20px; font-weight: 700;">${pullSide} (${pullPct}%)</div>
          </div>
          <div style="text-align: center; padding: 12px; background: #0f172a; border-radius: 6px; border-left: 4px solid #22c55e;">
            <div style="color: #94a3b8; font-size: 11px; text-transform: uppercase;">Center (CF/2B/P)</div>
            <div style="color: #22c55e; font-size: 20px; font-weight: 700;">${centerField} (${centerPct}%)</div>
          </div>
          <div style="text-align: center; padding: 12px; background: #0f172a; border-radius: 6px; border-left: 4px solid #f59e0b;">
            <div style="color: #94a3b8; font-size: 11px; text-transform: uppercase;">Opposite (RF/1B/C)</div>
            <div style="color: #f59e0b; font-size: 20px; font-weight: 700;">${oppositeSide} (${oppPct}%)</div>
          </div>
        </div>
        
        <!-- Hit Type Breakdown -->
        <div style="margin: 20px; background: #1e293b; padding: 16px; border-radius: 8px;">
          <div style="color: #f1f5f9; font-size: 13px; font-weight: 700; margin-bottom: 12px;">Hit Breakdown:</div>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="width: 16px; height: 16px; background: #22c55e; border-radius: 50%;"></div>
              <span style="color: #cbd5e1; font-size: 13px;">1B: ${singles}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="width: 16px; height: 16px; background: #3b82f6; border-radius: 50%;"></div>
              <span style="color: #cbd5e1; font-size: 13px;">2B: ${doubles}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="width: 16px; height: 16px; background: #a855f7; border-radius: 50%;"></div>
              <span style="color: #cbd5e1; font-size: 13px;">3B: ${triples}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="width: 16px; height: 16px; background: #f59e0b; border-radius: 50%;"></div>
              <span style="color: #cbd5e1; font-size: 13px;">HR: ${homers}</span>
            </div>
          </div>
        </div>
        
        <!-- Baseball Field Canvas -->
        <div style="position: relative; width: 700px; height: 700px; margin: 20px auto; background: #1a3a1a; border-radius: 12px; border: 3px solid #4ade80; overflow: hidden;">
          <canvas id="spray-chart-canvas" width="700" height="700" style="display: block;"></canvas>
        </div>
        
        <!-- Legend -->
        <div style="margin: 20px; background: #1e293b; padding: 16px; border-radius: 8px;">
          <div style="color: #f1f5f9; font-size: 13px; font-weight: 700; margin-bottom: 12px;">Legend:</div>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
            <div>
              <div style="color: #94a3b8; font-size: 12px; font-weight: 600; margin-bottom: 6px;">Hit Types:</div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <div style="width: 12px; height: 12px; background: #22c55e; border-radius: 50%;"></div>
                <span style="color: #cbd5e1; font-size: 12px;">Single (1B)</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <div style="width: 14px; height: 14px; background: #3b82f6; border-radius: 50%;"></div>
                <span style="color: #cbd5e1; font-size: 12px;">Double (2B)</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <div style="width: 16px; height: 16px; background: #a855f7; border-radius: 50%;"></div>
                <span style="color: #cbd5e1; font-size: 12px;">Triple (3B)</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 18px; height: 18px; background: #f59e0b; border-radius: 50%;"></div>
                <span style="color: #cbd5e1; font-size: 12px;">Home Run (HR)</span>
              </div>
            </div>
            <div>
              <div style="color: #94a3b8; font-size: 12px; font-weight: 600; margin-bottom: 6px;">Outs:</div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 50%;"></div>
                <span style="color: #cbd5e1; font-size: 12px;">All outs marked in red</span>
              </div>
              <div style="margin-top: 12px;">
                <div style="color: #94a3b8; font-size: 11px; font-style: italic;">
                  ðŸ’¡ Larger dots = Extra base hits<br/>
                  ðŸ’¡ BABIP = Batting Avg on Balls in Play
                </div>
              </div>
            </div>
            <div>
              <div style="color: #94a3b8; font-size: 12px; font-weight: 600; margin-bottom: 6px;">Heat Map ðŸ”¥:</div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <div style="width: 20px; height: 12px; background: linear-gradient(90deg, #ef4444, rgba(239, 68, 68, 0)); border-radius: 3px;"></div>
                <span style="color: #cbd5e1; font-size: 12px;">Hot Zone (Many Hits)</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <div style="width: 20px; height: 12px; background: linear-gradient(90deg, #f97316, rgba(249, 115, 22, 0)); border-radius: 3px;"></div>
                <span style="color: #cbd5e1; font-size: 12px;">Warm Zone</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 20px; height: 12px; background: linear-gradient(90deg, #eab308, rgba(234, 179, 8, 0)); border-radius: 3px;"></div>
                <span style="color: #cbd5e1; font-size: 12px;">Cool Zone</span>
              </div>
              <div style="margin-top: 8px;">
                <div style="color: #94a3b8; font-size: 11px; font-style: italic;">
                  ðŸ”¥ Red glow = Shift defense here!
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <button class="modal-btn ok" onclick="closeModal()">Close</button>
      </div>
    </div>`;
  
  // Draw spray chart
  setTimeout(() => {
    const canvas = document.getElementById('spray-chart-canvas');
    if (canvas) {
      // Store hitData globally for redraw
      window.currentSprayData = hitData;
      window.showHeatMap = true; // Default to showing heat map
      drawSprayChartEnhanced(canvas, hitData);
    }
  }, 10);
}

// Toggle heat map display
function toggleHeatMap() {
  window.showHeatMap = !window.showHeatMap;
  const statusEl = document.getElementById('heat-map-status');
  const buttonEl = document.getElementById('heat-map-toggle');
  
  if (window.showHeatMap) {
    statusEl.textContent = 'ON';
    buttonEl.style.background = 'linear-gradient(135deg, #ef4444, #f97316)';
  } else {
    statusEl.textContent = 'OFF';
    buttonEl.style.background = '#334155';
  }
  
  // Redraw spray chart
  const canvas = document.getElementById('spray-chart-canvas');
  if (canvas && window.currentSprayData) {
    drawSprayChartEnhanced(canvas, window.currentSprayData);
  }
}

function drawSprayChart(canvas, hitData) {
  const ctx = canvas.getContext('2d');
  const width = canvas.width;
  const height = canvas.height;
  
  // Scale factor (field canvas is 350x350, spray chart is 700x700 = 2x)
  const scale = 2;
  
  // Draw field background (same as clickable field, but scaled up)
  ctx.fillStyle = '#1e4620';
  ctx.beginPath();
  ctx.arc(175 * scale, 310 * scale, 170 * scale, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.fillStyle = '#8b7355';
  ctx.beginPath();
  ctx.moveTo(175 * scale, 310 * scale);
  ctx.lineTo(280 * scale, 205 * scale);
  ctx.lineTo(175 * scale, 100 * scale);
  ctx.lineTo(70 * scale, 205 * scale);
  ctx.closePath();
  ctx.fill();
  
  ctx.fillStyle = '#2d5016';
  ctx.beginPath();
  ctx.arc(175 * scale, 310 * scale, 140 * scale, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.fillStyle = '#8b7355';
  ctx.beginPath();
  ctx.moveTo(175 * scale, 310 * scale);
  ctx.lineTo(265 * scale, 220 * scale);
  ctx.lineTo(175 * scale, 130 * scale);
  ctx.lineTo(85 * scale, 220 * scale);
  ctx.closePath();
  ctx.fill();
  
  // Draw foul lines
  ctx.strokeStyle = 'rgba(241, 245, 249, 0.4)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(175 * scale, 310 * scale);
  ctx.lineTo(10 * scale, 10 * scale);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(175 * scale, 310 * scale);
  ctx.lineTo(340 * scale, 10 * scale);
  ctx.stroke();
  
  // Draw bases
  const baseSize = 12;
  ctx.fillStyle = '#f1f5f9';
  ctx.fillRect(175 * scale - baseSize/2, 310 * scale - baseSize/2, baseSize, baseSize);
  ctx.fillRect(280 * scale - baseSize/2, 205 * scale - baseSize/2, baseSize, baseSize);
  ctx.fillRect(175 * scale - baseSize/2, 100 * scale - baseSize/2, baseSize, baseSize);
  ctx.fillRect(70 * scale - baseSize/2, 205 * scale - baseSize/2, baseSize, baseSize);
  
  // Draw position labels
  ctx.fillStyle = '#f1f5f9';
  ctx.font = 'bold 18px monospace';
  ctx.textAlign = 'center';
  ctx.fillText('LF', 60 * scale, 70 * scale);
  ctx.fillText('CF', 175 * scale, 40 * scale);
  ctx.fillText('RF', 290 * scale, 70 * scale);
  ctx.font = 'bold 16px monospace';
  ctx.fillText('SS', 120 * scale, 180 * scale);
  ctx.fillText('2B', 175 * scale, 150 * scale);
  ctx.fillText('1B', 230 * scale, 180 * scale);
  ctx.fillText('3B', 120 * scale, 240 * scale);
  ctx.fillText('P', 175 * scale, 210 * scale);
  ctx.fillText('C', 175 * scale, 280 * scale);
  
  // Draw hit/out markers
  hitData.forEach(hit => {
    if (hit.location && hit.location.includes(',')) {
      const coords = hit.location.split(',');
      const x = parseInt(coords[0]) * scale;
      const y = parseInt(coords[1]) * scale;
      
      if (hit.type === 'hit') {
        // Green circle for hits
        ctx.fillStyle = '#22c55e';
        ctx.beginPath();
        ctx.arc(x, y, 10, 0, Math.PI * 2);
        ctx.fill();
        
        // Dark green outline
        ctx.strokeStyle = '#16a34a';
        ctx.lineWidth = 2;
        ctx.stroke();
      } else {
        // Red circle for outs
        ctx.fillStyle = '#ef4444';
        ctx.beginPath();
        ctx.arc(x, y, 10, 0, Math.PI * 2);
        ctx.fill();
        
        // Dark red outline
        ctx.strokeStyle = '#dc2626';
        ctx.lineWidth = 2;
        ctx.stroke();
      }
    }
  });
}

function drawSprayChartEnhanced(canvas, hitData) {
  const ctx = canvas.getContext('2d');
  const width = canvas.width;
  const height = canvas.height;
  
  // Scale factor
  const scale = 2;
  
  // Draw field background
  ctx.fillStyle = '#1e4620';
  ctx.beginPath();
  ctx.arc(175 * scale, 310 * scale, 170 * scale, 0, Math.PI * 2);
  ctx.fill();
  
  // Draw infield diamond
  ctx.fillStyle = '#8b7355';
  ctx.beginPath();
  ctx.moveTo(175 * scale, 310 * scale);
  ctx.lineTo(280 * scale, 205 * scale);
  ctx.lineTo(175 * scale, 100 * scale);
  ctx.lineTo(70 * scale, 205 * scale);
  ctx.closePath();
  ctx.fill();
  
  // Draw grass
  ctx.fillStyle = '#2d5016';
  ctx.beginPath();
  ctx.arc(175 * scale, 310 * scale, 140 * scale, 0, Math.PI * 2);
  ctx.fill();
  
  // Draw foul lines
  ctx.strokeStyle = '#ffffff';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(175 * scale, 310 * scale);
  ctx.lineTo(70 * scale, 205 * scale);
  ctx.lineTo(10 * scale, 145 * scale);
  ctx.stroke();
  
  ctx.beginPath();
  ctx.moveTo(175 * scale, 310 * scale);
  ctx.lineTo(280 * scale, 205 * scale);
  ctx.lineTo(340 * scale, 145 * scale);
  ctx.stroke();
  
  // Draw zone boundaries (semi-transparent)
  ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
  ctx.lineWidth = 2;
  ctx.setLineDash([5, 5]);
  
  // Pull/Center boundary
  ctx.beginPath();
  ctx.moveTo(175 * scale, 310 * scale);
  ctx.lineTo(115 * scale, 50 * scale);
  ctx.stroke();
  
  // Center/Opposite boundary
  ctx.beginPath();
  ctx.moveTo(175 * scale, 310 * scale);
  ctx.lineTo(235 * scale, 50 * scale);
  ctx.stroke();
  
  ctx.setLineDash([]);
  
  // ===== PHASE 3: HEAT MAP OVERLAY =====
  // Create heat map based on hit density (only if enabled)
  if (hitData.length > 0 && window.showHeatMap !== false) {
    const heatMapRadius = 60; // Radius of influence for each hit
    const gridSize = 20; // Grid cell size for heat calculation
    
    // Create heat grid
    const heatGrid = [];
    for (let y = 0; y < height; y += gridSize) {
      for (let x = 0; x < width; x += gridSize) {
        let heat = 0;
        
        // Calculate heat from all hits
        hitData.forEach(hit => {
          if (hit.location && hit.location.includes(',')) {
            const coords = hit.location.split(',');
            const hitX = parseFloat(coords[0]) * scale;
            const hitY = parseFloat(coords[1]) * scale;
            
            if (!isNaN(hitX) && !isNaN(hitY) && hit.type === 'hit') {
              // Distance from this grid cell to the hit
              const distance = Math.sqrt(Math.pow(x - hitX, 2) + Math.pow(y - hitY, 2));
              
              // Add heat based on proximity (closer = hotter)
              if (distance < heatMapRadius) {
                heat += (1 - distance / heatMapRadius) * 0.3; // Max opacity 0.3
              }
            }
          }
        });
        
        // Draw heat if significant
        if (heat > 0.05) {
          const gradient = ctx.createRadialGradient(x, y, 0, x, y, gridSize);
          
          // Color based on heat intensity
          if (heat > 0.2) {
            // HOT zone - Red
            gradient.addColorStop(0, `rgba(239, 68, 68, ${heat})`);
            gradient.addColorStop(1, 'rgba(239, 68, 68, 0)');
          } else if (heat > 0.1) {
            // WARM zone - Orange
            gradient.addColorStop(0, `rgba(249, 115, 22, ${heat})`);
            gradient.addColorStop(1, 'rgba(249, 115, 22, 0)');
          } else {
            // COOL zone - Yellow
            gradient.addColorStop(0, `rgba(234, 179, 8, ${heat})`);
            gradient.addColorStop(1, 'rgba(234, 179, 8, 0)');
          }
          
          ctx.fillStyle = gradient;
          ctx.fillRect(x - gridSize/2, y - gridSize/2, gridSize * 2, gridSize * 2);
        }
      }
    }
  }
  // ===== END PHASE 3 =====
  
  // Draw bases
  const baseSize = 14 * scale;
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(175 * scale - baseSize/2, 310 * scale - baseSize/2, baseSize, baseSize);
  ctx.fillRect(280 * scale - baseSize/2, 205 * scale - baseSize/2, baseSize, baseSize);
  ctx.fillRect(175 * scale - baseSize/2, 100 * scale - baseSize/2, baseSize, baseSize);
  ctx.fillRect(70 * scale - baseSize/2, 205 * scale - baseSize/2, baseSize, baseSize);
  
  // Draw position labels with background
  const drawLabel = (text, x, y, bg = false) => {
    if (bg) {
      ctx.fillStyle = 'rgba(15, 23, 42, 0.8)';
      const metrics = ctx.measureText(text);
      ctx.fillRect(x - metrics.width/2 - 4, y - 14, metrics.width + 8, 20);
    }
    ctx.fillStyle = '#f1f5f9';
    ctx.fillText(text, x, y);
  };
  
  ctx.font = 'bold 18px monospace';
  ctx.textAlign = 'center';
  drawLabel('LF', 60 * scale, 70 * scale, true);
  drawLabel('CF', 175 * scale, 40 * scale, true);
  drawLabel('RF', 290 * scale, 70 * scale, true);
  
  ctx.font = 'bold 16px monospace';
  drawLabel('SS', 120 * scale, 180 * scale, true);
  drawLabel('2B', 175 * scale, 150 * scale, true);
  drawLabel('1B', 230 * scale, 180 * scale, true);
  drawLabel('3B', 120 * scale, 240 * scale, true);
  drawLabel('P', 175 * scale, 210 * scale, true);
  drawLabel('C', 175 * scale, 280 * scale, true);
  
  // Draw hit/out markers with color coding
  hitData.forEach(hit => {
    if (hit.location && hit.location.includes(',')) {
      const coords = hit.location.split(',');
      const x = parseFloat(coords[0]) * scale;  // FIXED: Apply scale factor
      const y = parseFloat(coords[1]) * scale;  // FIXED: Apply scale factor
      
      if (!isNaN(x) && !isNaN(y)) {
        let radius, fillColor, strokeColor;
        
        if (hit.type === 'hit') {
          // Color code by hit type
          switch(hit.result) {
            case '1B':
              radius = 6;
              fillColor = '#22c55e';
              strokeColor = '#16a34a';
              break;
            case '2B':
              radius = 8;
              fillColor = '#3b82f6';
              strokeColor = '#1d4ed8';
              break;
            case '3B':
              radius = 10;
              fillColor = '#a855f7';
              strokeColor = '#7c3aed';
              break;
            case 'HR':
              radius = 12;
              fillColor = '#f59e0b';
              strokeColor = '#d97706';
              break;
            default:
              radius = 6;
              fillColor = '#22c55e';
              strokeColor = '#16a34a';
          }
        } else {
          // Outs in red
          radius = 6;
          fillColor = '#ef4444';
          strokeColor = '#dc2626';
        }
        
        // Draw circle
        ctx.fillStyle = fillColor;
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        ctx.fill();
        
        // Outline - use white for opponent team to distinguish
        if (hit.team === 'opponent') {
          ctx.strokeStyle = '#ffffff';
          ctx.lineWidth = 3;
          ctx.stroke();
          // Then add the normal color outline inside
          ctx.strokeStyle = strokeColor;
          ctx.lineWidth = 1;
          ctx.stroke();
        } else {
          ctx.strokeStyle = strokeColor;
          ctx.lineWidth = 2;
          ctx.stroke();
        }
        
        // Add glow effect for home runs
        if (hit.result === 'HR') {
          ctx.strokeStyle = 'rgba(245, 158, 11, 0.3)';
          ctx.lineWidth = 4;
          ctx.stroke();
        }
      }
    }
  });
}

function drawSprayChartForPDF(canvas, hitData) {
  const ctx = canvas.getContext('2d');
  const width = canvas.width;
  const height = canvas.height;
  
  // Scale factor (field canvas is 350x350, spray chart is 700x700 = 2x)
  const scale = 2;
  
  // Draw field background
  ctx.fillStyle = '#1e4620';
  ctx.beginPath();
  ctx.arc(175 * scale, 310 * scale, 170 * scale, 0, Math.PI * 2);
  ctx.fill();
  
  // Draw infield diamond
  ctx.fillStyle = '#8b7355';
  ctx.beginPath();
  ctx.moveTo(175 * scale, 310 * scale);
  ctx.lineTo(280 * scale, 205 * scale);
  ctx.lineTo(175 * scale, 100 * scale);
  ctx.lineTo(70 * scale, 205 * scale);
  ctx.closePath();
  ctx.fill();
  
  // Draw grass
  ctx.fillStyle = '#2d5016';
  ctx.beginPath();
  ctx.arc(175 * scale, 310 * scale, 140 * scale, 0, Math.PI * 2);
  ctx.fill();
  
  // Draw foul lines
  ctx.strokeStyle = '#ffffff';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(175 * scale, 310 * scale);
  ctx.lineTo(70 * scale, 205 * scale);
  ctx.lineTo(10 * scale, 145 * scale);
  ctx.stroke();
  
  ctx.beginPath();
  ctx.moveTo(175 * scale, 310 * scale);
  ctx.lineTo(280 * scale, 205 * scale);
  ctx.lineTo(340 * scale, 145 * scale);
  ctx.stroke();
  
  // Draw bases
  const baseSize = 14 * scale;
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(175 * scale - baseSize/2, 310 * scale - baseSize/2, baseSize, baseSize); // Home
  ctx.fillRect(280 * scale - baseSize/2, 205 * scale - baseSize/2, baseSize, baseSize); // 1st
  ctx.fillRect(175 * scale - baseSize/2, 100 * scale - baseSize/2, baseSize, baseSize); // 2nd
  ctx.fillRect(70 * scale - baseSize/2, 205 * scale - baseSize/2, baseSize, baseSize); // 3rd
  
  // Draw position labels with dark backgrounds for PDF visibility
  const drawLabel = (text, x, y, fontSize) => {
    ctx.font = `bold ${fontSize}px monospace`;
    ctx.textAlign = 'center';
    
    // Measure text
    const metrics = ctx.measureText(text);
    const padding = 4;
    const bgWidth = metrics.width + (padding * 2);
    const bgHeight = fontSize + (padding * 2);
    
    // Draw dark background
    ctx.fillStyle = 'rgba(15, 23, 42, 0.85)';
    ctx.fillRect(x - bgWidth/2, y - fontSize + 2, bgWidth, bgHeight);
    
    // Draw white text on top
    ctx.fillStyle = '#ffffff';
    ctx.fillText(text, x, y + padding);
  };
  
  // Outfield positions
  drawLabel('LF', 60 * scale, 70 * scale, 18);
  drawLabel('CF', 175 * scale, 40 * scale, 18);
  drawLabel('RF', 290 * scale, 70 * scale, 18);
  
  // Infield positions
  drawLabel('SS', 120 * scale, 180 * scale, 16);
  drawLabel('2B', 175 * scale, 150 * scale, 16);
  drawLabel('1B', 230 * scale, 180 * scale, 16);
  drawLabel('3B', 120 * scale, 240 * scale, 16);
  drawLabel('P', 175 * scale, 210 * scale, 16);
  drawLabel('C', 175 * scale, 280 * scale, 16);
  
  // Draw hit/out markers with color coding by hit type
  hitData.forEach(hit => {
    if (hit.location && hit.location.includes(',')) {
      const coords = hit.location.split(',');
      const x = parseFloat(coords[0]) * scale; // Scale coordinates
      const y = parseFloat(coords[1]) * scale;
      
      if (!isNaN(x) && !isNaN(y)) {
        let radius, fillColor, strokeColor;
        
        if (hit.type === 'hit') {
          // Color code by hit type (same as enhanced version)
          switch(hit.result) {
            case '1B':
              radius = 6;
              fillColor = '#22c55e';
              strokeColor = '#16a34a';
              break;
            case '2B':
              radius = 8;
              fillColor = '#3b82f6';
              strokeColor = '#1d4ed8';
              break;
            case '3B':
              radius = 10;
              fillColor = '#a855f7';
              strokeColor = '#7c3aed';
              break;
            case 'HR':
              radius = 12;
              fillColor = '#f59e0b';
              strokeColor = '#d97706';
              break;
            default:
              radius = 6;
              fillColor = '#22c55e';
              strokeColor = '#16a34a';
          }
          
          // Draw circle
          ctx.fillStyle = fillColor;
          ctx.beginPath();
          ctx.arc(x, y, radius, 0, Math.PI * 2);
          ctx.fill();
          
          // Outline
          ctx.strokeStyle = strokeColor;
          ctx.lineWidth = 2;
          ctx.stroke();
          
          // Add glow for home runs
          if (hit.result === 'HR') {
            ctx.strokeStyle = 'rgba(245, 158, 11, 0.4)';
            ctx.lineWidth = 4;
            ctx.stroke();
          }
        } else {
          // Red circle for outs
          radius = 6;
          fillColor = '#ef4444';
          strokeColor = '#dc2626';
          
          ctx.fillStyle = fillColor;
          ctx.beginPath();
          ctx.arc(x, y, radius, 0, Math.PI * 2);
          ctx.fill();
          
          ctx.strokeStyle = strokeColor;
          ctx.lineWidth = 2;
          ctx.stroke();
        }
      }
    }
  });
}

function exportSeasonExcel(seasonStats) {
  // Create workbook
  const wb = XLSX.utils.book_new();
  
  // Prepare player stats data
  const playerData = [];
  
  // Header row
  playerData.push([
    'Player', 'GP', 'AB', 'R', 'H', '2B', '3B', 'HR', 'RBI', 
    'BB', 'SAC', 'SO', 'E', 'AVG', 'OBP', 'SLG', 'XBH'
  ]);
  
  // Player rows
  Object.keys(seasonStats).sort().forEach(playerKey => {
    const p = seasonStats[playerKey];
    
    // Calculate averages
    const AVG = p.AB > 0 ? p.H / p.AB : 0;
    const OBP = (p.AB + p.BB + p.SAC) > 0 ? (p.H + p.BB) / (p.AB + p.BB + p.SAC) : 0;
    const totalBases = p.singles + (p.doubles * 2) + (p.triples * 3) + (p.HR * 4);
    const SLG = p.AB > 0 ? totalBases / p.AB : 0;
    const XBH = p.doubles + p.triples + p.HR;
    
    playerData.push([
      p.name,
      p.GP,
      p.AB,
      p.R,
      p.H,
      p.doubles,
      p.triples,
      p.HR,
      p.RBI,
      p.BB,
      p.SAC,
      p.SO,
      p.E,
      parseFloat(AVG.toFixed(3)),
      parseFloat(OBP.toFixed(3)),
      parseFloat(SLG.toFixed(3)),
      XBH
    ]);
  });
  
  const ws = XLSX.utils.aoa_to_sheet(playerData);
  XLSX.utils.book_append_sheet(wb, ws, "Season Stats");
  
  // Add summary sheet
  const summaryData = [];
  summaryData.push(['SEASON SUMMARY']);
  summaryData.push([]);
  
  // Get total games from first player (they all have same GP)
  const totalGames = Object.keys(seasonStats).length > 0 ? seasonStats[Object.keys(seasonStats)[0]].GP : 0;
  
  summaryData.push(['Total Games Tracked', totalGames]);
  summaryData.push(['Total Players', Object.keys(seasonStats).length]);
  summaryData.push([]);
  summaryData.push(['Team', state.myTeam || 'Backyard Baseball Club']);
  summaryData.push(['Last Updated', new Date().toLocaleString()]);
  
  const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
  XLSX.utils.book_append_sheet(wb, ws2, "Summary");
  
  // Generate filename - ALWAYS THE SAME
  const teamName = (state.myTeam || 'BBC').replace(/\s+/g, '_');
  const filename = `${teamName}_Season_Stats.xlsx`;
  
  // Download
  XLSX.writeFile(wb, filename);
  
  alert(`âœ… Season stats updated!\n\nTotal games: ${totalGames}\nTotal players: ${Object.keys(seasonStats).length}\n\nDownloaded as: ${filename}\n\nThis file will overwrite previous downloads.`);
}

function resetSeasonStats() {
  if (confirm('âš ï¸ WARNING: This will DELETE all season stats!\n\nAre you sure you want to reset? This cannot be undone.')) {
    if (confirm('Are you REALLY sure? All accumulated stats will be lost!')) {
      localStorage.removeItem("mls-season-stats");
      alert('âœ… Season stats have been reset.');
    }
  }
}

function viewSeasonStats() {
  // Just view/export current season stats without updating
  const seasonStats = getSeasonStats();
  
  if (Object.keys(seasonStats).length === 0) {
    alert('âš ï¸ No season stats found. Play a game and click "Update Season" first!');
    return;
  }
  
  exportSeasonExcel(seasonStats);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  // Ctrl+Z or Cmd+Z for Undo
  if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
    e.preventDefault(); // Prevent browser undo
    undo();
  }
});
</script>
</body>
</html>
